{
	"auto_complete":
	{
		"selected_items":
		[
			[
				"link",
				"link_videos_existing"
			],
			[
				"link_",
				"link_images_existing"
			]
		]
	},
	"buffers":
	[
		{
			"file": "drive_fetch_resilient.py",
			"settings":
			{
				"buffer_size": 5757,
				"encoding": "UTF-8",
				"line_ending": "Unix"
			},
			"undo_stack":
			[
				[
					1,
					1,
					"revert",
					null,
					"AgAAAAAAAAAAAAAAAAAAAAAAAACovgAAIyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIGRyaXZlX2ZldGNoX3Jlc2lsaWVudC5weSB2MS4xMCDigJQgMjAyNS0xMC0wMQojIC0gRml4OiBhY2N1cmF0ZSBwZXItbGluayBmaWxlIGNvdW50cyAoaGFuZGxlcyBEcml2ZSBzaG9ydGN1dHMgd2l0aG91dCBleHRyYSBBUEkgY2FsbHMpCiMgLSBBZGRzIHBlci1saW5rIGZpbGUgY291bnQgbG9ncyBkdXJpbmcgcHJlLXNjYW4KIyAtIExvZyBsYW5ndWFnZSBzd2l0Y2hlcyB2aWEgZ2xvYmFsIExBTkcgKCJlbiIgb3IgImlkIikKIyAtIEtlZXBzICJ0aHVtYm5haWwtZm9sZGVyIOKGkiBvcmlnaW5hbHMiIG1vZGUgdmlhIENPTlZFUlRfVEhVTUJTX0RJUgojIC0gV29ya3Mgd2l0aCBHVUkgYnkgdG9nZ2xpbmcgZ2xvYmFscyBiZWZvcmUgY2FsbGluZyBtYWluKCkKCmltcG9ydCBvcywgcmUsIGlvLCBzeXMsIHRpbWUsIHNpZ25hbCwgcmVxdWVzdHMsIGxvZ2dpbmcsIHBsYXRmb3JtCmZyb20gdXJsbGliLnBhcnNlIGltcG9ydCB1cmxwYXJzZSwgcGFyc2VfcXMKZnJvbSB0eXBpbmcgaW1wb3J0IEl0ZXJhdG9yLCBEaWN0LCBPcHRpb25hbCwgTGlzdApmcm9tIGRhdGFjbGFzc2VzIGltcG9ydCBkYXRhY2xhc3MsIGZpZWxkCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApmcm9tIGxvZ2dpbmcuaGFuZGxlcnMgaW1wb3J0IFJvdGF0aW5nRmlsZUhhbmRsZXIKZnJvbSBjb25jdXJyZW50LmZ1dHVyZXMgaW1wb3J0IFRocmVhZFBvb2xFeGVjdXRvciwgYXNfY29tcGxldGVkCmltcG9ydCB0aHJlYWRpbmcKCmZyb20gZ29vZ2xlLm9hdXRoMi5jcmVkZW50aWFscyBpbXBvcnQgQ3JlZGVudGlhbHMKZnJvbSBnb29nbGVfYXV0aF9vYXV0aGxpYi5mbG93IGltcG9ydCBJbnN0YWxsZWRBcHBGbG93CmZyb20gZ29vZ2xlYXBpY2xpZW50LmRpc2NvdmVyeSBpbXBvcnQgYnVpbGQKZnJvbSBnb29nbGVhcGljbGllbnQuaHR0cCBpbXBvcnQgTWVkaWFJb0Jhc2VEb3dubG9hZApmcm9tIGdvb2dsZS5hdXRoLnRyYW5zcG9ydC5yZXF1ZXN0cyBpbXBvcnQgQXV0aG9yaXplZFNlc3Npb24KZnJvbSBnb29nbGVhcGljbGllbnQuZXJyb3JzIGltcG9ydCBIdHRwRXJyb3IKCkFQUF9OQU1FID0gIk9udGFob29kRG93bmxvYWRlciIKCmRlZiBfZGVmYXVsdF9zdXBwb3J0X2RpcigpIC0+IFBhdGg6CiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAiRGFyd2luIjogICMgbWFjT1MKICAgICAgICByZXR1cm4gUGF0aC5ob21lKCkgLyAiTGlicmFyeSIgLyAiQXBwbGljYXRpb24gU3VwcG9ydCIgLyBBUFBfTkFNRQogICAgaWYgcGxhdGZvcm0uc3lzdGVtKCkgPT0gIldpbmRvd3MiOgogICAgICAgIGJhc2UgPSBQYXRoKG9zLmVudmlyb24uZ2V0KCJBUFBEQVRBIiwgUGF0aC5ob21lKCkgLyAiQXBwRGF0YSIgLyAiUm9hbWluZyIpKQogICAgICAgIHJldHVybiBiYXNlIC8gQVBQX05BTUUKICAgICMgTGludXggYW5kIG90aGVycwogICAgcmV0dXJuIFBhdGgob3MuZW52aXJvbi5nZXQoIlhER19DT05GSUdfSE9NRSIsIFBhdGguaG9tZSgpIC8gIi5jb25maWciKSkgLyBBUFBfTkFNRQoKU1VQUE9SVF9ESVIgPSBfZGVmYXVsdF9zdXBwb3J0X2RpcigpClNVUFBPUlRfRElSLm1rZGlyKHBhcmVudHM9VHJ1ZSwgZXhpc3Rfb2s9VHJ1ZSkKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0gUnVudGltZSBvcHRpb25zIC0tLS0tLS0tLS0tLS0tLS0tLS0tCkNSRURFTlRJQUxTX0ZJTEUgPSBvcy5lbnZpcm9uLmdldCgiQ1JFREVOVElBTFNfRklMRSIsICJjcmVkZW50aWFscy5qc29uIikKVE9LRU5fRklMRSAgICAgICA9IG9zLmVudmlyb24uZ2V0KCJUT0tFTl9GSUxFIiwgc3RyKFNVUFBPUlRfRElSIC8gInRva2VuLmpzb24iKSkKT1VUUFVUX0RJUiAgICAgICA9IG9zLmVudmlyb24uZ2V0KCJPVVRQVVRfRElSIiwgIi4vb3V0cHV0IikKCklNQUdFX1dJRFRIICAgICAgICAgICAgICA9IDQwMApPVkVSV1JJVEUgICAgICAgICAgICAgICAgPSBGYWxzZQpST0JVU1RfUkVTVU1FICAgICAgICAgICAgPSBUcnVlCkRPV05MT0FEX1ZJREVPUyAgICAgICAgICA9IFRydWUKRE9XTkxPQURfSU1BR0VTX09SSUdJTkFMID0gRmFsc2UKQ09OVkVSVF9USFVNQlNfRElSICAgICAgID0gIiIgICAjIGlmIHNldCB0byBhIGxvY2FsIGZvbGRlciBwYXRoLCBjb252ZXJ0IG1hdGNoaW5nIHRodW1ibmFpbHMgdG8gb3JpZ2luYWxzCiMgRmxvdyBjb250cm9sIChHVUkgY2FuIHRvZ2dsZSB0aGVzZSkKUEFVU0UgPSBGYWxzZSAgIyB3aGVuIFRydWUsIGxvbmctcnVubmluZyBsb29wcyB3aWxsIHBhdXNlIHNhZmVseSB1bnRpbCByZXN1bWVkCgpMT0dfTEVWRUwgICAgICAgID0gIklORk8iCkxPR19GSUxFTkFNRSAgICAgPSAiZHJpdmVfZmV0Y2gubG9nIgpMT0dfTUFYX0JZVEVTICAgID0gMTAgKiAxMDI0ICogMTAyNApMT0dfQkFDS1VQUyAgICAgID0gMwpGT0xERVJfVVJMUzogTGlzdFtzdHJdID0gW10KCiMgTGluayBzdW1tYXJpZXMgYW5kIHJldHJ5IHN1cHBvcnQKTElOS19TVU1NQVJJRVM6IExpc3RbRGljdF0gPSBbXQpGQUlMRURfSVRFTVM6IExpc3RbRGljdF0gPSBbXQpESVJFQ1RfVEFTS1M6IE9wdGlvbmFsW0xpc3RbRGljdF1dID0gTm9uZQoKIyBDb25jdXJyZW5jeQpDT05DVVJSRU5DWSA9IGludChvcy5lbnZpcm9uLmdldCgiQ09OQ1VSUkVOQ1kiLCAiMyIpKQoKIyBUaHJlYWQtc2FmZXR5IGZvciBzaGFyZWQgY291bnRlcnMvY29sbGVjdGlvbnMKX0xPQ0sgPSB0aHJlYWRpbmcuTG9jaygpCgojIExhbmd1YWdlIGZvciBsb2dzICgiZW4iIG9yICJpZCIpOyB0aGUgR1VJIHNob3VsZCBzZXQgdGhpcyBiZWZvcmUgY2FsbGluZyBtYWluKCkKTEFORyA9ICJlbiIKClNDT1BFUyA9IFsiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC9kcml2ZS5yZWFkb25seSJdCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIGkxOG4gaGVscGVycyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKZGVmIEwoZW46IHN0ciwgaWRfOiBzdHIpIC0+IHN0cjoKICAgICIiIlJldHVybiBFbmdsaXNoIG9yIEluZG9uZXNpYW4gc3RyaW5nIGJhc2VkIG9uIExBTkcuIiIiCiAgICByZXR1cm4gZW4gaWYgKExBTkcgb3IgImVuIikubG93ZXIoKS5zdGFydHN3aXRoKCJlbiIpIGVsc2UgaWRfCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIEFjY291bnRpbmcgLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkBkYXRhY2xhc3MKY2xhc3MgQ291bnRlcnM6CiAgICBzY2FubmVkOiBpbnQgPSAwCiAgICBpbWFnZXNfZG9uZTogaW50ID0gMAogICAgaW1hZ2VzX3NraXBwZWQ6IGludCA9IDAKICAgIGltYWdlc19mYWlsZWQ6IGludCA9IDAKICAgIHZpZGVvc19kb25lOiBpbnQgPSAwCiAgICB2aWRlb3Nfc2tpcHBlZDogaW50ID0gMAogICAgdmlkZW9zX2ZhaWxlZDogaW50ID0gMAogICAgZGF0YV9kb25lOiBpbnQgPSAwCiAgICBkYXRhX3NraXBwZWQ6IGludCA9IDAKICAgIGRhdGFfZmFpbGVkOiBpbnQgPSAwCiAgICBieXRlc193cml0dGVuOiBpbnQgPSAwCgpAZGF0YWNsYXNzCmNsYXNzIFRvdGFsczoKICAgIGdyYW5kOiBDb3VudGVycyA9IGZpZWxkKGRlZmF1bHRfZmFjdG9yeT1Db3VudGVycykKICAgIHBlcl9mb2xkZXI6IERpY3Rbc3RyLCBDb3VudGVyc10gPSBmaWVsZChkZWZhdWx0X2ZhY3Rvcnk9ZGljdCkKICAgIGRlZiBmb2xkZXIoc2VsZiwga2V5OiBzdHIpIC0+IENvdW50ZXJzOgogICAgICAgIGlmIGtleSBub3QgaW4gc2VsZi5wZXJfZm9sZGVyOgogICAgICAgICAgICBzZWxmLnBlcl9mb2xkZXJba2V5XSA9IENvdW50ZXJzKCkKICAgICAgICByZXR1cm4gc2VsZi5wZXJfZm9sZGVyW2tleV0KClRPVEFMUyA9IFRvdGFscygpClNUQVJUX1RTID0gdGltZS50aW1lKCkKSU5URVJSVVBURUQgPSBGYWxzZQpFWFBFQ1RFRF9JTUFHRVMgPSAwCkVYUEVDVEVEX1ZJREVPUyA9IDAKRVhQRUNURURfREFUQSA9IDAKQUxSRUFEWV9IQVZFX0lNQUdFUyA9IDAKQUxSRUFEWV9IQVZFX1ZJREVPUyA9IDAKQUxSRUFEWV9IQVZFX0RBVEEgPSAwCkVYUEVDVEVEX1RPVEFMX0JZVEVTID0gMAoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBMb2dnaW5nIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgpkZWYgcmVzZXRfY291bnRlcnMoKToKICAgIGdsb2JhbCBUT1RBTFMsIEVYUEVDVEVEX0lNQUdFUywgRVhQRUNURURfVklERU9TLCBFWFBFQ1RFRF9EQVRBLCBBTFJFQURZX0hBVkVfSU1BR0VTLCBBTFJFQURZX0hBVkVfVklERU9TLCBBTFJFQURZX0hBVkVfREFUQSwgU1RBUlRfVFMsIElOVEVSUlVQVEVELCBMSU5LX1NVTU1BUklFUywgRkFJTEVEX0lURU1TCiAgICBUT1RBTFMgPSBUb3RhbHMoKQogICAgRVhQRUNURURfSU1BR0VTID0gMAogICAgRVhQRUNURURfVklERU9TID0gMAogICAgRVhQRUNURURfREFUQSA9IDAKICAgIEFMUkVBRFlfSEFWRV9JTUFHRVMgPSAwCiAgICBBTFJFQURZX0hBVkVfVklERU9TID0gMAogICAgQUxSRUFEWV9IQVZFX0RBVEEgPSAwCiAgICBnbG9iYWwgRVhQRUNURURfVE9UQUxfQllURVMKICAgIEVYUEVDVEVEX1RPVEFMX0JZVEVTID0gMAogICAgU1RBUlRfVFMgPSB0aW1lLnRpbWUoKQogICAgSU5URVJSVVBURUQgPSBGYWxzZQogICAgTElOS19TVU1NQVJJRVMgPSBbXQogICAgRkFJTEVEX0lURU1TID0gW10KCiMgQ29sb3JGb3JtYXR0ZXIgYW5kIHNldHVwX2xvZ2dpbmcgZGVmaW5lZCBpbmxpbmUgdG8gYXZvaWQgY2lyY3VsYXIgaW1wb3J0cwoKY2xhc3MgQ29sb3JGb3JtYXR0ZXIobG9nZ2luZy5Gb3JtYXR0ZXIpOgogICAgUkVTRVQgPSAiXDAzM1swbSIKICAgIEdSRVkgPSAiXDAzM1s5MG0iCiAgICBMRVZFTF9DT0xPUlMgPSB7CiAgICAgICAgbG9nZ2luZy5ERUJVRzogIlwwMzNbOTZtIiwKICAgICAgICBsb2dnaW5nLklORk86ICJcMDMzWzkybSIsCiAgICAgICAgbG9nZ2luZy5XQVJOSU5HOiAiXDAzM1s5M20iLAogICAgICAgIGxvZ2dpbmcuRVJST1I6ICJcMDMzWzkxbSIsCiAgICAgICAgbG9nZ2luZy5DUklUSUNBTDogIlwwMzNbOTdtXDAzM1sxMDFtIiwKICAgIH0KICAgIEJPTERfT04gPSAiXDAzM1sxbSI7IEJPTERfT0ZGID0gIlwwMzNbMjJtIgoKICAgIGRlZiBmb3JtYXQoc2VsZiwgcmVjb3JkKToKICAgICAgICBiYXNlID0gc3VwZXIoKS5mb3JtYXQocmVjb3JkKQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHJlCiAgICAgICAgICAgIG0gPSByZS5tYXRjaChyIl4oXGR7NH0tXGR7Mn0tXGR7Mn0gXGR7Mn06XGR7Mn06XGR7Mn0pIFx8IChbQS1aXSspXHMrXHwgKC4qKSQiLCBiYXNlLCByZS5ET1RBTEwpCiAgICAgICAgICAgIGRlZiBlbXBoKGJvZHk6IHN0cikgLT4gc3RyOgogICAgICAgICAgICAgICAgcGF0dGVybiA9IHIiKFxbW15cXV0rXF0pfChcYig/OmltYWdlc3x2aWRlb3N8Z2FtYmFyfHZpZGVvKVxzXGQrL1xkK1xiKXwoXGIoPzpsZWZ0fHNpc2EpXHNcZCtcYil8KFxiW0EtWmEtel9dKz1cZCtcYikiCiAgICAgICAgICAgICAgICByZXR1cm4gcmUuc3ViKHBhdHRlcm4sIGxhbWJkYSBtdDogZiJ7c2VsZi5CT0xEX09OfXttdC5ncm91cCgwKX17c2VsZi5CT0xEX09GRn0iLCBib2R5KQogICAgICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgICAgIHJldHVybiBlbXBoKGJhc2UpICsgc2VsZi5SRVNFVAogICAgICAgICAgICB0cywgbGV2ZWwsIG1zZyA9IG0uZ3JvdXBzKCkKICAgICAgICAgICAgbHZsX2NvbG9yID0gc2VsZi5MRVZFTF9DT0xPUlMuZ2V0KHJlY29yZC5sZXZlbG5vLCAiIikKICAgICAgICAgICAgbXNnMiA9IGVtcGgobXNnKQogICAgICAgICAgICByZXR1cm4gZiJ7c2VsZi5HUkVZfXt0c317c2VsZi5SRVNFVH0gfCB7bHZsX2NvbG9yfXtsZXZlbH17c2VsZi5SRVNFVH0gfCB7bXNnMn17c2VsZi5SRVNFVH0iCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIGJhc2UKCmRlZiBzZXR1cF9sb2dnaW5nKCk6CiAgICBvcy5tYWtlZGlycyhPVVRQVVRfRElSLCBleGlzdF9vaz1UcnVlKQogICAgbG9nX3BhdGggPSBvcy5wYXRoLmpvaW4oT1VUUFVUX0RJUiwgTE9HX0ZJTEVOQU1FKQogICAgbGV2ZWwgPSBnZXRhdHRyKGxvZ2dpbmcsIExPR19MRVZFTC51cHBlcigpLCBsb2dnaW5nLklORk8pCiAgICBmbXQgPSAiJShhc2N0aW1lKXMgfCAlKGxldmVsbmFtZSktN3MgfCAlKG1lc3NhZ2UpcyI7IGRhdGVmbXQgPSAiJVktJW0tJWQgJUg6JU06JVMiCiAgICByb290ID0gbG9nZ2luZy5nZXRMb2dnZXIoKTsgcm9vdC5zZXRMZXZlbChsZXZlbCkKICAgIGlmIHJvb3QuaGFuZGxlcnM6CiAgICAgICAgcm9vdC5zZXRMZXZlbChsZXZlbCkKICAgICAgICByZXR1cm4KICAgIGNoID0gbG9nZ2luZy5TdHJlYW1IYW5kbGVyKHN5cy5zdGRvdXQpOyBjaC5zZXRMZXZlbChsZXZlbCk7IGNoLnNldEZvcm1hdHRlcihDb2xvckZvcm1hdHRlcihmbXQsIGRhdGVmbXQpKTsgcm9vdC5hZGRIYW5kbGVyKGNoKQogICAgZmggPSBSb3RhdGluZ0ZpbGVIYW5kbGVyKGxvZ19wYXRoLCBtYXhCeXRlcz1MT0dfTUFYX0JZVEVTLCBiYWNrdXBDb3VudD1MT0dfQkFDS1VQUywgZW5jb2Rpbmc9InV0Zi04IikKICAgIGZoLnNldExldmVsKGxldmVsKTsgZmguc2V0Rm9ybWF0dGVyKGxvZ2dpbmcuRm9ybWF0dGVyKGZtdCwgZGF0ZWZtdCkpOyByb290LmFkZEhhbmRsZXIoZmgpCgpmcm9tIGRmci51dGlscyBpbXBvcnQgaHVtYW5fYnl0ZXMsIGVsYXBzZWQKCmRlZiBvbl9zaWdpbnQoX3NpZywgX2ZyYW1lKToKICAgIGdsb2JhbCBJTlRFUlJVUFRFRDsgSU5URVJSVVBURUQgPSBUcnVlCiAgICBsb2dnaW5nLndhcm5pbmcoTCgKICAgICAgICAiUmVjZWl2ZWQgaW50ZXJydXB0IHNpZ25hbCDigJQgZmluaXNoaW5nIGN1cnJlbnQgc3RlcCBhbmQgc3VtbWFyaXppbmcuLi4iLAogICAgICAgICJNZW5lcmltYSBzaW55YWwgaW50ZXJ1cHNpIOKAlCBtZW55ZWxlc2Fpa2FuIGxhbmdrYWggc2FhdCBpbmkgbGFsdSBtZXJpbmdrYXMuLi4iCiAgICApKQoKc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHSU5ULCBvbl9zaWdpbnQpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIEF1dGggLyBTZXJ2aWNlIC0tLS0tLS0tLS0tLS0tLS0tLS0tCmZyb20gZGZyLmF1dGggaW1wb3J0IGdldF9zZXJ2aWNlX2FuZF9jcmVkcywgZ2V0X3NlcnZpY2VfaWZfdG9rZW5fdmFsaWQsIHRyeV9nZXRfYWNjb3VudF9pbmZvLCBnZXRfYWNjb3VudF9pbmZvCmRlZiBfcmVzb2x2ZV9jcmVkZW50aWFsc19wYXRoKHA6IHN0cikgLT4gc3RyOgogICAgcHRoID0gUGF0aChwKQogICAgaWYgcHRoLmlzX2ZpbGUoKToKICAgICAgICByZXR1cm4gc3RyKHB0aCkKICAgICMgVHJ5IHN1cHBvcnQgZGlyCiAgICBwdGgyID0gU1VQUE9SVF9ESVIgLyBQYXRoKHApLm5hbWUKICAgIGlmIHB0aDIuaXNfZmlsZSgpOgogICAgICAgIHJldHVybiBzdHIocHRoMikKICAgICMgVHJ5IGFsb25nc2lkZSBleGVjdXRhYmxlIC8gc2NyaXB0CiAgICB0cnk6CiAgICAgICAgYmFzZSA9IFBhdGgoZ2V0YXR0cihzeXMsICJfTUVJUEFTUyIsIFBhdGgoX19maWxlX18pLnJlc29sdmUoKS5wYXJlbnQpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBiYXNlID0gUGF0aChfX2ZpbGVfXykucmVzb2x2ZSgpLnBhcmVudAogICAgcHRoMyA9IGJhc2UgLyBQYXRoKHApLm5hbWUKICAgIGlmIHB0aDMuaXNfZmlsZSgpOgogICAgICAgIHJldHVybiBzdHIocHRoMykKICAgIHJhaXNlIEZpbGVOb3RGb3VuZEVycm9yKAogICAgICAgIGYiQ291bGQgbm90IGZpbmQge3Ahcn0uIExvb2tlZCBpbjoge1BhdGgocCkucmVzb2x2ZSgpfSwge3B0aDJ9LCB7cHRoM30iCiAgICApCgpkZWYgZ2V0X3NlcnZpY2VfYW5kX2NyZWRzKHRva2VuX3BhdGg6IHN0ciwgY3JlZGVudGlhbHNfcGF0aDogc3RyKToKICAgIGZyb20gZ29vZ2xlLmF1dGgudHJhbnNwb3J0LnJlcXVlc3RzIGltcG9ydCBSZXF1ZXN0CiAgICB0b2tlbl9wYXRoID0gc3RyKFBhdGgodG9rZW5fcGF0aCkpICAjIGVuc3VyZSBzdHJpbmcgcGF0aAogICAgY3JlZHMgPSBOb25lCgogICAgaWYgb3MucGF0aC5leGlzdHModG9rZW5fcGF0aCk6CiAgICAgICAgY3JlZHMgPSBDcmVkZW50aWFscy5mcm9tX2F1dGhvcml6ZWRfdXNlcl9maWxlKHRva2VuX3BhdGgsIFNDT1BFUykKCiAgICBpZiBub3QgY3JlZHMgb3Igbm90IGNyZWRzLnZhbGlkOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgY3JlZHMgYW5kIGNyZWRzLmV4cGlyZWQgYW5kIGNyZWRzLnJlZnJlc2hfdG9rZW46CiAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oTCgiUmVmcmVzaGluZyBzdG9yZWQgY3JlZGVudGlhbHMuLi4iLCAiTWVueWVnYXJrYW4ga3JlZGVuc2lhbCB0ZXJzaW1wYW4uLi4iKSkKICAgICAgICAgICAgICAgIGNyZWRzLnJlZnJlc2goUmVxdWVzdCgpKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgRXhjZXB0aW9uKCJOZWVkIGZyZXNoIGF1dGgiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKCJMYXVuY2hpbmcgYnJvd3NlciBmb3IgR29vZ2xlIE9BdXRoLi4uIiwgIk1lbWJ1a2EgYnJvd3NlciB1bnR1ayBPQXV0aCBHb29nbGUuLi4iKSkKICAgICAgICAgICAgY3JlZF9wYXRoX3Jlc29sdmVkID0gX3Jlc29sdmVfY3JlZGVudGlhbHNfcGF0aChjcmVkZW50aWFsc19wYXRoKQogICAgICAgICAgICBmbG93ID0gSW5zdGFsbGVkQXBwRmxvdy5mcm9tX2NsaWVudF9zZWNyZXRzX2ZpbGUoY3JlZF9wYXRoX3Jlc29sdmVkLCBTQ09QRVMpCiAgICAgICAgICAgIGNyZWRzID0gZmxvdy5ydW5fbG9jYWxfc2VydmVyKHBvcnQ9MCkKCiAgICAgICAgUGF0aCh0b2tlbl9wYXRoKS5wYXJlbnQubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQogICAgICAgIHdpdGggb3Blbih0b2tlbl9wYXRoLCAidyIpIGFzIGY6CiAgICAgICAgICAgIGYud3JpdGUoY3JlZHMudG9fanNvbigpKQogICAgICAgICAgICBsb2dnaW5nLmluZm8oTChmIldyb3RlIHRva2VuIGZpbGU6IHt0b2tlbl9wYXRofSIsIGYiTWVudWxpcyB0b2tlbiBmaWxlOiB7dG9rZW5fcGF0aH0iKSkKCiAgICBzZXJ2aWNlID0gYnVpbGQoImRyaXZlIiwgInYzIiwgY3JlZGVudGlhbHM9Y3JlZHMsIGNhY2hlX2Rpc2NvdmVyeT1GYWxzZSkKICAgIHJldHVybiBzZXJ2aWNlLCBjcmVkcwoKZGVmIGdldF9zZXJ2aWNlX2lmX3Rva2VuX3ZhbGlkKHRva2VuX3BhdGg6IHN0ciwgY3JlZGVudGlhbHNfcGF0aDogc3RyKToKICAgICIiIlJldHVybiAoc2VydmljZSwgY3JlZHMpIGlmIHRva2VuIGV4aXN0cyBhbmQgY2FuIGJlIHVzZWQvcmVmcmVzaGVkIFdJVEhPVVQgbGF1bmNoaW5nIE9BdXRoLgogICAgT3RoZXJ3aXNlIHJldHVybiAoTm9uZSwgTm9uZSkuCiAgICAiIiIKICAgIHRyeToKICAgICAgICBmcm9tIGdvb2dsZS5hdXRoLnRyYW5zcG9ydC5yZXF1ZXN0cyBpbXBvcnQgUmVxdWVzdAogICAgICAgIHRva2VuX3BhdGggPSBzdHIoUGF0aCh0b2tlbl9wYXRoKSkKICAgICAgICBjcmVkcyA9IE5vbmUKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0b2tlbl9wYXRoKToKICAgICAgICAgICAgY3JlZHMgPSBDcmVkZW50aWFscy5mcm9tX2F1dGhvcml6ZWRfdXNlcl9maWxlKHRva2VuX3BhdGgsIFNDT1BFUykKICAgICAgICBpZiBub3QgY3JlZHM6CiAgICAgICAgICAgIHJldHVybiBOb25lLCBOb25lCiAgICAgICAgaWYgbm90IGNyZWRzLnZhbGlkOgogICAgICAgICAgICBpZiBjcmVkcy5leHBpcmVkIGFuZCBjcmVkcy5yZWZyZXNoX3Rva2VuOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGNyZWRzLnJlZnJlc2goUmVxdWVzdCgpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZSwgTm9uZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUsIE5vbmUKICAgICAgICBzZXJ2aWNlID0gYnVpbGQoImRyaXZlIiwgInYzIiwgY3JlZGVudGlhbHM9Y3JlZHMsIGNhY2hlX2Rpc2NvdmVyeT1GYWxzZSkKICAgICAgICByZXR1cm4gc2VydmljZSwgY3JlZHMKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIE5vbmUsIE5vbmUKCmRlZiB0cnlfZ2V0X2FjY291bnRfaW5mbyh0b2tlbl9wYXRoOiBzdHIsIGNyZWRlbnRpYWxzX3BhdGg6IHN0cikgLT4gRGljdDoKICAgIHN2YywgXyA9IGdldF9zZXJ2aWNlX2lmX3Rva2VuX3ZhbGlkKHRva2VuX3BhdGgsIGNyZWRlbnRpYWxzX3BhdGgpCiAgICBpZiBzdmMgaXMgTm9uZToKICAgICAgICByZXR1cm4ge30KICAgIHJldHVybiBnZXRfYWNjb3VudF9pbmZvKHN2YykKCmRlZiBnZXRfYWNjb3VudF9pbmZvKHNlcnZpY2UpIC0+IERpY3Q6CiAgICB0cnk6CiAgICAgICAgYWJvdXQgPSBzZXJ2aWNlLmFib3V0KCkuZ2V0KGZpZWxkcz0idXNlcihlbWFpbEFkZHJlc3MsZGlzcGxheU5hbWUpIikuZXhlY3V0ZSgpCiAgICAgICAgdSA9IGFib3V0LmdldCgidXNlciIpIG9yIHt9CiAgICAgICAgcmV0dXJuIHsiZW1haWwiOiB1LmdldCgiZW1haWxBZGRyZXNzIiksICJuYW1lIjogdS5nZXQoImRpc3BsYXlOYW1lIil9CiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiB7fQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBIZWxwZXJzIC0tLS0tLS0tLS0tLS0tLS0tLS0tCmZyb20gZGZyLnV0aWxzIGltcG9ydCBleHRyYWN0X2ZvbGRlcl9pZCwgc2FmZV9maWxlbmFtZSwgZW5zdXJlX2RpciwgYmFja29mZl9zbGVlcCwgY2xhc3NpZnlfbWVkaWEKZnJvbSBkZnIubGlzdGluZyBpbXBvcnQgZ2FwaV9leGVjdXRlX3dpdGhfcmV0cnksIGdldF9pdGVtCgpkZWYgZXh0cmFjdF9mb2xkZXJfaWQodXJsOiBzdHIpIC0+IHN0cjoKICAgIG0gPSByZS5zZWFyY2gociIvZm9sZGVycy8oW2EtekEtWjAtOV8tXSspIiwgdXJsKQogICAgaWYgbTogcmV0dXJuIG0uZ3JvdXAoMSkKICAgIHFzID0gcGFyc2VfcXModXJscGFyc2UodXJsKS5xdWVyeSkKICAgIHJldHVybiAocXMuZ2V0KCJpZCIsIFsiIl0pWzBdKS5zdHJpcCgpCgpkZWYgc2FmZV9maWxlbmFtZShuYW1lOiBzdHIpIC0+IHN0cjoKICAgIHNyYyA9ICIiIGlmIG5hbWUgaXMgTm9uZSBlbHNlIHN0cihuYW1lKQogICAgZm9yIGNoIGluICcvXFw6Kj8iPD58Jzogc3JjID0gc3JjLnJlcGxhY2UoY2gsICJfIikKICAgIHJldHVybiBzcmMuc3RyaXAoKS5yc3RyaXAoIi4iKSBvciAidW50aXRsZWQiCgpkZWYgZW5zdXJlX2RpcihwYXRoOiBzdHIpOiBvcy5tYWtlZGlycyhwYXRoLCBleGlzdF9vaz1UcnVlKQoKZGVmIGJhY2tvZmZfc2xlZXAoYXR0ZW1wdDogaW50KToKICAgIGJhc2UgPSBtaW4oMzAsICgyICoqIChhdHRlbXB0IC0gMSkpICsgMC4xICogYXR0ZW1wdCkKICAgIGltcG9ydCByYW5kb20gYXMgX3IsIHRpbWUgYXMgX3QKICAgIGppdHRlciA9IGJhc2UgKiAoMC43NSArIDAuNSAqIF9yLnJhbmRvbSgpKQogICAgbG9nZ2luZy5kZWJ1ZyhMKAogICAgICAgIGYiQmFja2luZyBvZmYge2ppdHRlcjouMWZ9cywgYXR0ZW1wdCB7YXR0ZW1wdH0iLAogICAgICAgIGYiSmVkYSB7aml0dGVyOi4xZn0gZHRrIChwZXJjb2JhYW4ge2F0dGVtcHR9KSIKICAgICkpCiAgICBfdC5zbGVlcChqaXR0ZXIpCgpfSU1BR0VfRVhUUyA9IHsianBnIiwianBlZyIsInBuZyIsImdpZiIsIndlYnAiLCJ0aWYiLCJ0aWZmIiwiYm1wIiwiaGVpYyIsImhlaWYiLCJjcjIiLCJjcjMiLCJhcnciLCJuZWYiLCJkbmciLCJyYWYiLCJydzIifQpfVklERU9fRVhUUyA9IHsibXA0IiwibW92IiwibTR2IiwibWt2IiwiYXZpIiwid2VibSIsIm10cyIsIm0ydHMiLCIzZ3AiLCJtb2QiLCJ0b2QifQoKZGVmIF9leHRfZnJvbShuYW1lOiBzdHIsIGZpbGVfZXh0OiBPcHRpb25hbFtzdHJdKSAtPiBzdHI6CiAgICBpZiBmaWxlX2V4dDogcmV0dXJuIGZpbGVfZXh0Lmxvd2VyKCkKICAgIF8sIGV4dCA9IG9zLnBhdGguc3BsaXRleHQobmFtZSBvciAiIik7IHJldHVybiBleHQubHN0cmlwKCIuIikubG93ZXIoKQoKZGVmIGNsYXNzaWZ5X21lZGlhKG1pbWU6IHN0ciwgbmFtZTogc3RyLCBmaWxlX2V4dDogT3B0aW9uYWxbc3RyXSkgLT4gT3B0aW9uYWxbc3RyXToKICAgIGV4dCA9IF9leHRfZnJvbShuYW1lLCBmaWxlX2V4dCkKICAgIGlmIChtaW1lIG9yICIiKS5zdGFydHN3aXRoKCJpbWFnZS8iKSBvciBleHQgaW4gX0lNQUdFX0VYVFM6IHJldHVybiAiaW1hZ2UiCiAgICBpZiAobWltZSBvciAiIikuc3RhcnRzd2l0aCgidmlkZW8vIikgb3IgZXh0IGluIF9WSURFT19FWFRTOiByZXR1cm4gInZpZGVvIgogICAgIyBDbGFzc2lmeSBhcyAiZGF0YSIgZm9yIGRvY3VtZW50cyBhbmQgb3RoZXIgZmlsZXMgKFBERnMsIGRvY3MsIHNwcmVhZHNoZWV0cywgZXRjLikKICAgICMgVGhpcyBnaXZlcyB1c2VycyB2aXNpYmlsaXR5IGludG8gbm9uLW1lZGlhIGZpbGUgZG93bmxvYWRzCiAgICBtaW1lX2xvd2VyID0gKG1pbWUgb3IgIiIpLmxvd2VyKCkKICAgIGlmIChtaW1lX2xvd2VyLnN0YXJ0c3dpdGgoImFwcGxpY2F0aW9uLyIpIG9yIAogICAgICAgIG1pbWVfbG93ZXIuc3RhcnRzd2l0aCgidGV4dC8iKSBvciAKICAgICAgICBleHQgaW4geyJwZGYiLCAiZG9jIiwgImRvY3giLCAieGxzIiwgInhsc3giLCAicHB0IiwgInBwdHgiLCAidHh0IiwgImNzdiIsICJ6aXAiLCAicmFyIiwgIjd6In0pOgogICAgICAgIHJldHVybiAiZGF0YSIKICAgIHJldHVybiBOb25lCgpkZWYgZ2FwaV9leGVjdXRlX3dpdGhfcmV0cnkocmVxLCByZXRyaWVzOiBpbnQgPSA4KToKICAgIGxhc3RfZXhjID0gTm9uZQogICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMSwgcmV0cmllcyArIDEpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHJlcS5leGVjdXRlKCkKICAgICAgICBleGNlcHQgSHR0cEVycm9yIGFzIGU6CiAgICAgICAgICAgIGNvZGUgPSBnZXRhdHRyKGdldGF0dHIoZSwgInJlc3AiLCBOb25lKSwgInN0YXR1cyIsIE5vbmUpCiAgICAgICAgICAgIGlmIGNvZGUgaW4gKDQyOSwgNTAwLCA1MDIsIDUwMywgNTA0KToKICAgICAgICAgICAgICAgIGxhc3RfZXhjID0gZTsgYmFja29mZl9zbGVlcChhdHRlbXB0KTsgY29udGludWUKICAgICAgICAgICAgcmFpc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxhc3RfZXhjID0gZTsgYmFja29mZl9zbGVlcChhdHRlbXB0KQogICAgcmFpc2UgUnVudGltZUVycm9yKGYiR29vZ2xlIEFQSSByZXF1ZXN0IGZhaWxlZCBhZnRlciByZXRyaWVzOiB7bGFzdF9leGN9IikKCmRlZiBnZXRfaXRlbShzZXJ2aWNlLCBmaWxlX2lkOiBzdHIsIGZpZWxkczogc3RyKSAtPiBEaWN0OgogICAgcmVxID0gc2VydmljZS5maWxlcygpLmdldChmaWxlSWQ9ZmlsZV9pZCwgZmllbGRzPWZpZWxkcywgc3VwcG9ydHNBbGxEcml2ZXM9VHJ1ZSkKICAgIHJldHVybiBnYXBpX2V4ZWN1dGVfd2l0aF9yZXRyeShyZXEpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIExpc3RpbmcgLS0tLS0tLS0tLS0tLS0tLS0tLS0KZnJvbSBkZnIubGlzdGluZyBpbXBvcnQgcmVzb2x2ZV9mb2xkZXIsIHdhaXRfaWZfcGF1c2VkLCBsaXN0X2ZvbGRlcl9yZWN1cnNpdmUKCmRlZiByZXNvbHZlX2ZvbGRlcihzZXJ2aWNlLCB1cmw6IHN0cik6CiAgICBmb2xkZXJfaWQgPSBleHRyYWN0X2ZvbGRlcl9pZCh1cmwpCiAgICBpZiBub3QgZm9sZGVyX2lkOgogICAgICAgIGxvZ2dpbmcuZXJyb3IoTChmIkZvbGRlciBVUkwgaGFkIG5vIElEOiAne3VybH0nIiwgZiJVUkwgZm9sZGVyIHRpZGFrIG1lbWlsaWtpIElEOiAne3VybH0nIikpCiAgICAgICAgIyBBZGQgc3RhY2sgdHJhY2UgdG8gaGVscCBkZWJ1ZyBjYWxsIGZsb3cgZm9yIHRoaXMgbG9naWNhbCBlcnJvcgogICAgICAgIGltcG9ydCB0cmFjZWJhY2sKICAgICAgICBsb2dnaW5nLmRlYnVnKCJDYWxsIHN0YWNrIGZvciBVUkwgdmFsaWRhdGlvbiBlcnJvcjpcbiIgKyAiIi5qb2luKHRyYWNlYmFjay5mb3JtYXRfc3RhY2soKSkpCiAgICAgICAgcmV0dXJuIE5vbmUsIEZhbHNlCiAgICB0cnk6CiAgICAgICAgcmVxID0gc2VydmljZS5maWxlcygpLmdldChmaWxlSWQ9Zm9sZGVyX2lkLCBmaWVsZHM9ImlkLG5hbWUsbWltZVR5cGUiLCBzdXBwb3J0c0FsbERyaXZlcz1UcnVlKQogICAgICAgIG1ldGEgPSBnYXBpX2V4ZWN1dGVfd2l0aF9yZXRyeShyZXEpCiAgICAgICAgaWYgbWV0YS5nZXQoIm1pbWVUeXBlIikgIT0gImFwcGxpY2F0aW9uL3ZuZC5nb29nbGUtYXBwcy5mb2xkZXIiOgogICAgICAgICAgICBsb2dnaW5nLmVycm9yKEwoZiJOb3QgYSBmb2xkZXI6IHttZXRhLmdldCgnbmFtZScpfSAoe21ldGEuZ2V0KCdtaW1lVHlwZScpfSkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJCdWthbiBmb2xkZXI6IHttZXRhLmdldCgnbmFtZScpfSAoe21ldGEuZ2V0KCdtaW1lVHlwZScpfSkiKSk7IHJldHVybiBOb25lLCBGYWxzZQogICAgICAgIHJldHVybiBzYWZlX2ZpbGVuYW1lKG1ldGEuZ2V0KCJuYW1lIiwgZm9sZGVyX2lkKSksIFRydWUKICAgIGV4Y2VwdCBIdHRwRXJyb3IgYXMgZToKICAgICAgICBjb250ZW50ID0gKGdldGF0dHIoZSwgImNvbnRlbnQiLCBiIiIpIG9yIGIiIikuZGVjb2RlKCJ1dGYtOCIsICJpZ25vcmUiKQogICAgICAgIGlmIGUucmVzcC5zdGF0dXMgPT0gNDA0OgogICAgICAgICAgICBsb2dnaW5nLmVycm9yKEwoZiJOb3QgZm91bmQvbm8gYWNjZXNzOiB7Zm9sZGVyX2lkfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIkZvbGRlciB0aWRhayBkaXRlbXVrYW4vYWtzZXMgZGl0b2xhazoge2ZvbGRlcl9pZH0iKSkKICAgICAgICBlbGlmIGUucmVzcC5zdGF0dXMgPT0gNDAzOgogICAgICAgICAgICBsb2dnaW5nLmVycm9yKEwoZiJBY2Nlc3MgZGVuaWVkIGZvciBmb2xkZXI6IHtmb2xkZXJfaWR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiQWtzZXMgZGl0b2xhayB1bnR1ayBmb2xkZXI6IHtmb2xkZXJfaWR9IikpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihMKGYiRmFpbGVkIHRvIHJlc29sdmUgZm9sZGVyIHtmb2xkZXJfaWR9OiB7ZX0ge2NvbnRlbnR9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiR2FnYWwgcmVzb2x2ZSBmb2xkZXIge2ZvbGRlcl9pZH06IHtlfSB7Y29udGVudH0iKSkKICAgICAgICByZXR1cm4gTm9uZSwgRmFsc2UKCmRlZiB3YWl0X2lmX3BhdXNlZCgpOgogICAgIiIiQmxvY2sgd2hpbGUgUEFVU0UgaXMgVHJ1ZSwgdW5sZXNzIGludGVycnVwdGVkLiIiIgogICAgaW1wb3J0IHRpbWUgYXMgX3QKICAgIHdoaWxlIFBBVVNFIGFuZCBub3QgSU5URVJSVVBURUQ6CiAgICAgICAgX3Quc2xlZXAoMC4yKQoKCmRlZiBsaXN0X2ZvbGRlcl9yZWN1cnNpdmUoc2VydmljZSwgZm9sZGVyX2lkOiBzdHIsIHJlbF9wYXRoOiBzdHIgPSAiIiwgZXh0ZXJuYWxfY2FuY2VsX2NoZWNrPU5vbmUpIC0+IEl0ZXJhdG9yW0RpY3RdOgogICAgIiIiCiAgICBZaWVsZCBmaWxlIGRpY3RzIGZvciBhbGwgbWVkaWEgaXRlbXMgdW5kZXIgZm9sZGVyX2lkLCBkZXNjZW5kaW5nIGludG8gc3ViZm9sZGVycy4KICAgIFNob3J0Y3V0IGZpbGVzIGFyZSBub3JtYWxpemVkIHRvIGxvb2sgbGlrZSByZWFsIGZpbGVzIHVzaW5nIHNob3J0Y3V0RGV0YWlscyBzbyB0aGF0CiAgICBjb3VudGluZyBhbmQgZG93bmxvYWRpbmcgd29yayB3aXRob3V0IGV4dHJhIEFQSSBjYWxscy4KICAgIAogICAgZXh0ZXJuYWxfY2FuY2VsX2NoZWNrOiBPcHRpb25hbCBjYWxsYWJsZSB0aGF0IHJldHVybnMgVHJ1ZSBpZiBvcGVyYXRpb24gc2hvdWxkIGJlIGNhbmNlbGxlZAogICAgIiIiCiAgICBmaWVsZHMgPSAoCiAgICAgICAgICAgICJuZXh0UGFnZVRva2VuLCAiCiAgICAgICAgICAgICJmaWxlcyhpZCwgbmFtZSwgbWltZVR5cGUsIGZpbGVFeHRlbnNpb24sIHNpemUsICIKICAgICAgICAgICAgIiAgICAgIHNob3J0Y3V0RGV0YWlscyh0YXJnZXRJZCwgdGFyZ2V0TWltZVR5cGUpKSIKICAgICAgICApCiAgICBxdWVyeSA9IGYiJ3tmb2xkZXJfaWR9JyBpbiBwYXJlbnRzIGFuZCB0cmFzaGVkID0gZmFsc2UiCiAgICBwYWdlX3Rva2VuID0gTm9uZQoKICAgIHdoaWxlIFRydWU6CiAgICAgICAgaWYgSU5URVJSVVBURUQgb3IgKGV4dGVybmFsX2NhbmNlbF9jaGVjayBhbmQgZXh0ZXJuYWxfY2FuY2VsX2NoZWNrKCkpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICB3YWl0X2lmX3BhdXNlZCgpCiAgICAgICAgcmVxID0gc2VydmljZS5maWxlcygpLmxpc3QoCiAgICAgICAgICAgIHE9cXVlcnksCiAgICAgICAgICAgIGZpZWxkcz1maWVsZHMsCiAgICAgICAgICAgIHBhZ2VUb2tlbj1wYWdlX3Rva2VuLAogICAgICAgICAgICBzdXBwb3J0c0FsbERyaXZlcz1UcnVlLAogICAgICAgICAgICBpbmNsdWRlSXRlbXNGcm9tQWxsRHJpdmVzPVRydWUsCiAgICAgICAgICAgIGNvcnBvcmE9ImFsbERyaXZlcyIsCiAgICAgICAgICAgIHBhZ2VTaXplPTEwMDAsCiAgICAgICAgICAgIG9yZGVyQnk9Im5hbWVfbmF0dXJhbCIKICAgICAgICApCiAgICAgICAgcmVzcCA9IGdhcGlfZXhlY3V0ZV93aXRoX3JldHJ5KHJlcSkKCiAgICAgICAgd2FpdF9pZl9wYXVzZWQoKQogICAgICAgIGZvciBpdGVtIGluIHJlc3AuZ2V0KCJmaWxlcyIsIFtdKToKICAgICAgICAgICAgaWYgSU5URVJSVVBURUQgb3IgKGV4dGVybmFsX2NhbmNlbF9jaGVjayBhbmQgZXh0ZXJuYWxfY2FuY2VsX2NoZWNrKCkpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHdhaXRfaWZfcGF1c2VkKCkKICAgICAgICAgICAgbWltZSA9IGl0ZW0uZ2V0KCJtaW1lVHlwZSIsICIiKQogICAgICAgICAgICBpZiBtaW1lID09ICJhcHBsaWNhdGlvbi92bmQuZ29vZ2xlLWFwcHMuZm9sZGVyIjoKICAgICAgICAgICAgICAgIHN1Yl9uYW1lID0gc2FmZV9maWxlbmFtZShpdGVtLmdldCgibmFtZSIsICIiKSkKICAgICAgICAgICAgICAgIHN1Yl9yZWwgID0gb3MucGF0aC5qb2luKHJlbF9wYXRoLCBzdWJfbmFtZSkgaWYgcmVsX3BhdGggZWxzZSBzdWJfbmFtZQogICAgICAgICAgICAgICAgbG9nZ2luZy5kZWJ1ZyhMKGYiRGVzY2VuZGluZyBpbnRvIHN1YmZvbGRlcjoge3N1Yl9uYW1lfSAtPiB7c3ViX3JlbH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiTWFzdWsgc3ViZm9sZGVyOiB7c3ViX25hbWV9IC0+IHtzdWJfcmVsfSIpKQogICAgICAgICAgICAgICAgeWllbGQgZnJvbSBsaXN0X2ZvbGRlcl9yZWN1cnNpdmUoc2VydmljZSwgaXRlbS5nZXQoImlkIiksIHN1Yl9yZWwsIGV4dGVybmFsX2NhbmNlbF9jaGVjaykKCiAgICAgICAgICAgIGVsaWYgbWltZSA9PSAiYXBwbGljYXRpb24vdm5kLmdvb2dsZS1hcHBzLnNob3J0Y3V0IjoKICAgICAgICAgICAgICAgIHNkID0gaXRlbS5nZXQoInNob3J0Y3V0RGV0YWlscyIpIG9yIHt9CiAgICAgICAgICAgICAgICB0YXJnZXRfaWQgICA9IHNkLmdldCgidGFyZ2V0SWQiKQogICAgICAgICAgICAgICAgdGFyZ2V0X21pbWUgPSBzZC5nZXQoInRhcmdldE1pbWVUeXBlIikKCiAgICAgICAgICAgICAgICAjIElmIHRoZSBzaG9ydGN1dCBwb2ludHMgYXQgYSBmb2xkZXIsIHJlY3Vyc2UgaW50byB0aGF0IGZvbGRlci4KICAgICAgICAgICAgICAgIGlmIHRhcmdldF9taW1lID09ICJhcHBsaWNhdGlvbi92bmQuZ29vZ2xlLWFwcHMuZm9sZGVyIiBhbmQgdGFyZ2V0X2lkOgogICAgICAgICAgICAgICAgICAgIHN1Yl9uYW1lID0gc2FmZV9maWxlbmFtZShpdGVtLmdldCgibmFtZSIsICJzaG9ydGN1dCIpKQogICAgICAgICAgICAgICAgICAgIHN1Yl9yZWwgID0gb3MucGF0aC5qb2luKHJlbF9wYXRoLCBzdWJfbmFtZSkgaWYgcmVsX3BhdGggZWxzZSBzdWJfbmFtZQogICAgICAgICAgICAgICAgICAgIGxvZ2dpbmcuZGVidWcoTChmIkZvbGxvd2luZyBmb2xkZXIgc2hvcnRjdXQ6IHtzdWJfbmFtZX0gLT4ge3RhcmdldF9pZH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIk1lbmdpa3V0aSBzaG9ydGN1dCBmb2xkZXI6IHtzdWJfbmFtZX0gLT4ge3RhcmdldF9pZH0iKSkKICAgICAgICAgICAgICAgICAgICB5aWVsZCBmcm9tIGxpc3RfZm9sZGVyX3JlY3Vyc2l2ZShzZXJ2aWNlLCB0YXJnZXRfaWQsIHN1Yl9yZWwsIGV4dGVybmFsX2NhbmNlbF9jaGVjaykKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBOb3JtYWxpemUgZmlsZS1zaG9ydGN1dHMgaW50byAicmVhbCBmaWxlIiBkaWN0cyBzbyBjb3VudGluZy9kb3dubG9hZGluZyBqdXN0IHdvcmtzLgogICAgICAgICAgICAgICAgICAgIG5vcm0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICAgICAgICAgICAgdGFyZ2V0X2lkIG9yIGl0ZW0uZ2V0KCJpZCIpLAogICAgICAgICAgICAgICAgICAgICAgICAibmFtZSI6ICAgICAgICAgIGl0ZW0uZ2V0KCJuYW1lIiwgInNob3J0Y3V0IiksCiAgICAgICAgICAgICAgICAgICAgICAgICJtaW1lVHlwZSI6ICAgICAgdGFyZ2V0X21pbWUgb3IgbWltZSwKICAgICAgICAgICAgICAgICAgICAgICAgImZpbGVFeHRlbnNpb24iOiBpdGVtLmdldCgiZmlsZUV4dGVuc2lvbiIpLAogICAgICAgICAgICAgICAgICAgICAgICAic2l6ZSI6ICAgICAgICAgIGl0ZW0uZ2V0KCJzaXplIiksICAjIENvcHkgc2l6ZSBmcm9tIG9yaWdpbmFsIGl0ZW0KICAgICAgICAgICAgICAgICAgICAgICAgIl9fcmVsX3BhdGgiOiAgICByZWxfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgIl9fZnJvbV9zaG9ydGN1dCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHlpZWxkIG5vcm0KCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpdGVtWyJfX3JlbF9wYXRoIl0gPSByZWxfcGF0aAogICAgICAgICAgICAgICAgeWllbGQgaXRlbQoKICAgICAgICBwYWdlX3Rva2VuID0gcmVzcC5nZXQoIm5leHRQYWdlVG9rZW4iKQogICAgICAgIGlmIG5vdCBwYWdlX3Rva2VuOgogICAgICAgICAgICBicmVhawoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBEb3dubG9hZHMgLS0tLS0tLS0tLS0tLS0tLS0tLS0KZnJvbSBkZnIuZG93bmxvYWRzIGltcG9ydCBjbGVhbnVwX2luY29tcGxldGVfdGFyZ2V0cywgZG93bmxvYWRfdGh1bWJuYWlsLCBkb3dubG9hZF9maWxlX3Jlc3VtYWJsZSwgZG93bmxvYWRfdmlkZW9fcmVzdW1hYmxlCgpkZWYgX21hcmtfaW5jb21wbGV0ZSh0YXJnZXQ6IHN0cik6CiAgICB3aXRoIF9MT0NLOgogICAgICAgIElOQ09NUExFVEVfVEFSR0VUUy5hZGQodGFyZ2V0KQoKZGVmIF9tYXJrX2NvbXBsZXRlKHRhcmdldDogc3RyKToKICAgIHdpdGggX0xPQ0s6CiAgICAgICAgSU5DT01QTEVURV9UQVJHRVRTLmRpc2NhcmQodGFyZ2V0KQoKZGVmIGNsZWFudXBfaW5jb21wbGV0ZV90YXJnZXRzKCk6CiAgICByZW1vdmVkID0gMAogICAgd2l0aCBfTE9DSzoKICAgICAgICB0YXJnZXRzID0gbGlzdChJTkNPTVBMRVRFX1RBUkdFVFMpCiAgICAgICAgSU5DT01QTEVURV9UQVJHRVRTLmNsZWFyKCkKICAgIGZvciB0IGluIHRhcmdldHM6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyh0KToKICAgICAgICAgICAgICAgIG9zLnJlbW92ZSh0KQogICAgICAgICAgICAgICAgcmVtb3ZlZCArPSAxCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgaWYgcmVtb3ZlZDoKICAgICAgICBsb2dnaW5nLndhcm5pbmcoTChmIlJlbW92ZWQge3JlbW92ZWR9IGluY29tcGxldGUgZmlsZShzKSBvbiBleGl0L2NhbmNlbC4iLAogICAgICAgICAgICAgICAgICAgICAgICAgIGYiTWVuZ2hhcHVzIHtyZW1vdmVkfSBiZXJrYXMgeWFuZyBiZWx1bSBzZWxlc2FpIHNhYXQga2VsdWFyL2JhdGFsLiIpKQoKZGVmIGRvd25sb2FkX3RodW1ibmFpbCh1cmw6IHN0ciwgb3V0X3BhdGg6IHN0ciwgcmV0cmllcz0xMCkgLT4gYm9vbDoKICAgIF9tYXJrX2luY29tcGxldGUob3V0X3BhdGgpCiAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZSgxLCByZXRyaWVzICsgMSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIHJlcXVlc3RzLmdldCh1cmwsIHN0cmVhbT1UcnVlLCB0aW1lb3V0PTYwKSBhcyByOgogICAgICAgICAgICAgICAgaWYgci5zdGF0dXNfY29kZSA9PSA0MDQ6IHJhaXNlIHJlcXVlc3RzLkhUVFBFcnJvcigidGh1bWJuYWlsIG5vdCByZWFkeSAoNDA0KSIpCiAgICAgICAgICAgICAgICByLnJhaXNlX2Zvcl9zdGF0dXMoKQogICAgICAgICAgICAgICAgYnl0ZXNfd3JpdHRlbiA9IDAKICAgICAgICAgICAgICAgIGVuc3VyZV9kaXIob3MucGF0aC5kaXJuYW1lKG91dF9wYXRoKSkKICAgICAgICAgICAgICAgIHdpdGggb3BlbihvdXRfcGF0aCwgIndiIikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBmb3IgY2h1bmsgaW4gci5pdGVyX2NvbnRlbnQoODE5Mik6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNodW5rOiBmLndyaXRlKGNodW5rKTsgYnl0ZXNfd3JpdHRlbiArPSBsZW4oY2h1bmspCiAgICAgICAgICAgIF9tYXJrX2NvbXBsZXRlKG91dF9wYXRoKQogICAgICAgICAgICBsb2dnaW5nLmluZm8oTChmIkltYWdlIHNhdmVkOiB7b3V0X3BhdGh9ICh7aHVtYW5fYnl0ZXMoYnl0ZXNfd3JpdHRlbil9KSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiR2FtYmFyIHRlcnNpbXBhbjoge291dF9wYXRofSAoe2h1bWFuX2J5dGVzKGJ5dGVzX3dyaXR0ZW4pfSkiKSkKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKGYiW0J5dGVzXSB7VE9UQUxTLmdyYW5kLmJ5dGVzX3dyaXR0ZW59IikKICAgICAgICAgICAgVE9UQUxTLmdyYW5kLmJ5dGVzX3dyaXR0ZW4gKz0gYnl0ZXNfd3JpdHRlbjsgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGlmIGF0dGVtcHQgPT0gMTA6CiAgICAgICAgICAgICAgICBfbWFya19pbmNvbXBsZXRlKG91dF9wYXRoKSAgIyByZW1haW5zIGZvciBjbGVhbnVwCiAgICAgICAgICAgICAgICBsb2dnaW5nLmVycm9yKEwoZiJbIV0gVGh1bWJuYWlsIGZhaWxlZCBwZXJtYW5lbnRseToge3VybH0gLT4ge2V9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIlshXSBUaHVtYm5haWwgZ2FnYWwgcGVybWFuZW46IHt1cmx9IC0+IHtlfSIpKTsgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGxvZ2dpbmcud2FybmluZyhMKGYiVGh1bWJuYWlsIGF0dGVtcHQge2F0dGVtcHR9LzEwIGZhaWxlZDoge2V9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJQZXJjb2JhYW4gdGh1bWJuYWlsIHthdHRlbXB0fS8xMCBnYWdhbDoge2V9IikpOyBiYWNrb2ZmX3NsZWVwKGF0dGVtcHQpCgpkZWYgZG93bmxvYWRfZmlsZV9yZXN1bWFibGUoc2VydmljZSwgY3JlZHMsIGZpbGVfaWQ6IHN0ciwgdGFyZ2V0OiBzdHIsIGxhYmVsOiBzdHIgPSAiRmlsZSIpIC0+IGJvb2w6CiAgICBfbWFya19pbmNvbXBsZXRlKHRhcmdldCkKICAgICIiIkdlbmVyaWMgcmVzdW1hYmxlIEdFVCA/YWx0PW1lZGlhIHVzaW5nIEF1dGhvcml6ZWRTZXNzaW9uIHdpdGggUmFuZ2UsIGZvciBpbWFnZXMgb3IgYW55IGZpbGUuIiIiCiAgICBlbnN1cmVfZGlyKG9zLnBhdGguZGlybmFtZSh0YXJnZXQpKTsgc2Vzc2lvbiA9IEF1dGhvcml6ZWRTZXNzaW9uKGNyZWRzKQogICAgdXJsID0gZiJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9kcml2ZS92My9maWxlcy97ZmlsZV9pZH0/YWx0PW1lZGlhIgogICAgdG90YWxfc2l6ZSA9IE5vbmUKICAgIHRyeToKICAgICAgICBtZXRhID0gZ2V0X2l0ZW0oc2VydmljZSwgZmlsZV9pZCwgInNpemUsIG5hbWUiKQogICAgICAgIGlmICJzaXplIiBpbiBtZXRhOiB0b3RhbF9zaXplID0gaW50KG1ldGFbInNpemUiXSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dnaW5nLmRlYnVnKEwoZiJDb3VsZCBub3QgZ2V0IHNpemUgZm9yIHtmaWxlX2lkfToge2V9IiwKICAgICAgICAgICAgICAgICAgICAgICAgZiJUaWRhayBiaXNhIG1lbmRhcGF0a2FuIHVrdXJhbiB1bnR1ayB7ZmlsZV9pZH06IHtlfSIpKQogICAgZG93bmxvYWRlZCA9IG9zLnBhdGguZ2V0c2l6ZSh0YXJnZXQpIGlmIG9zLnBhdGguZXhpc3RzKHRhcmdldCkgZWxzZSAwCiAgICBtb2RlID0gImFiIiBpZiBkb3dubG9hZGVkID4gMCBlbHNlICJ3YiIKICAgIGlmIGRvd25sb2FkZWQgPiAwOgogICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYiUmVzdW1pbmcge2xhYmVsLmxvd2VyKCl9IGF0IHtodW1hbl9ieXRlcyhkb3dubG9hZGVkKX0gLT4ge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX0iLAogICAgICAgICAgICAgICAgICAgICAgIGYiTWVsYW5qdXRrYW4ge2xhYmVsLmxvd2VyKCl9IGRpIHtodW1hbl9ieXRlcyhkb3dubG9hZGVkKX0gLT4ge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX0iKSkKICAgIGlmIHRvdGFsX3NpemUgaXMgbm90IE5vbmUgYW5kIGRvd25sb2FkZWQgPj0gdG90YWxfc2l6ZToKICAgICAgICAgICAgX21hcmtfY29tcGxldGUodGFyZ2V0KQogICAgICAgICAgICBsb2dnaW5nLmluZm8oTChmIkFscmVhZHkgY29tcGxldGU6IHtvcy5wYXRoLmJhc2VuYW1lKHRhcmdldCl9IiwKICAgICAgICAgICAgICAgICAgICAgICBmIlN1ZGFoIGxlbmdrYXA6IHtvcy5wYXRoLmJhc2VuYW1lKHRhcmdldCl9IikpOyByZXR1cm4gVHJ1ZQogICAgbGFzdF9yZXBvcnQgPSB0aW1lLnRpbWUoKQogICAgd2hpbGUgVHJ1ZToKICAgICAgICBpZiBJTlRFUlJVUFRFRDogcmV0dXJuIEZhbHNlCiAgICAgICAgd2FpdF9pZl9wYXVzZWQoKQogICAgICAgIGhlYWRlcnMgPSB7IlJhbmdlIjogZiJieXRlcz17ZG93bmxvYWRlZH0tIn0gaWYgZG93bmxvYWRlZCBlbHNlIHt9CiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMSwgOSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggc2Vzc2lvbi5nZXQodXJsLCBoZWFkZXJzPWhlYWRlcnMsIHN0cmVhbT1UcnVlLCB0aW1lb3V0PTYwKSBhcyByOgogICAgICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzX2NvZGUgbm90IGluICgyMDAsIDIwNik6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHIuc3RhdHVzX2NvZGUgPT0gNDE2IGFuZCB0b3RhbF9zaXplIGFuZCBvcy5wYXRoLmdldHNpemUodGFyZ2V0KSA+PSB0b3RhbF9zaXplOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoIlNlcnZlciByZXBvcnRzIGNvbXBsZXRlICg0MTYpLiIsICJTZXJ2ZXIgbWVsYXBvciBzZWxlc2FpICg0MTYpLiIpKTsgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgci5yYWlzZV9mb3Jfc3RhdHVzKCkKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4odGFyZ2V0LCBtb2RlKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgY2h1bmsgaW4gci5pdGVyX2NvbnRlbnQoY2h1bmtfc2l6ZT04KjEwMjQqMTAyNCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBJTlRFUlJVUFRFRDogcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YWl0X2lmX3BhdXNlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjaHVuazoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGNodW5rKTsgZG93bmxvYWRlZCArPSBsZW4oY2h1bmspOyBUT1RBTFMuZ3JhbmQuYnl0ZXNfd3JpdHRlbiArPSBsZW4oY2h1bmspCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbm93ID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3cgLSBsYXN0X3JlcG9ydCA+PSAxLjU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRvdGFsX3NpemU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwY3QgPSAxMDAuMCAqIGRvd25sb2FkZWQgLyB0b3RhbF9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oTCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIntsYWJlbH0ge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX06IHtwY3Q6LjFmfSUgKHtodW1hbl9ieXRlcyhkb3dubG9hZGVkKX0ve2h1bWFuX2J5dGVzKHRvdGFsX3NpemUpfSkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYie2xhYmVsfSB7b3MucGF0aC5iYXNlbmFtZSh0YXJnZXQpfToge3BjdDouMWZ9JSAoe2h1bWFuX2J5dGVzKGRvd25sb2FkZWQpfS97aHVtYW5fYnl0ZXModG90YWxfc2l6ZSl9KSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oZiJbQnl0ZXNdIHtUT1RBTFMuZ3JhbmQuYnl0ZXNfd3JpdHRlbn0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9yZXBvcnQgPSBub3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYie2xhYmVsfSB7b3MucGF0aC5iYXNlbmFtZSh0YXJnZXQpfToge2h1bWFuX2J5dGVzKGRvd25sb2FkZWQpfSBkb3dubG9hZGVkIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIntsYWJlbH0ge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX06IHtodW1hbl9ieXRlcyhkb3dubG9hZGVkKX0gZGl1bmR1aCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBpZiBhdHRlbXB0ID09IDg6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihMKGYiWyFdIENodW5rIGZhaWxlZCBwZXJtYW5lbnRseSAoaWQ9e2ZpbGVfaWR9KToge2V9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJbIV0gUG90b25nYW4gZ2FnYWwgcGVybWFuZW4gKGlkPXtmaWxlX2lkfSk6IHtlfSIpKTsgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoTChmIkNodW5rIGF0dGVtcHQge2F0dGVtcHR9LzggZmFpbGVkOiB7ZX0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJQZXJjb2JhYW4gcG90b25nYW4ge2F0dGVtcHR9LzggZ2FnYWw6IHtlfSIpKTsgYmFja29mZl9zbGVlcChhdHRlbXB0KTsgbW9kZSA9ICJhYiIKICAgICAgICBpZiB0b3RhbF9zaXplIGlzIE5vbmU6CiAgICAgICAgICAgIGhlYWRlcnNfcHJvYmUgPSB7IlJhbmdlIjogZiJieXRlcz17ZG93bmxvYWRlZH0tIn0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2FpdF9pZl9wYXVzZWQoKQogICAgICAgICAgICAgICAgd2l0aCBzZXNzaW9uLmdldCh1cmwsIGhlYWRlcnM9aGVhZGVyc19wcm9iZSwgc3RyZWFtPVRydWUsIHRpbWVvdXQ9MzApIGFzIHIyOgogICAgICAgICAgICAgICAgICAgIGlmIHIyLnN0YXR1c19jb2RlID09IDQxNjoKICAgICAgICAgICAgICAgICAgICAgICAgX21hcmtfY29tcGxldGUodGFyZ2V0KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oTCgiU2VydmVyIGluZGljYXRlZCBFT0YgKDQxNik7IHRyZWF0aW5nIGFzIGNvbXBsZXRlLiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJTZXJ2ZXIgbWVudW5qdWtrYW4gRU9GICg0MTYpOyBkaWFuZ2dhcCBzZWxlc2FpLiIpKTsgcmV0dXJuIFRydWUKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgaWYgdG90YWxfc2l6ZSBpcyBub3QgTm9uZSBhbmQgZG93bmxvYWRlZCA+PSB0b3RhbF9zaXplOgogICAgICAgICAgICBfbWFya19jb21wbGV0ZSh0YXJnZXQpCiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYie2xhYmVsfSBkb25lOiB7b3MucGF0aC5iYXNlbmFtZSh0YXJnZXQpfSAoe2h1bWFuX2J5dGVzKGRvd25sb2FkZWQpfSkiLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmIntsYWJlbH0gc2VsZXNhaToge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX0gKHtodW1hbl9ieXRlcyhkb3dubG9hZGVkKX0pIikpCiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhmIltCeXRlc10ge1RPVEFMUy5ncmFuZC5ieXRlc193cml0dGVufSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCgpkZWYgZG93bmxvYWRfdmlkZW9fcmVzdW1hYmxlKHNlcnZpY2UsIGNyZWRzLCBmaWxlX2lkOiBzdHIsIHRhcmdldDogc3RyKSAtPiBib29sOgogICAgcmV0dXJuIGRvd25sb2FkX2ZpbGVfcmVzdW1hYmxlKHNlcnZpY2UsIGNyZWRzLCBmaWxlX2lkLCB0YXJnZXQsIGxhYmVsPUwoIlZpZGVvIiwgIlZpZGVvIikpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIFRhcmdldCBwYXRocyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKZGVmIF9pbWFnZV90YXJnZXRfcGF0aChvdXRfc3ViZGlyOiBzdHIsIG5hbWU6IHN0ciwgZmlsZV9pZDogc3RyLCBvcmlnaW5hbDogYm9vbCwgZmlsZV9leHQ6IE9wdGlvbmFsW3N0cl0pIC0+IHN0cjoKICAgIGJhc2UsIGV4dF9mcm9tX25hbWUgPSBvcy5wYXRoLnNwbGl0ZXh0KG5hbWUpCiAgICBpZiBvcmlnaW5hbDoKICAgICAgICBleHQgPSBleHRfZnJvbV9uYW1lIG9yICgoIi4iICsgZmlsZV9leHQpIGlmIGZpbGVfZXh0IGVsc2UgIi5qcGciKQogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4ob3V0X3N1YmRpciwgZiJ7YmFzZX1fX3tmaWxlX2lkfXtleHR9IikKICAgICMgdGh1bWJuYWlsCiAgICByZXR1cm4gb3MucGF0aC5qb2luKG91dF9zdWJkaXIsIGYie2Jhc2V9X197ZmlsZV9pZH1fd3tJTUFHRV9XSURUSH0uanBnIikKCmRlZiBfdmlkZW9fdGFyZ2V0X3BhdGgob3V0X3N1YmRpcjogc3RyLCBuYW1lOiBzdHIsIGZpbGVfaWQ6IHN0cikgLT4gc3RyOgogICAgYmFzZSwgZXh0ID0gb3MucGF0aC5zcGxpdGV4dChuYW1lKQogICAgaWYgbm90IGV4dDoKICAgICAgICBleHQgPSAiLm1wNCIKICAgIHJldHVybiBvcy5wYXRoLmpvaW4ob3V0X3N1YmRpciwgZiJ7YmFzZX1fX3tmaWxlX2lkfXtleHR9IikKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0gUHJvY2Vzc2luZyAtLS0tLS0tLS0tLS0tLS0tLS0tLQpmcm9tIGRmci5wcm9jZXNzIGltcG9ydCBwcm9jZXNzX2ZpbGUsIHByaW50X2ZvbGRlcl9zdW1tYXJ5LCBwcmludF9ncmFuZF9zdW1tYXJ5LCBwcmludF9wcm9ncmVzcwoKZGVmIHByb2Nlc3NfZmlsZShzZXJ2aWNlLCBjcmVkcywgZmlsZV9vYmo6IERpY3QsIG91dF9kaXI6IHN0ciwgY291bnRlcnNfa2V5OiBzdHIpIC0+IGJvb2w6CiAgICB3aXRoIF9MT0NLOgogICAgICAgIFRPVEFMUy5ncmFuZC5zY2FubmVkICs9IDEKICAgICAgICBmb2xkZXJfY3RycyA9IFRPVEFMUy5mb2xkZXIoY291bnRlcnNfa2V5KQogICAgICAgIGZvbGRlcl9jdHJzLnNjYW5uZWQgKz0gMQogICAgbmFtZSA9IHNhZmVfZmlsZW5hbWUoZmlsZV9vYmouZ2V0KCJuYW1lIiwgZmlsZV9vYmouZ2V0KCJpZCIsImZpbGUiKSkpOyBtaW1lID0gZmlsZV9vYmouZ2V0KCJtaW1lVHlwZSIsIiIpOyBmaWQgPSBmaWxlX29iai5nZXQoImlkIik7IGZpbGVfZXh0ID0gZmlsZV9vYmouZ2V0KCJmaWxlRXh0ZW5zaW9uIikKICAgIG1lZGlhX2tpbmQgPSBjbGFzc2lmeV9tZWRpYShtaW1lLCBuYW1lLCBmaWxlX2V4dCkKICAgIHJlbF9wYXRoID0gZmlsZV9vYmouZ2V0KCJfX3JlbF9wYXRoIiwiIik7IG91dF9zdWJkaXIgPSBvcy5wYXRoLmpvaW4ob3V0X2RpciwgcmVsX3BhdGgpIGlmIHJlbF9wYXRoIGVsc2Ugb3V0X2RpcjsgZW5zdXJlX2RpcihvdXRfc3ViZGlyKQoKICAgIGlmIG1lZGlhX2tpbmQgPT0gImltYWdlIjoKICAgICAgICB0YXJnZXQgPSBfaW1hZ2VfdGFyZ2V0X3BhdGgob3V0X3N1YmRpciwgbmFtZSwgZmlkLCBET1dOTE9BRF9JTUFHRVNfT1JJR0lOQUwsIGZpbGVfZXh0KQogICAgICAgIGlmIG5vdCBPVkVSV1JJVEUgYW5kIG9zLnBhdGguZXhpc3RzKHRhcmdldCk6CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYiPSBleGlzdHMgKGltYWdlKToge3RhcmdldH0iLCBmIj0gc3VkYWggYWRhIChnYW1iYXIpOiB7dGFyZ2V0fSIpKQogICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgVE9UQUxTLmdyYW5kLmltYWdlc19za2lwcGVkICs9IDE7IGZvbGRlcl9jdHJzLmltYWdlc19za2lwcGVkICs9IDEKICAgICAgICAgICAgIyBSZXR1cm4gVHJ1ZSBmb3IgZXhpc3RpbmcgZmlsZXMgc28gdGhleSBjb3VudCBhcyAiY29tcGxldGVkIiBmb3IgcHJvZ3Jlc3MgcHVycG9zZXMKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBpZiBET1dOTE9BRF9JTUFHRVNfT1JJR0lOQUw6CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYiRG93bmxvYWRpbmcgaW1hZ2Ugb3JpZ2luYWwgLT4ge3RhcmdldH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmIk1lbmd1bmR1aCBnYW1iYXIgdWt1cmFuIGFzbGkgLT4ge3RhcmdldH0iKSkKICAgICAgICAgICAgb2sgPSBkb3dubG9hZF9maWxlX3Jlc3VtYWJsZShzZXJ2aWNlLCBjcmVkcywgZmlkLCB0YXJnZXQsIGxhYmVsPUwoIkltYWdlIiwgIkdhbWJhciIpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHVybCA9IGYiaHR0cHM6Ly9kcml2ZS5nb29nbGUuY29tL3RodW1ibmFpbD9zej13e0lNQUdFX1dJRFRIfSZpZD17ZmlkfSIKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoZiJEb3dubG9hZGluZyBpbWFnZSB0aHVtYm5haWwgLT4ge3RhcmdldH0iLAogICAgICAgICAgICAgICAgICAgICAgICAgICBmIk1lbmd1bmR1aCB0aHVtYm5haWwgLT4ge3RhcmdldH0iKSkKICAgICAgICAgICAgb2sgPSBkb3dubG9hZF90aHVtYm5haWwodXJsLCB0YXJnZXQpCiAgICAgICAgaWYgb2s6CiAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICBUT1RBTFMuZ3JhbmQuaW1hZ2VzX2RvbmUgKz0gMTsgZm9sZGVyX2N0cnMuaW1hZ2VzX2RvbmUgKz0gMQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICMgZmFpbGVkCiAgICAgICAgd2l0aCBfTE9DSzoKICAgICAgICAgICAgVE9UQUxTLmdyYW5kLmltYWdlc19mYWlsZWQgKz0gMTsgZm9sZGVyX2N0cnMuaW1hZ2VzX2ZhaWxlZCArPSAxCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgRkFJTEVEX0lURU1TLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAiaWQiOiBmaWQsICJuYW1lIjogbmFtZSwgImtpbmQiOiAiaW1hZ2UiLCAiX19yb290X25hbWUiOiBjb3VudGVyc19rZXksCiAgICAgICAgICAgICAgICAiX19mb2xkZXJfb3V0Ijogb3V0X3N1YmRpciwgInRhcmdldCI6IHRhcmdldAogICAgICAgICAgICB9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBlbGlmIG1lZGlhX2tpbmQgPT0gInZpZGVvIjoKICAgICAgICB0YXJnZXQgPSBfdmlkZW9fdGFyZ2V0X3BhdGgob3V0X3N1YmRpciwgbmFtZSwgZmlkKQogICAgICAgIGlmIG5vdCBPVkVSV1JJVEUgYW5kIG9zLnBhdGguZXhpc3RzKHRhcmdldCk6CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYiPSBleGlzdHMgKHZpZGVvKToge3RhcmdldH0iLCBmIj0gc3VkYWggYWRhICh2aWRlbyk6IHt0YXJnZXR9IikpCiAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICBUT1RBTFMuZ3JhbmQudmlkZW9zX3NraXBwZWQgKz0gMTsgZm9sZGVyX2N0cnMudmlkZW9zX3NraXBwZWQgKz0gMQogICAgICAgICAgICAjIFJldHVybiBUcnVlIGZvciBleGlzdGluZyBmaWxlcyBzbyB0aGV5IGNvdW50IGFzICJjb21wbGV0ZWQiIGZvciBwcm9ncmVzcyBwdXJwb3NlcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGlmIG5vdCBET1dOTE9BRF9WSURFT1M6CiAgICAgICAgICAgIGxvZ2dpbmcuaW5mbyhMKCJTa2lwcGluZyB2aWRlbzsgb3B0aW9uIGRpc2FibGVkLiIsICJMZXdhdGkgdmlkZW8gKG9wc2kgbm9uYWt0aWYpLiIpKQogICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgVE9UQUxTLmdyYW5kLnZpZGVvc19za2lwcGVkICs9IDE7IGZvbGRlcl9jdHJzLnZpZGVvc19za2lwcGVkICs9IDEKICAgICAgICAgICAgIyBSZXR1cm4gRmFsc2UgZm9yIHZpZGVvcyB0aGF0IGFyZSBpbnRlbnRpb25hbGx5IHNraXBwZWQgKGRvbid0IGNvdW50IGFzIGNvbXBsZXRlZCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgbG9nZ2luZy5pbmZvKEwoZiJEb3dubG9hZGluZyB2aWRlbyAtPiB7dGFyZ2V0fSIsIGYiTWVuZ3VuZHVoIHZpZGVvIC0+IHt0YXJnZXR9IikpCiAgICAgICAgb2sgPSBkb3dubG9hZF92aWRlb19yZXN1bWFibGUoc2VydmljZSwgY3JlZHMsIGZpZCwgdGFyZ2V0KSBpZiBST0JVU1RfUkVTVU1FIGVsc2UgX2Rvd25sb2FkX3ZpZGVvX3NpbXBsZShzZXJ2aWNlLCBmaWQsIHRhcmdldCkKICAgICAgICBpZiBvazoKICAgICAgICAgICAgd2l0aCBfTE9DSzoKICAgICAgICAgICAgICAgIFRPVEFMUy5ncmFuZC52aWRlb3NfZG9uZSArPSAxOyBmb2xkZXJfY3Rycy52aWRlb3NfZG9uZSArPSAxCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgIyBmYWlsZWQKICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICBUT1RBTFMuZ3JhbmQudmlkZW9zX2ZhaWxlZCArPSAxOyBmb2xkZXJfY3Rycy52aWRlb3NfZmFpbGVkICs9IDEKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICBGQUlMRURfSVRFTVMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICJpZCI6IGZpZCwgIm5hbWUiOiBuYW1lLCAia2luZCI6ICJ2aWRlbyIsICJfX3Jvb3RfbmFtZSI6IGNvdW50ZXJzX2tleSwKICAgICAgICAgICAgICAgICJfX2ZvbGRlcl9vdXQiOiBvdXRfc3ViZGlyLCAidGFyZ2V0IjogdGFyZ2V0CiAgICAgICAgICAgIH0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGVsaWYgbWVkaWFfa2luZCA9PSAiZGF0YSI6CiAgICAgICAgIyBIYW5kbGUgZGF0YSBmaWxlcyAoUERGcywgZG9jdW1lbnRzLCBldGMuKQogICAgICAgIGJhc2UsIGV4dCA9IG9zLnBhdGguc3BsaXRleHQobmFtZSkKICAgICAgICBpZiBub3QgZXh0OgogICAgICAgICAgICAjIFRyeSB0byBkZXRlcm1pbmUgZXh0ZW5zaW9uIGZyb20gbWltZSB0eXBlIG9yIGZpbGUgZXh0ZW5zaW9uIG1ldGFkYXRhCiAgICAgICAgICAgIGlmICJwZGYiIGluIG1pbWUubG93ZXIoKToKICAgICAgICAgICAgICAgIGV4dCA9ICIucGRmIgogICAgICAgICAgICBlbGlmICJ0ZXh0IiBpbiBtaW1lLmxvd2VyKCk6CiAgICAgICAgICAgICAgICBleHQgPSAiLnR4dCIKICAgICAgICAgICAgZWxpZiBmaWxlX2V4dDoKICAgICAgICAgICAgICAgIGV4dCA9IGYiLntmaWxlX2V4dH0iCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBleHQgPSAiLmRhdCIgICMgZ2VuZXJpYyBkYXRhIGV4dGVuc2lvbgogICAgICAgIHRhcmdldCA9IG9zLnBhdGguam9pbihvdXRfc3ViZGlyLCBmIntiYXNlfV9fe2ZpZH17ZXh0fSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IE9WRVJXUklURSBhbmQgb3MucGF0aC5leGlzdHModGFyZ2V0KToKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoZiI9IGV4aXN0cyAoZGF0YSk6IHt0YXJnZXR9IiwgZiI9IHN1ZGFoIGFkYSAoZGF0YSk6IHt0YXJnZXR9IikpCiAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICBUT1RBTFMuZ3JhbmQuZGF0YV9za2lwcGVkICs9IDE7IGZvbGRlcl9jdHJzLmRhdGFfc2tpcHBlZCArPSAxCiAgICAgICAgICAgICMgUmV0dXJuIFRydWUgZm9yIGV4aXN0aW5nIGZpbGVzIHNvIHRoZXkgY291bnQgYXMgImNvbXBsZXRlZCIgZm9yIHByb2dyZXNzIHB1cnBvc2VzCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dpbmcuaW5mbyhMKGYiRG93bmxvYWRpbmcgZGF0YSBmaWxlIC0+IHt0YXJnZXR9IiwgZiJNZW5ndW5kdWggZmlsZSBkYXRhIC0+IHt0YXJnZXR9IikpCiAgICAgICAgb2sgPSBkb3dubG9hZF9maWxlX3Jlc3VtYWJsZShzZXJ2aWNlLCBjcmVkcywgZmlkLCB0YXJnZXQsIGxhYmVsPUwoIkRhdGEiLCAiRGF0YSIpKQogICAgICAgIGlmIG9rOgogICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgVE9UQUxTLmdyYW5kLmRhdGFfZG9uZSArPSAxOyBmb2xkZXJfY3Rycy5kYXRhX2RvbmUgKz0gMQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICMgZmFpbGVkCiAgICAgICAgd2l0aCBfTE9DSzoKICAgICAgICAgICAgVE9UQUxTLmdyYW5kLmRhdGFfZmFpbGVkICs9IDE7IGZvbGRlcl9jdHJzLmRhdGFfZmFpbGVkICs9IDEKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICBGQUlMRURfSVRFTVMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICJpZCI6IGZpZCwgIm5hbWUiOiBuYW1lLCAia2luZCI6ICJkYXRhIiwgIl9fcm9vdF9uYW1lIjogY291bnRlcnNfa2V5LAogICAgICAgICAgICAgICAgIl9fZm9sZGVyX291dCI6IG91dF9zdWJkaXIsICJ0YXJnZXQiOiB0YXJnZXQKICAgICAgICAgICAgfSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZWxzZToKICAgICAgICBsb2dnaW5nLmRlYnVnKEwoZiItIHNraXAgdW5jbGFzc2lmaWVkOiB7bmFtZX0gW3ttaW1lfV0iLCBmIi0gbGV3YXRpICh0aWRhayB0ZXJrbGFzaWZpa2FzaSk6IHtuYW1lfSBbe21pbWV9XSIpKTsgcmV0dXJuIEZhbHNlCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIFN1bW1hcmllcyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKZGVmIHByaW50X2ZvbGRlcl9zdW1tYXJ5KHJvb3RfbmFtZTogc3RyLCBsaW5rX2ltYWdlczogaW50LCBsaW5rX2ltYWdlc19leGlzdGluZzogaW50LCBsaW5rX3ZpZGVvczogaW50LCBsaW5rX3ZpZGVvc19leGlzdGluZzogaW50KToKICAgIGxvZ2dpbmcuaW5mbyhMKAogICAgICAgIGYiW1ByZS1TY2FuIEZvbGRlcl0ge3Jvb3RfbmFtZX0gfCBpbWFnZXMgdG90YWw9e2xpbmtfaW1hZ2VzfSAoaGF2ZSB7bGlua19pbWFnZXNfZXhpc3Rpbmd9KSB8ICIKICAgICAgICBmInZpZGVvcyB0b3RhbD17bGlua192aWRlb3N9IChoYXZlIHtsaW5rX3ZpZGVvc19leGlzdGluZ30pIiwKICAgICAgICBmIltQcmEtUGluZGFpIEZvbGRlcl0ge3Jvb3RfbmFtZX0gfCB0b3RhbCBnYW1iYXI9e2xpbmtfaW1hZ2VzfSAoc3VkYWgge2xpbmtfaW1hZ2VzX2V4aXN0aW5nfSkgfCAiCiAgICAgICAgZiJ0b3RhbCB2aWRlbz17bGlua192aWRlb3N9IChzdWRhaCB7bGlua192aWRlb3NfZXhpc3Rpbmd9KSIKICAgICkpCgpkZWYgcHJpbnRfZ3JhbmRfc3VtbWFyeSgpOgogICAgZyA9IFRPVEFMUy5ncmFuZAogICAgbG9nZ2luZy5pbmZvKEwoCiAgICAgICAgZiJbR3JhbmQgU3VtbWFyeV0gZWxhcHNlZD17ZWxhcHNlZCgpfSB8IHRvdGFsIHNjYW5uZWQ9e2cuc2Nhbm5lZH0gfCAiCiAgICAgICAgZiJpbWFnZXM6IGRvbmU9e2cuaW1hZ2VzX2RvbmV9IHNraXA9e2cuaW1hZ2VzX3NraXBwZWR9IGZhaWw9e2cuaW1hZ2VzX2ZhaWxlZH0gfCAiCiAgICAgICAgZiJ2aWRlb3M6IGRvbmU9e2cudmlkZW9zX2RvbmV9IHNraXA9e2cudmlkZW9zX3NraXBwZWR9IGZhaWw9e2cudmlkZW9zX2ZhaWxlZH0gfCAiCiAgICAgICAgZiJieXRlcyB3cml0dGVuPXtodW1hbl9ieXRlcyhnLmJ5dGVzX3dyaXR0ZW4pfSIsCiAgICAgICAgZiJbUmluZ2thc2FuIFRvdGFsXSBkdXJhc2k9e2VsYXBzZWQoKX0gfCB0b3RhbCBkaXBpbmRhaT17Zy5zY2FubmVkfSB8ICIKICAgICAgICBmImdhbWJhcjogc2VsZXNhaT17Zy5pbWFnZXNfZG9uZX0gbGV3YXRpPXtnLmltYWdlc19za2lwcGVkfSBnYWdhbD17Zy5pbWFnZXNfZmFpbGVkfSB8ICIKICAgICAgICBmInZpZGVvOiBzZWxlc2FpPXtnLnZpZGVvc19kb25lfSBsZXdhdGk9e2cudmlkZW9zX3NraXBwZWR9IGdhZ2FsPXtnLnZpZGVvc19mYWlsZWR9IHwgIgogICAgICAgIGYiYnl0ZXMgZGl0dWxpcz17aHVtYW5fYnl0ZXMoZy5ieXRlc193cml0dGVuKX0iCiAgICApKQoKZGVmIHByaW50X3Byb2dyZXNzKCk6CiAgICB0b3RhbF9pbWFnZXMgPSBFWFBFQ1RFRF9JTUFHRVM7IHRvdGFsX3ZpZGVvcyA9IEVYUEVDVEVEX1ZJREVPUzsgdG90YWxfZGF0YSA9IEVYUEVDVEVEX0RBVEEKICAgICMgSW5jbHVkZSBib3RoIG5ld2x5IGRvd25sb2FkZWQgQU5EIGFscmVhZHkgZXhpc3RpbmcgZmlsZXMgaW4gdGhlICJkb25lIiBjb3VudAogICAgIyBUaGlzIGdpdmVzIHVzZXJzIGFjY3VyYXRlIHByb2dyZXNzIGluY2x1ZGluZyBmaWxlcyB0aGV5IGFscmVhZHkgaGFkCiAgICBkb25lX2ltYWdlcyA9IEFMUkVBRFlfSEFWRV9JTUFHRVMgKyBUT1RBTFMuZ3JhbmQuaW1hZ2VzX2RvbmUKICAgIGRvbmVfdmlkZW9zID0gQUxSRUFEWV9IQVZFX1ZJREVPUyArIFRPVEFMUy5ncmFuZC52aWRlb3NfZG9uZQogICAgZG9uZV9kYXRhID0gQUxSRUFEWV9IQVZFX0RBVEEgKyBUT1RBTFMuZ3JhbmQuZGF0YV9kb25lCiAgICByZW1haW5pbmdfaW1hZ2VzID0gbWF4KDAsIHRvdGFsX2ltYWdlcyAtIGRvbmVfaW1hZ2VzKQogICAgcmVtYWluaW5nX3ZpZGVvcyA9IG1heCgwLCB0b3RhbF92aWRlb3MgLSBkb25lX3ZpZGVvcykKICAgIHJlbWFpbmluZ19kYXRhID0gbWF4KDAsIHRvdGFsX2RhdGEgLSBkb25lX2RhdGEpCiAgICAKICAgICMgSW5jbHVkZSBkYXRhIGluIHByb2dyZXNzIHJlcG9ydCBpZiBhbnkgZGF0YSBmaWxlcyBhcmUgZXhwZWN0ZWQKICAgIGlmIHRvdGFsX2RhdGEgPiAwOgogICAgICAgIGxvZ2dpbmcuaW5mbyhMKAogICAgICAgICAgICBmIltQcm9ncmVzc10gaW1hZ2VzIHtkb25lX2ltYWdlc30ve3RvdGFsX2ltYWdlc30gKGxlZnQge3JlbWFpbmluZ19pbWFnZXN9KSB8ICIKICAgICAgICAgICAgZiJ2aWRlb3Mge2RvbmVfdmlkZW9zfS97dG90YWxfdmlkZW9zfSAobGVmdCB7cmVtYWluaW5nX3ZpZGVvc30pIHwgIgogICAgICAgICAgICBmImRhdGEge2RvbmVfZGF0YX0ve3RvdGFsX2RhdGF9IChsZWZ0IHtyZW1haW5pbmdfZGF0YX0pIiwKICAgICAgICAgICAgZiJbUHJvZ3Jlc3NdIGdhbWJhciB7ZG9uZV9pbWFnZXN9L3t0b3RhbF9pbWFnZXN9IChzaXNhIHtyZW1haW5pbmdfaW1hZ2VzfSkgfCAiCiAgICAgICAgICAgIGYidmlkZW8ge2RvbmVfdmlkZW9zfS97dG90YWxfdmlkZW9zfSAoc2lzYSB7cmVtYWluaW5nX3ZpZGVvc30pIHwgIgogICAgICAgICAgICBmImRhdGEge2RvbmVfZGF0YX0ve3RvdGFsX2RhdGF9IChzaXNhIHtyZW1haW5pbmdfZGF0YX0pIgogICAgICAgICkpCiAgICBlbHNlOgogICAgICAgIGxvZ2dpbmcuaW5mbyhMKAogICAgICAgICAgICBmIltQcm9ncmVzc10gaW1hZ2VzIHtkb25lX2ltYWdlc30ve3RvdGFsX2ltYWdlc30gKGxlZnQge3JlbWFpbmluZ19pbWFnZXN9KSB8ICIKICAgICAgICAgICAgZiJ2aWRlb3Mge2RvbmVfdmlkZW9zfS97dG90YWxfdmlkZW9zfSAobGVmdCB7cmVtYWluaW5nX3ZpZGVvc30pIiwKICAgICAgICAgICAgZiJbUHJvZ3Jlc3NdIGdhbWJhciB7ZG9uZV9pbWFnZXN9L3t0b3RhbF9pbWFnZXN9IChzaXNhIHtyZW1haW5pbmdfaW1hZ2VzfSkgfCAiCiAgICAgICAgICAgIGYidmlkZW8ge2RvbmVfdmlkZW9zfS97dG90YWxfdmlkZW9zfSAoc2lzYSB7cmVtYWluaW5nX3ZpZGVvc30pIgogICAgICAgICkpCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIFByZS1zY2FuIC0tLS0tLS0tLS0tLS0tLS0tLS0tCmZyb20gZGZyLnByZXNjYW4gaW1wb3J0IHByZXNjYW5fdGFza3MKCmRlZiBwcmVzY2FuX3Rhc2tzKCkgLT4gTGlzdFtEaWN0XToKICAgIGdsb2JhbCBFWFBFQ1RFRF9JTUFHRVMsIEVYUEVDVEVEX1ZJREVPUywgRVhQRUNURURfREFUQSwgQUxSRUFEWV9IQVZFX0lNQUdFUywgQUxSRUFEWV9IQVZFX1ZJREVPUywgQUxSRUFEWV9IQVZFX0RBVEEsIExJTktfU1VNTUFSSUVTCiAgICBMSU5LX1NVTU1BUklFUyA9IFtdCgogICAgdXJscyA9IGxpc3QoRk9MREVSX1VSTFMpCiAgICB0YXNrc19hbGw6IExpc3RbRGljdF0gPSBbXQogICAgCiAgICAjIFByZS1hdXRoZW50aWNhdGUgT05DRSBiZWZvcmUgcGFyYWxsZWwgZXhlY3V0aW9uIHRvIHByZXZlbnQgbXVsdGlwbGUgT0F1dGggZmxvd3MKICAgIHNoYXJlZF9zZXJ2aWNlLCBzaGFyZWRfY3JlZHMgPSBnZXRfc2VydmljZV9hbmRfY3JlZHMoVE9LRU5fRklMRSwgQ1JFREVOVElBTFNfRklMRSkKCiAgICBkZWYgX3NjYW5fb25lKHVybDogc3RyLCBzZXJ2aWNlKToKICAgICAgICAjIE1vZGlmeSBzaGFyZWQgY291bnRlcnMgZnJvbSB3aXRoaW4gdGhpcyB3b3JrZXIKICAgICAgICBnbG9iYWwgRVhQRUNURURfSU1BR0VTLCBFWFBFQ1RFRF9WSURFT1MsIEVYUEVDVEVEX0RBVEEsIEFMUkVBRFlfSEFWRV9JTUFHRVMsIEFMUkVBRFlfSEFWRV9WSURFT1MsIEFMUkVBRFlfSEFWRV9EQVRBLCBFWFBFQ1RFRF9UT1RBTF9CWVRFUwogICAgICAgIGxvY2FsX3Rhc2tzOiBMaXN0W0RpY3RdID0gW10KICAgICAgICBpZiBJTlRFUlJVUFRFRDoKICAgICAgICAgICAgcmV0dXJuIGxvY2FsX3Rhc2tzCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFVzZSBzaGFyZWQgc2VydmljZSAobm8gbmVlZCB0byByZS1hdXRoZW50aWNhdGUpCiAgICAgICAgICAgIHN2YyA9IHNlcnZpY2UKICAgICAgICAgICAgZm9sZGVyX2lkID0gZXh0cmFjdF9mb2xkZXJfaWQodXJsKQogICAgICAgICAgICBuYW1lLCBvayA9IHJlc29sdmVfZm9sZGVyKHN2YywgdXJsKQogICAgICAgICAgICBpZiBub3Qgb2s6CiAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxfdGFza3MKICAgICAgICAgICAgdXJsX2xhYmVsID0gc2FmZV9maWxlbmFtZSh1cmwpWzoxNjBdCiAgICAgICAgICAgIGJhc2Vfb3V0ID0gb3MucGF0aC5qb2luKE9VVFBVVF9ESVIsIHVybF9sYWJlbCk7IGVuc3VyZV9kaXIoYmFzZV9vdXQpCiAgICAgICAgICAgIHJvb3RfbmFtZSA9IG5hbWUKICAgICAgICAgICAgZm9sZGVyX291dCA9IG9zLnBhdGguam9pbihiYXNlX291dCwgcm9vdF9uYW1lKTsgZW5zdXJlX2Rpcihmb2xkZXJfb3V0KQoKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoCiAgICAgICAgICAgICAgICBmIiMgUHJlLXNjYW46IHtyb290X25hbWV9ICh7dXJsfSkgLT4gcGFyZW50IHt1cmxfbGFiZWx9IiwKICAgICAgICAgICAgICAgIGYiIyBQcmEtcGluZGFpOiB7cm9vdF9uYW1lfSAoe3VybH0pIC0+IGluZHVrIHt1cmxfbGFiZWx9IgogICAgICAgICAgICApKQoKICAgICAgICAgICAgbGlua19pbWFnZXMgPSAwOyBsaW5rX3ZpZGVvcyA9IDA7IGxpbmtfZGF0YSA9IDAKICAgICAgICAgICAgbGlua19pbWFnZXNfZXhpc3RpbmcgPSAwOyBsaW5rX3ZpZGVvc19leGlzdGluZyA9IDA7IGxpbmtfZGF0YV9leGlzdGluZyA9IDAKICAgICAgICAgICAgbGlua19pbWFnZXNfYnl0ZXMgPSAwOyBsaW5rX3ZpZGVvc19ieXRlcyA9IDA7IGxpbmtfZGF0YV9ieXRlcyA9IDAKCiAgICAgICAgICAgIGZvciBmIGluIGxpc3RfZm9sZGVyX3JlY3Vyc2l2ZShzdmMsIGZvbGRlcl9pZCwgcmVsX3BhdGg9IiIpOgogICAgICAgICAgICAgICAgaWYgSU5URVJSVVBURUQ6IGJyZWFrCiAgICAgICAgICAgICAgICBmaWQgID0gZi5nZXQoImlkIik7IG1pbWUgPSBmLmdldCgibWltZVR5cGUiLCIiKTsgZmV4dCA9IGYuZ2V0KCJmaWxlRXh0ZW5zaW9uIikKICAgICAgICAgICAgICAgIGtpbmQgPSBjbGFzc2lmeV9tZWRpYShtaW1lLCBmLmdldCgibmFtZSIsIiIpLCBmZXh0KQogICAgICAgICAgICAgICAgaWYga2luZCBpbiAoImltYWdlIiwgInZpZGVvIiwgImRhdGEiKToKICAgICAgICAgICAgICAgICAgICBmWyJfX3Jvb3RfbmFtZSJdID0gcm9vdF9uYW1lCiAgICAgICAgICAgICAgICAgICAgZlsiX19mb2xkZXJfb3V0Il0gPSBmb2xkZXJfb3V0CiAgICAgICAgICAgICAgICAgICAgcmVsID0gZi5nZXQoIl9fcmVsX3BhdGgiLCIiKQogICAgICAgICAgICAgICAgICAgIHRhcmdldF9kaXIgPSBvcy5wYXRoLmpvaW4oZm9sZGVyX291dCwgcmVsKTsgZW5zdXJlX2Rpcih0YXJnZXRfZGlyKQogICAgICAgICAgICAgICAgICAgIGJhc2UsIGV4dCA9IG9zLnBhdGguc3BsaXRleHQoZi5nZXQoIm5hbWUiLCJmaWxlIikpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBEZWJ1ZzogbG9nIGZpbGUgc2l6ZSBpbmZvCiAgICAgICAgICAgICAgICAgICAgZmlsZV9zaXplID0gZi5nZXQoInNpemUiKQogICAgICAgICAgICAgICAgICAgIGxvZ2dpbmcuZGVidWcoTCgKICAgICAgICAgICAgICAgICAgICAgICAgZiJGaWxlIHtmLmdldCgnbmFtZScsICd1bmtub3duJyl9OiBraW5kPXtraW5kfSwgc2l6ZT17ZmlsZV9zaXplfSwgZnJvbV9zaG9ydGN1dD17Zi5nZXQoJ19fZnJvbV9zaG9ydGN1dCcsIEZhbHNlKX0iLAogICAgICAgICAgICAgICAgICAgICAgICBmIkZpbGUge2YuZ2V0KCduYW1lJywgJ3Vua25vd24nKX06IGplbmlzPXtraW5kfSwgdWt1cmFuPXtmaWxlX3NpemV9LCBkYXJpX3Nob3J0Y3V0PXtmLmdldCgnX19mcm9tX3Nob3J0Y3V0JywgRmFsc2UpfSIKICAgICAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgICAgIGlmIGtpbmQgPT0gImltYWdlIjoKICAgICAgICAgICAgICAgICAgICAgICAgbGlua19pbWFnZXMgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgRVhQRUNURURfSU1BR0VTICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgRE9XTkxPQURfSU1BR0VTX09SSUdJTkFMOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0X291dCA9IGV4dCBvciAoKCIuIiArIGZleHQpIGlmIGZleHQgZWxzZSAiLmpwZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWdfdGFyZ2V0ID0gb3MucGF0aC5qb2luKHRhcmdldF9kaXIsIGYie2Jhc2V9X197ZmlkfXtleHRfb3V0fSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbWdfdGFyZ2V0ID0gb3MucGF0aC5qb2luKHRhcmdldF9kaXIsIGYie2Jhc2V9X197ZmlkfV93e0lNQUdFX1dJRFRIfS5qcGciKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhpbWdfdGFyZ2V0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQUxSRUFEWV9IQVZFX0lNQUdFUyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rX2ltYWdlc19leGlzdGluZyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF90YXNrcy5hcHBlbmQoZikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIERPV05MT0FEX0lNQUdFU19PUklHSU5BTDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN6ID0gaW50KGYuZ2V0KCJzaXplIikgb3IgMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBJZiBtaXNzaW5nLCB0cnkgdG8gZmV0Y2ggc2l6ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3o6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhID0gZ2V0X2l0ZW0oc3ZjLCBmaWQsICJzaXplIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN6ID0gaW50KG1ldGEuZ2V0KCJzaXplIikgb3IgMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua19pbWFnZXNfYnl0ZXMgKz0gc3oKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgRm9yIHRodW1ibmFpbCBkb3dubG9hZHMsIGVzdGltYXRlIHNpemUgYmFzZWQgb24gdHlwaWNhbCB0aHVtYm5haWwgc2l6ZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE1vc3QgdGh1bWJuYWlscyBhcmUgNTAtMjAwS0IgZGVwZW5kaW5nIG9uIGNvbXBsZXhpdHkgYW5kIGNvbXByZXNzaW9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFVzZSBhIGNvbnNlcnZhdGl2ZSBlc3RpbWF0ZTogMTAwS0IgcGVyIHRodW1ibmFpbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFRoaXMgZ2l2ZXMgdXNlcnMgYSByb3VnaCBpZGVhIG9mIGRhdGEgdXNhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXN0aW1hdGVkX3RodW1iX3NpemUgPSAxMDAgKiAxMDI0ICAjIDEwMEtCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtfaW1hZ2VzX2J5dGVzICs9IGVzdGltYXRlZF90aHVtYl9zaXplCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIGVsaWYga2luZCA9PSAiZGF0YSI6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtfZGF0YSArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggX0xPQ0s6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFWFBFQ1RFRF9EQVRBICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZSwgZXh0ID0gb3MucGF0aC5zcGxpdGV4dChmLmdldCgibmFtZSIsICJmaWxlIikpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAicGRmIiBpbiBtaW1lLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ID0gIi5wZGYiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmICJ0ZXh0IiBpbiBtaW1lLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ID0gIi50eHQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbGlmIGZleHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXh0ID0gZiIue2ZleHR9IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleHQgPSAiLmRhdCIKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YV90YXJnZXQgPSBvcy5wYXRoLmpvaW4odGFyZ2V0X2RpciwgZiJ7YmFzZX1fX3tmaWR9e2V4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhkYXRhX3RhcmdldCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFMUkVBRFlfSEFWRV9EQVRBICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtfZGF0YV9leGlzdGluZyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF90YXNrcy5hcHBlbmQoZikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzeiA9IGludChmLmdldCgic2l6ZSIpIG9yIDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN6OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhID0gZ2V0X2l0ZW0oc3ZjLCBmaWQsICJzaXplIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ogPSBpbnQobWV0YS5nZXQoInNpemUiKSBvciAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtfZGF0YV9ieXRlcyArPSBzegogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dpbmcuZGVidWcoTCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJDb3VsZCBub3QgZ2V0IHNpemUgZm9yIGRhdGEgZmlsZSB7ZmlkfToge2V9IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJUaWRhayBiaXNhIG1lbmRhcGF0a2FuIHVrdXJhbiB1bnR1ayBmaWxlIGRhdGEge2ZpZH06IHtlfSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApKQogICAgICAgICAgICAgICAgICAgIGVsc2U6ICAjIHZpZGVvCiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmtfdmlkZW9zICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBfTE9DSzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVYUEVDVEVEX1ZJREVPUyArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGV4dF9vdXQgPSBleHQgb3IgIi5tcDQiCiAgICAgICAgICAgICAgICAgICAgICAgIHZpZF90YXJnZXQgPSBvcy5wYXRoLmpvaW4odGFyZ2V0X2RpciwgZiJ7YmFzZX1fX3tmaWR9e2V4dF9vdXR9IikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHModmlkX3RhcmdldCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIF9MT0NLOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFMUkVBRFlfSEFWRV9WSURFT1MgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua192aWRlb3NfZXhpc3RpbmcgKz0gMQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgRE9XTkxPQURfVklERU9TOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsX3Rhc2tzLmFwcGVuZChmKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ogPSBpbnQoZi5nZXQoInNpemUiKSBvciAwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3o6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhID0gZ2V0X2l0ZW0oc3ZjLCBmaWQsICJzaXplIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN6ID0gaW50KG1ldGEuZ2V0KCJzaXplIikgb3IgMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlua192aWRlb3NfYnl0ZXMgKz0gc3oKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTG9nIHdoZW4gd2UgY2FuJ3QgZ2V0IHZpZGVvIHNpemUgZm9yIGRlYnVnZ2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmRlYnVnKEwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIkNvdWxkIG5vdCBnZXQgc2l6ZSBmb3IgdmlkZW8ge2ZpZH06IHtlfSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmIlRpZGFrIGJpc2EgbWVuZGFwYXRrYW4gdWt1cmFuIHVudHVrIHZpZGVvIHtmaWR9OiB7ZX0iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnaW5nLmV4Y2VwdGlvbihMKGYiTGlzdGluZyBmYWlsZWQgZm9yIFVSTCB7dXJsfToge2V9IiwgZiJMaXN0aW5nIGdhZ2FsIHVudHVrIFVSTCB7dXJsfToge2V9IikpCiAgICAgICAgICAgIHJldHVybiBsb2NhbF90YXNrcwoKICAgICAgICAjIExvZyBzdW1tYXJ5IHdpdGggZGF0YSBmaWxlcyBpZiBhbnkgYXJlIGZvdW5kCiAgICAgICAgaWYgbGlua19kYXRhID4gMDoKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoCiAgICAgICAgICAgICAgICBmIltDb3VudF0ge3Jvb3RfbmFtZX06IGltYWdlcz17bGlua19pbWFnZXN9IChoYXZlIHtsaW5rX2ltYWdlc19leGlzdGluZ30pIHwgIgogICAgICAgICAgICAgICAgZiJ2aWRlb3M9e2xpbmtfdmlkZW9zfSAoaGF2ZSB7bGlua192aWRlb3NfZXhpc3Rpbmd9KSB8IGRhdGE9e2xpbmtfZGF0YX0gKGhhdmUge2xpbmtfZGF0YV9leGlzdGluZ30pIiwKICAgICAgICAgICAgICAgIGYiW0p1bWxhaF0ge3Jvb3RfbmFtZX06IGdhbWJhcj17bGlua19pbWFnZXN9IChzdWRhaCB7bGlua19pbWFnZXNfZXhpc3Rpbmd9KSB8ICIKICAgICAgICAgICAgICAgIGYidmlkZW89e2xpbmtfdmlkZW9zfSAoc3VkYWgge2xpbmtfdmlkZW9zX2V4aXN0aW5nfSkgfCBkYXRhPXtsaW5rX2RhdGF9IChzdWRhaCB7bGlua19kYXRhX2V4aXN0aW5nfSkiCiAgICAgICAgICAgICkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKEwoCiAgICAgICAgICAgICAgICBmIltDb3VudF0ge3Jvb3RfbmFtZX06IGltYWdlcz17bGlua19pbWFnZXN9IChoYXZlIHtsaW5rX2ltYWdlc19leGlzdGluZ30pIHwgdmlkZW9zPXtsaW5rX3ZpZGVvc30gKGhhdmUge2xpbmtfdmlkZW9zX2V4aXN0aW5nfSkiLAogICAgICAgICAgICAgICAgZiJbSnVtbGFoXSB7cm9vdF9uYW1lfTogZ2FtYmFyPXtsaW5rX2ltYWdlc30gKHN1ZGFoIHtsaW5rX2ltYWdlc19leGlzdGluZ30pIHwgdmlkZW89e2xpbmtfdmlkZW9zfSAoc3VkYWgge2xpbmtfdmlkZW9zX2V4aXN0aW5nfSkiCiAgICAgICAgICAgICkpCiAgICAgICAgd2l0aCBfTE9DSzoKICAgICAgICAgICAgTElOS19TVU1NQVJJRVMuYXBwZW5kKHsKICAgICAgICAgICAgICAgICJyb290X25hbWUiOiByb290X25hbWUsCiAgICAgICAgICAgICAgICAiaW1hZ2VzIjogbGlua19pbWFnZXMsCiAgICAgICAgICAgICAgICAiaW1hZ2VzX2V4aXN0aW5nIjogbGlua19pbWFnZXNfZXhpc3RpbmcsCiAgICAgICAgICAgICAgICAiaW1hZ2VzX2J5dGVzIjogbGlua19pbWFnZXNfYnl0ZXMsCiAgICAgICAgICAgICAgICAidmlkZW9zIjogbGlua192aWRlb3MsCiAgICAgICAgICAgICAgICAidmlkZW9zX2V4aXN0aW5nIjogbGlua192aWRlb3NfZXhpc3RpbmcsCiAgICAgICAgICAgICAgICAidmlkZW9zX2J5dGVzIjogbGlua192aWRlb3NfYnl0ZXMsCiAgICAgICAgICAgICAgICAiZGF0YSI6IGxpbmtfZGF0YSwKICAgICAgICAgICAgICAgICJkYXRhX2V4aXN0aW5nIjogbGlua19kYXRhX2V4aXN0aW5nLAogICAgICAgICAgICAgICAgImRhdGFfYnl0ZXMiOiBsaW5rX2RhdGFfYnl0ZXMsCiAgICAgICAgICAgICAgICAidXJsIjogdXJsLAogICAgICAgICAgICB9KQogICAgICAgICAgICBFWFBFQ1RFRF9UT1RBTF9CWVRFUyArPSAobGlua19pbWFnZXNfYnl0ZXMgKyBsaW5rX3ZpZGVvc19ieXRlcyArIGxpbmtfZGF0YV9ieXRlcykKICAgICAgICBwcmludF9mb2xkZXJfc3VtbWFyeShyb290X25hbWUsIGxpbmtfaW1hZ2VzLCBsaW5rX2ltYWdlc19leGlzdGluZywgbGlua192aWRlb3MsIGxpbmtfdmlkZW9zX2V4aXN0aW5nKQogICAgICAgIHJldHVybiBsb2NhbF90YXNrcwoKICAgICMgUnVuIHNjYW5zIGluIHBhcmFsbGVsIHBlci1VUkwKICAgIGZ1dHVyZXMgPSBbXQogICAgd2l0aCBUaHJlYWRQb29sRXhlY3V0b3IobWF4X3dvcmtlcnM9bWF4KDEsIGludChDT05DVVJSRU5DWSkgaWYgc3RyKENPTkNVUlJFTkNZKS5pc2RpZ2l0KCkgZWxzZSAxKSkgYXMgZXg6CiAgICAgICAgZm9yIHVybCBpbiB1cmxzOgogICAgICAgICAgICBpZiBJTlRFUlJVUFRFRDogYnJlYWsKICAgICAgICAgICAgZnV0dXJlcy5hcHBlbmQoZXguc3VibWl0KF9zY2FuX29uZSwgdXJsLCBzaGFyZWRfc2VydmljZSkpCiAgICAgICAgZm9yIGZ1dCBpbiBhc19jb21wbGV0ZWQoZnV0dXJlcyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHRzID0gZnV0LnJlc3VsdCgpCiAgICAgICAgICAgICAgICBpZiB0czoKICAgICAgICAgICAgICAgICAgICB0YXNrc19hbGwuZXh0ZW5kKHRzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnaW5nLmV4Y2VwdGlvbihMKGYiUHJlc2NhbiB3b3JrZXIgZXJyb3I6IHtlfSIsIGYiS2VzYWxhaGFuIHByZXNjYW46IHtlfSIpKQoKICAgICMgTG9nIGZpbmFsIHByZS1zY2FuIHN1bW1hcnkgd2l0aCBkYXRhIGZpbGVzIGlmIGFueSBmb3VuZAogICAgaWYgRVhQRUNURURfREFUQSA+IDA6CiAgICAgICAgbG9nZ2luZy5pbmZvKEwoCiAgICAgICAgICAgIGYiW1ByZS1TY2FuIFN1bW1hcnldIGltYWdlcz17RVhQRUNURURfSU1BR0VTfSAoaGF2ZSB7QUxSRUFEWV9IQVZFX0lNQUdFU30pIHwgIgogICAgICAgICAgICBmInZpZGVvcz17RVhQRUNURURfVklERU9TfSAoaGF2ZSB7QUxSRUFEWV9IQVZFX1ZJREVPU30pIHwgZGF0YT17RVhQRUNURURfREFUQX0gKGhhdmUge0FMUkVBRFlfSEFWRV9EQVRBfSkiLAogICAgICAgICAgICBmIltSaW5na2FzYW4gUHJhLVBpbmRhaV0gZ2FtYmFyPXtFWFBFQ1RFRF9JTUFHRVN9IChzdWRhaCB7QUxSRUFEWV9IQVZFX0lNQUdFU30pIHwgIgogICAgICAgICAgICBmInZpZGVvPXtFWFBFQ1RFRF9WSURFT1N9IChzdWRhaCB7QUxSRUFEWV9IQVZFX1ZJREVPU30pIHwgZGF0YT17RVhQRUNURURfREFUQX0gKHN1ZGFoIHtBTFJFQURZX0hBVkVfREFUQX0pIgogICAgICAgICkpCiAgICBlbHNlOgogICAgICAgIGxvZ2dpbmcuaW5mbyhMKAogICAgICAgICAgICBmIltQcmUtU2NhbiBTdW1tYXJ5XSBpbWFnZXM9e0VYUEVDVEVEX0lNQUdFU30gKGhhdmUge0FMUkVBRFlfSEFWRV9JTUFHRVN9KSB8IHZpZGVvcz17RVhQRUNURURfVklERU9TfSAoaGF2ZSB7QUxSRUFEWV9IQVZFX1ZJREVPU30pIiwKICAgICAgICAgICAgZiJbUmluZ2thc2FuIFByYS1QaW5kYWldIGdhbWJhcj17RVhQRUNURURfSU1BR0VTfSAoc3VkYWgge0FMUkVBRFlfSEFWRV9JTUFHRVN9KSB8IHZpZGVvPXtFWFBFQ1RFRF9WSURFT1N9IChzdWRhaCB7QUxSRUFEWV9IQVZFX1ZJREVPU30pIgogICAgICAgICkpCiAgICByZXR1cm4gdGFza3NfYWxsCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIFNpbXBsZSAobm9uLXJlc3VtYWJsZSkgdmlkZW8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KZnJvbSBkZnIuZG93bmxvYWRzIGltcG9ydCBfZG93bmxvYWRfdmlkZW9fc2ltcGxlCgpkZWYgX2Rvd25sb2FkX3ZpZGVvX3NpbXBsZShzZXJ2aWNlLCBmaWxlX2lkOiBzdHIsIHRhcmdldDogc3RyKSAtPiBib29sOgogICAgcmVxID0gc2VydmljZS5maWxlcygpLmdldF9tZWRpYShmaWxlSWQ9ZmlsZV9pZCwgc3VwcG9ydHNBbGxEcml2ZXM9VHJ1ZSkKICAgIHdpdGggaW8uRmlsZUlPKHRhcmdldCwgIndiIikgYXMgZmg6CiAgICAgICAgZG93bmxvYWRlciA9IE1lZGlhSW9CYXNlRG93bmxvYWQoZmgsIHJlcSwgY2h1bmtzaXplPTEwICogMTAyNCAqIDEwMjQpCiAgICAgICAgZG9uZSA9IEZhbHNlOyBsYXN0X3BjdCA9IC0xCiAgICAgICAgd2hpbGUgbm90IGRvbmU6CiAgICAgICAgICAgIHN0YXR1cywgZG9uZSA9IGRvd25sb2FkZXIubmV4dF9jaHVuaygpCiAgICAgICAgICAgIGlmIHN0YXR1czoKICAgICAgICAgICAgICAgIHBjdCA9IGludChzdGF0dXMucHJvZ3Jlc3MoKSAqIDEwMCkKICAgICAgICAgICAgICAgIGlmIHBjdCAhPSBsYXN0X3BjdDoKICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oTChmIlZpZGVvIHtvcy5wYXRoLmJhc2VuYW1lKHRhcmdldCl9OiB7cGN0fSUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiVmlkZW8ge29zLnBhdGguYmFzZW5hbWUodGFyZ2V0KX06IHtwY3R9JSIpKQogICAgICAgICAgICAgICAgICAgIGxhc3RfcGN0ID0gcGN0CiAgICB0cnk6CiAgICAgICAgVE9UQUxTLmdyYW5kLmJ5dGVzX3dyaXR0ZW4gKz0gb3MucGF0aC5nZXRzaXplKHRhcmdldCkKICAgICAgICBsb2dnaW5nLmluZm8oZiJbQnl0ZXNdIHtUT1RBTFMuZ3JhbmQuYnl0ZXNfd3JpdHRlbn0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCiAgICByZXR1cm4gVHJ1ZQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBNYWluIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgpkZWYgbWFpbigpOgogICAgIiIiTWFpbiBlbnRyeSBwb2ludCAtIGRlbGVnYXRlIHRvIG1vZHVsYXIgZGZyLm1haW4uIiIiCiAgICBmcm9tIGRmci5tYWluIGltcG9ydCBtYWluIGFzIGRmcl9tYWluCiAgICByZXR1cm4gZGZyX21haW4oKQoKZGVmIGdldF9mYWlsZWRfaXRlbXMoKSAtPiBMaXN0W0RpY3RdOgogICAgcmV0dXJuIGxpc3QoRkFJTEVEX0lURU1TKQoKZGVmIGdldF90b3RhbHNfc25hcHNob3QoKSAtPiBEaWN0OgogICAgIiIiR2V0IHRvdGFscyBzbmFwc2hvdCAtIGRlbGVnYXRlIHRvIG1vZHVsYXIgZGZyLnV0aWxzLiIiIgogICAgZnJvbSBkZnIudXRpbHMgaW1wb3J0IGdldF90b3RhbHNfc25hcHNob3QgYXMgZGZyX2dldF90b3RhbHMKICAgIHJldHVybiBkZnJfZ2V0X3RvdGFscygpCgpkZWYgc2V0X2RpcmVjdF90YXNrcyh0YXNrczogTGlzdFtEaWN0XSk6CiAgICBnbG9iYWwgRElSRUNUX1RBU0tTCiAgICBESVJFQ1RfVEFTS1MgPSBsaXN0KHRhc2tzKQoKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIHRyeToKICAgICAgICBtYWluKCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dnaW5nLmV4Y2VwdGlvbihMKGYiRmF0YWwgZXJyb3I6IHtlfSIsIGYiS2VzYWxhaGFuIGZhdGFsOiB7ZX0iKSkKICAgICAgICBwcmludF9ncmFuZF9zdW1tYXJ5KCkKICAgICAgICBzeXMuZXhpdCgxKQAAAAAAAAAANxYAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPC/"
				],
				[
					2,
					1,
					"revert",
					null,
					"AgAAAAAAAAAAAAAAAAAAAAAAAAA9FgAAIyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwojIGRyaXZlX2ZldGNoX3Jlc2lsaWVudC5weSB2MS4xMCDigJQgMjAyNS0xMC0wMQojIE1pbmltYWwgd3JhcHBlciBmb3IgdGhlIG1vZHVsYXIgZGZyIGJhY2tlbmQgcGFja2FnZQoKaW1wb3J0IG9zLCB0aW1lLCBzaWduYWwsIGxvZ2dpbmcsIHBsYXRmb3JtCmZyb20gdHlwaW5nIGltcG9ydCBMaXN0LCBEaWN0LCBPcHRpb25hbApmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKZnJvbSBkYXRhY2xhc3NlcyBpbXBvcnQgZGF0YWNsYXNzLCBmaWVsZAoKQVBQX05BTUUgPSAiT250YWhvb2REb3dubG9hZGVyIgoKZGVmIF9kZWZhdWx0X3N1cHBvcnRfZGlyKCkgLT4gUGF0aDoKICAgIGlmIHBsYXRmb3JtLnN5c3RlbSgpID09ICJEYXJ3aW4iOiAgIyBtYWNPUwogICAgICAgIHJldHVybiBQYXRoLmhvbWUoKSAvICJMaWJyYXJ5IiAvICJBcHBsaWNhdGlvbiBTdXBwb3J0IiAvIEFQUF9OQU1FCiAgICBpZiBwbGF0Zm9ybS5zeXN0ZW0oKSA9PSAiV2luZG93cyI6CiAgICAgICAgYmFzZSA9IFBhdGgob3MuZW52aXJvbi5nZXQoIkFQUERBVEEiLCBQYXRoLmhvbWUoKSAvICJBcHBEYXRhIiAvICJSb2FtaW5nIikpCiAgICAgICAgcmV0dXJuIGJhc2UgLyBBUFBfTkFNRQogICAgIyBMaW51eCBhbmQgb3RoZXJzCiAgICByZXR1cm4gUGF0aChvcy5lbnZpcm9uLmdldCgiWERHX0NPTkZJR19IT01FIiwgUGF0aC5ob21lKCkgLyAiLmNvbmZpZyIpKSAvIEFQUF9OQU1FCgpTVVBQT1JUX0RJUiA9IF9kZWZhdWx0X3N1cHBvcnRfZGlyKCkKU1VQUE9SVF9ESVIubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBSdW50aW1lIG9wdGlvbnMgKHNoYXJlZCB3aXRoIGRmciBtb2R1bGVzKSAtLS0tLS0tLS0tLS0tLS0tLS0tLQpDUkVERU5USUFMU19GSUxFID0gb3MuZW52aXJvbi5nZXQoIkNSRURFTlRJQUxTX0ZJTEUiLCAiY3JlZGVudGlhbHMuanNvbiIpClRPS0VOX0ZJTEUgICAgICAgPSBvcy5lbnZpcm9uLmdldCgiVE9LRU5fRklMRSIsIHN0cihTVVBQT1JUX0RJUiAvICJ0b2tlbi5qc29uIikpCk9VVFBVVF9ESVIgICAgICAgPSBvcy5lbnZpcm9uLmdldCgiT1VUUFVUX0RJUiIsICIuL291dHB1dCIpCgpJTUFHRV9XSURUSCAgICAgICAgICAgICAgPSA0MDAKT1ZFUldSSVRFICAgICAgICAgICAgICAgID0gRmFsc2UKUk9CVVNUX1JFU1VNRSAgICAgICAgICAgID0gVHJ1ZQpET1dOTE9BRF9WSURFT1MgICAgICAgICAgPSBUcnVlCkRPV05MT0FEX0lNQUdFU19PUklHSU5BTCA9IEZhbHNlCkNPTlZFUlRfVEhVTUJTX0RJUiAgICAgICA9ICIiICAgIyBpZiBzZXQgdG8gYSBsb2NhbCBmb2xkZXIgcGF0aCwgY29udmVydCBtYXRjaGluZyB0aHVtYm5haWxzIHRvIG9yaWdpbmFscwpQQVVTRSAgICAgICAgICAgICAgICAgICAgPSBGYWxzZSAgIyBGbG93IGNvbnRyb2wgZm9yIEdVSQoKTE9HX0xFVkVMICAgICAgICA9ICJJTkZPIgpMT0dfRklMRU5BTUUgICAgID0gImRyaXZlX2ZldGNoLmxvZyIKTE9HX01BWF9CWVRFUyAgICA9IDEwICogMTAyNCAqIDEwMjQKTE9HX0JBQ0tVUFMgICAgICA9IDMKRk9MREVSX1VSTFM6IExpc3Rbc3RyXSA9IFtdCgojIExpbmsgc3VtbWFyaWVzIGFuZCByZXRyeSBzdXBwb3J0CkxJTktfU1VNTUFSSUVTOiBMaXN0W0RpY3RdID0gW10KRkFJTEVEX0lURU1TOiBMaXN0W0RpY3RdID0gW10KRElSRUNUX1RBU0tTOiBPcHRpb25hbFtMaXN0W0RpY3RdXSA9IE5vbmUKCkNPTkNVUlJFTkNZID0gaW50KG9zLmVudmlyb24uZ2V0KCJDT05DVVJSRU5DWSIsICIzIikpCkxBTkcgPSAiZW4iICAjIExhbmd1YWdlIGZvciBsb2dzICgiZW4iIG9yICJpZCIpCgpTQ09QRVMgPSBbImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvZHJpdmUucmVhZG9ubHkiXQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBTaGFyZWQgY291bnRlcnMvc3RhdGUgLS0tLS0tLS0tLS0tLS0tLS0tLS0KCkBkYXRhY2xhc3MKY2xhc3MgQ291bnRlcnM6CiAgICBzY2FubmVkOiBpbnQgPSAwCiAgICBpbWFnZXNfZG9uZTogaW50ID0gMAogICAgaW1hZ2VzX3NraXBwZWQ6IGludCA9IDAKICAgIGltYWdlc19mYWlsZWQ6IGludCA9IDAKICAgIHZpZGVvc19kb25lOiBpbnQgPSAwCiAgICB2aWRlb3Nfc2tpcHBlZDogaW50ID0gMAogICAgdmlkZW9zX2ZhaWxlZDogaW50ID0gMAogICAgZGF0YV9kb25lOiBpbnQgPSAwCiAgICBkYXRhX3NraXBwZWQ6IGludCA9IDAKICAgIGRhdGFfZmFpbGVkOiBpbnQgPSAwCiAgICBieXRlc193cml0dGVuOiBpbnQgPSAwCgpAZGF0YWNsYXNzCmNsYXNzIFRvdGFsczoKICAgIGdyYW5kOiBDb3VudGVycyA9IGZpZWxkKGRlZmF1bHRfZmFjdG9yeT1Db3VudGVycykKICAgIHBlcl9mb2xkZXI6IERpY3Rbc3RyLCBDb3VudGVyc10gPSBmaWVsZChkZWZhdWx0X2ZhY3Rvcnk9ZGljdCkKICAgIGRlZiBmb2xkZXIoc2VsZiwga2V5OiBzdHIpIC0+IENvdW50ZXJzOgogICAgICAgIGlmIGtleSBub3QgaW4gc2VsZi5wZXJfZm9sZGVyOgogICAgICAgICAgICBzZWxmLnBlcl9mb2xkZXJba2V5XSA9IENvdW50ZXJzKCkKICAgICAgICByZXR1cm4gc2VsZi5wZXJfZm9sZGVyW2tleV0KClRPVEFMUyA9IFRvdGFscygpClNUQVJUX1RTID0gdGltZS50aW1lKCkKSU5URVJSVVBURUQgPSBGYWxzZQpFWFBFQ1RFRF9JTUFHRVMgPSAwCkVYUEVDVEVEX1ZJREVPUyA9IDAKRVhQRUNURURfREFUQSA9IDAKQUxSRUFEWV9IQVZFX0lNQUdFUyA9IDAKQUxSRUFEWV9IQVZFX1ZJREVPUyA9IDAKQUxSRUFEWV9IQVZFX0RBVEEgPSAwCkVYUEVDVEVEX1RPVEFMX0JZVEVTID0gMApJTkNPTVBMRVRFX1RBUkdFVFMgPSBzZXQoKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBpMThuIGhlbHBlciAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKZGVmIEwoZW46IHN0ciwgaWRfOiBzdHIpIC0+IHN0cjoKICAgICIiIlJldHVybiBFbmdsaXNoIG9yIEluZG9uZXNpYW4gc3RyaW5nIGJhc2VkIG9uIExBTkcuIiIiCiAgICByZXR1cm4gZW4gaWYgKExBTkcgb3IgImVuIikubG93ZXIoKS5zdGFydHN3aXRoKCJlbiIpIGVsc2UgaWRfCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIFNpZ25hbCBoYW5kbGluZyAtLS0tLS0tLS0tLS0tLS0tLS0tLQoKZGVmIG9uX3NpZ2ludChfc2lnLCBfZnJhbWUpOgogICAgZ2xvYmFsIElOVEVSUlVQVEVECiAgICBJTlRFUlJVUFRFRCA9IFRydWUKICAgIGxvZ2dpbmcud2FybmluZyhMKAogICAgICAgICJSZWNlaXZlZCBpbnRlcnJ1cHQgc2lnbmFsIOKAlCBmaW5pc2hpbmcgY3VycmVudCBzdGVwIGFuZCBzdW1tYXJpemluZy4uLiIsCiAgICAgICAgIk1lbmVyaW1hIHNpbnlhbCBpbnRlcnVwc2kg4oCUIG1lbnllbGVzYWlrYW4gbGFuZ2thaCBzYWF0IGluaSBsYWx1IG1lcmluZ2thcy4uLiIKICAgICkpCgpzaWduYWwuc2lnbmFsKHNpZ25hbC5TSUdJTlQsIG9uX3NpZ2ludCkKCmRlZiByZXNldF9jb3VudGVycygpOgogICAgIiIiUmVzZXQgYWxsIGdsb2JhbCBjb3VudGVycyBhbmQgc3RhdGUuIiIiCiAgICBnbG9iYWwgVE9UQUxTLCBFWFBFQ1RFRF9JTUFHRVMsIEVYUEVDVEVEX1ZJREVPUywgRVhQRUNURURfREFUQQogICAgZ2xvYmFsIEFMUkVBRFlfSEFWRV9JTUFHRVMsIEFMUkVBRFlfSEFWRV9WSURFT1MsIEFMUkVBRFlfSEFWRV9EQVRBICAKICAgIGdsb2JhbCBTVEFSVF9UUywgSU5URVJSVVBURUQsIExJTktfU1VNTUFSSUVTLCBGQUlMRURfSVRFTVMsIEVYUEVDVEVEX1RPVEFMX0JZVEVTCiAgICBUT1RBTFMgPSBUb3RhbHMoKQogICAgRVhQRUNURURfSU1BR0VTID0gMAogICAgRVhQRUNURURfVklERU9TID0gMAogICAgRVhQRUNURURfREFUQSA9IDAKICAgIEFMUkVBRFlfSEFWRV9JTUFHRVMgPSAwCiAgICBBTFJFQURZX0hBVkVfVklERU9TID0gMAogICAgQUxSRUFEWV9IQVZFX0RBVEEgPSAwCiAgICBFWFBFQ1RFRF9UT1RBTF9CWVRFUyA9IDAKICAgIFNUQVJUX1RTID0gdGltZS50aW1lKCkKICAgIElOVEVSUlVQVEVEID0gRmFsc2UKICAgIExJTktfU1VNTUFSSUVTID0gW10KICAgIEZBSUxFRF9JVEVNUyA9IFtdCgojIC0tLS0tLS0tLS0tLS0tLS0tLS0tIE1haW4gZW50cnkgcG9pbnRzIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgpkZWYgbWFpbigpOgogICAgIiIiTWFpbiBlbnRyeSBwb2ludCAtIGRlbGVnYXRlIHRvIG1vZHVsYXIgZGZyLm1haW4uIiIiCiAgICBmcm9tIGRmci5tYWluIGltcG9ydCBtYWluIGFzIGRmcl9tYWluCiAgICByZXR1cm4gZGZyX21haW4oKQoKZGVmIGdldF90b3RhbHNfc25hcHNob3QoKSAtPiBEaWN0OgogICAgIiIiR2V0IHRvdGFscyBzbmFwc2hvdCAtIGRlbGVnYXRlIHRvIG1vZHVsYXIgZGZyLnV0aWxzLiIiIgogICAgZnJvbSBkZnIudXRpbHMgaW1wb3J0IGdldF90b3RhbHNfc25hcHNob3QgYXMgZGZyX2dldF90b3RhbHMKICAgIHJldHVybiBkZnJfZ2V0X3RvdGFscygpCgpkZWYgZ2V0X2ZhaWxlZF9pdGVtcygpIC0+IExpc3RbRGljdF06CiAgICAiIiJHZXQgbGlzdCBvZiBmYWlsZWQgZG93bmxvYWQgaXRlbXMuIiIiCiAgICByZXR1cm4gbGlzdChGQUlMRURfSVRFTVMpCgpkZWYgc2V0X2RpcmVjdF90YXNrcyh0YXNrczogTGlzdFtEaWN0XSk6CiAgICAiIiJTZXQgZGlyZWN0IHRhc2tzIGxpc3QgZm9yIHJldHJ5IGZ1bmN0aW9uYWxpdHkuIiIiCiAgICBnbG9iYWwgRElSRUNUX1RBU0tTCiAgICBESVJFQ1RfVEFTS1MgPSBsaXN0KHRhc2tzKQoKIyAtLS0tLS0tLS0tLS0tLS0tLS0tLSBSZS1leHBvcnQga2V5IGZ1bmN0aW9ucyBmcm9tIGRmciBtb2R1bGVzIC0tLS0tLS0tLS0tLS0tLS0tLS0tCgojIEF1dGggZnVuY3Rpb25zCmZyb20gZGZyLmF1dGggaW1wb3J0IGdldF9zZXJ2aWNlX2FuZF9jcmVkcywgZ2V0X3NlcnZpY2VfaWZfdG9rZW5fdmFsaWQsIGdldF9hY2NvdW50X2luZm8sIHRyeV9nZXRfYWNjb3VudF9pbmZvCgojIFV0aWxpdHkgZnVuY3Rpb25zICAKZnJvbSBkZnIudXRpbHMgaW1wb3J0IGh1bWFuX2J5dGVzLCBlbGFwc2VkLCBleHRyYWN0X2ZvbGRlcl9pZCwgc2FmZV9maWxlbmFtZSwgZW5zdXJlX2RpciwgYmFja29mZl9zbGVlcCwgY2xhc3NpZnlfbWVkaWEKCiMgUHJvY2Vzc2luZyBmdW5jdGlvbnMKZnJvbSBkZnIucHJvY2VzcyBpbXBvcnQgcHJvY2Vzc19maWxlLCBwcmludF9mb2xkZXJfc3VtbWFyeSwgcHJpbnRfZ3JhbmRfc3VtbWFyeSwgcHJpbnRfcHJvZ3Jlc3MKCiMgTGlzdGluZyBmdW5jdGlvbnMKZnJvbSBkZnIubGlzdGluZyBpbXBvcnQgcmVzb2x2ZV9mb2xkZXIsIHdhaXRfaWZfcGF1c2VkLCBsaXN0X2ZvbGRlcl9yZWN1cnNpdmUsIGdldF9pdGVtLCBnYXBpX2V4ZWN1dGVfd2l0aF9yZXRyeQoKIyBEb3dubG9hZCBmdW5jdGlvbnMKZnJvbSBkZnIuZG93bmxvYWRzIGltcG9ydCBjbGVhbnVwX2luY29tcGxldGVfdGFyZ2V0cywgZG93bmxvYWRfdGh1bWJuYWlsLCBkb3dubG9hZF9maWxlX3Jlc3VtYWJsZSwgZG93bmxvYWRfdmlkZW9fcmVzdW1hYmxlCgojIFByZS1zY2FuIGZ1bmN0aW9ucwpmcm9tIGRmci5wcmVzY2FuIGltcG9ydCBwcmVzY2FuX3Rhc2tzCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgdHJ5OgogICAgICAgIG1haW4oKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGxvZ2dpbmcuZXhjZXB0aW9uKEwoZiJGYXRhbCBlcnJvcjoge2V9IiwgZiJLZXNhbGFoYW4gZmF0YWw6IHtlfSIpKQogICAgICAgIHByaW50X2dyYW5kX3N1bW1hcnkoKQogICAgICAgIGV4aXQoMSkAAAAAAAAAAH0WAAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPC/"
				]
			]
		},
		{
			"file": "gui/main_app.py",
			"settings":
			{
				"buffer_size": 36188,
				"line_ending": "Unix"
			},
			"undo_stack":
			[
				[
					2,
					1,
					"revert",
					null,
					"AgAAAAAAAAAAAAAAAAAAAAAAAAB/UgAAIiIiCk1haW4gYXBwbGljYXRpb24gY2xhc3MgZm9yIHRoZSBvbnRhaG9vZC1kb3dubG9hZGVyIEdVSS4KIiIiCgppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHNpZ25hbAppbXBvcnQgc3lzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHRraW50ZXIgYXMgdGsKZnJvbSB0a2ludGVyIGltcG9ydCB0dGssIHNjcm9sbGVkdGV4dCwgZmlsZWRpYWxvZywgbWVzc2FnZWJveApmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwKCmltcG9ydCBkcml2ZV9mZXRjaF9yZXNpbGllbnQgYXMgZGZyCgpmcm9tIC5jb25maWcgaW1wb3J0IERFRkFVTFRfVVJMUwpmcm9tIC5pMThuIGltcG9ydCBUCmZyb20gLmxvZ19oYW5kbGVyIGltcG9ydCBUa0xvZ0hhbmRsZXIKZnJvbSAucHJlZmVyZW5jZXMgaW1wb3J0IFByZWZlcmVuY2VzTWFuYWdlcgpmcm9tIC51dGlscyBpbXBvcnQgbG9jYXRlX2NyZWRlbnRpYWxzLCB2YWxpZGF0ZV9pbWFnZV9zaXplCmZyb20gLndvcmtlcnMgaW1wb3J0IHJ1bl93b3JrZXIsIHJ1bl9jb252ZXJ0ZXIsIHN0YXJ0X3dvcmtlcl90aHJlYWQKCgpjbGFzcyBBcHAodGsuVGspOgogICAgIiIiTWFpbiBhcHBsaWNhdGlvbiB3aW5kb3cuIiIiCiAgICAKICAgIFNJWkVfT1BUSU9OUyA9IFsKICAgICAgICAiNDAwICh0aHVtYm5haWwpIiwKICAgICAgICAiNzAwICh0aHVtYm5haWwpIiwgCiAgICAgICAgIjEwMjQgKHRodW1ibmFpbCkiLAogICAgICAgICIxNjAwICh0aHVtYm5haWwpIiwKICAgICAgICAiMjQwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjMyMDAgKHRodW1ibmFpbCkiLAogICAgICAgICI0ODAwICh0aHVtYm5haWwpIiwKICAgICAgICAiNjAwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIk9SSUdJTkFMIChmdWxsIHNpemUpIiwKICAgIF0KICAgIAogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKQogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBzdGF0ZQogICAgICAgIHNlbGYuX2xvYWRpbmdfcHJlZnMgPSBUcnVlCiAgICAgICAgc2VsZi5fZ2VvbV9zYXZlX2pvYiA9IE5vbmUKICAgICAgICBzZWxmLmxhbmcgPSAiZW4iCiAgICAgICAgc2VsZi5leHBlY3RlZF9ieXRlc190b3RhbCA9IDAKICAgICAgICBzZWxmLmJ5dGVzX3dyaXR0ZW4gPSAwCiAgICAgICAgCiAgICAgICAgIyBJbml0aWFsaXplIHByZWZlcmVuY2VzIG1hbmFnZXIKICAgICAgICBzZWxmLnByZWZzX21hbmFnZXIgPSBQcmVmZXJlbmNlc01hbmFnZXIoKQogICAgICAgIAogICAgICAgICMgU2V0IHVwIHdpbmRvdwogICAgICAgIHNlbGYudGl0bGUoVChzZWxmLmxhbmcsICJhcHBfdGl0bGUiKSkKICAgICAgICBzZWxmLmdlb21ldHJ5KCI5ODB4OTUwIikKICAgICAgICBzZWxmLm1pbnNpemUoODIwLCA3NjApCiAgICAgICAgCiAgICAgICAgIyBDcmVhdGUgVUkgY29tcG9uZW50cwogICAgICAgIHNlbGYuX2NyZWF0ZV91aSgpCiAgICAgICAgCiAgICAgICAgIyBMb2FkIHByZWZlcmVuY2VzIGFuZCBhcHBseSBsYW5ndWFnZQogICAgICAgIHNlbGYuX2xvYWRfcHJlZmVyZW5jZXMoKQogICAgICAgIHNlbGYuYXBwbHlfaTE4bigpCiAgICAgICAgCiAgICAgICAgIyBTZXQgdXAgZXZlbnQgaGFuZGxlcnMKICAgICAgICBzZWxmLl9zZXR1cF9ldmVudF9oYW5kbGVycygpCiAgICAgICAgCiAgICAgICAgIyBDaGVjayBhY2NvdW50IHN0YXR1cyBpbiBiYWNrZ3JvdW5kCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5fY2hlY2tfYWNjb3VudF9hc3luYywgZGFlbW9uPVRydWUpLnN0YXJ0KCkKICAgICAgICAKICAgICAgICAjIERvbmUgbG9hZGluZwogICAgICAgIHNlbGYuX2xvYWRpbmdfcHJlZnMgPSBGYWxzZQogICAgCiAgICBkZWYgX2NyZWF0ZV91aShzZWxmKToKICAgICAgICAiIiJDcmVhdGUgdGhlIG1haW4gVUkgY29tcG9uZW50cy4iIiIKICAgICAgICAjIFRvcCBiYXIgd2l0aCBsYW5ndWFnZSBhbmQgYWNjb3VudAogICAgICAgIHNlbGYuX2NyZWF0ZV90b3BfYmFyKCkKICAgICAgICAKICAgICAgICAjIE1haW4gaW50cm8gdGV4dAogICAgICAgIHNlbGYuaW50cm9fbGFiZWwgPSB0dGsuTGFiZWwoc2VsZiwgd3JhcGxlbmd0aD05NDAsIGp1c3RpZnk9ImxlZnQiKQogICAgICAgIHNlbGYuaW50cm9fbGFiZWwucGFjayhhbmNob3I9InciLCBwYWR4PTEyLCBwYWR5PSgxMiwgNikpCiAgICAgICAgCiAgICAgICAgIyBEb3dubG9hZGVyIHNlY3Rpb24KICAgICAgICBzZWxmLl9jcmVhdGVfZG93bmxvYWRlcl9zZWN0aW9uKCkKICAgICAgICAKICAgICAgICAjIFNlcGFyYXRvcgogICAgICAgIHNlcCA9IHR0ay5TZXBhcmF0b3Ioc2VsZiwgb3JpZW50PSJob3Jpem9udGFsIikKICAgICAgICBzZXAucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oNiwgOCkpCiAgICAgICAgCiAgICAgICAgIyBDb252ZXJ0ZXIgc2VjdGlvbgogICAgICAgIHNlbGYuX2NyZWF0ZV9jb252ZXJ0ZXJfc2VjdGlvbigpCiAgICAgICAgCiAgICAgICAgIyBMb2dzIGFuZCBwcm9ncmVzcyBzZWN0aW9uCiAgICAgICAgc2VsZi5fY3JlYXRlX2xvZ3Nfc2VjdGlvbigpCiAgICAgICAgc2VsZi5fY3JlYXRlX3Byb2dyZXNzX3NlY3Rpb24oKQogICAgCiAgICBkZWYgX2NyZWF0ZV90b3BfYmFyKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSB0aGUgdG9wIGJhciB3aXRoIGxhbmd1YWdlIHNlbGVjdG9yIGFuZCBhY2NvdW50IGluZm8uIiIiCiAgICAgICAgdG9wYmFyID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgdG9wYmFyLnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDEwLCAwKSkKICAgICAgICAKICAgICAgICAjIExhbmd1YWdlIHNlbGVjdG9yCiAgICAgICAgdHRrLkxhYmVsKHRvcGJhciwgdGV4dD1UKHNlbGYubGFuZywgImxhbmd1YWdlIikpLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgc2VsZi5sYW5nX3ZhciA9IHRrLlN0cmluZ1Zhcih2YWx1ZT1UKHNlbGYubGFuZywgImxhbmdfZW4iKSkKICAgICAgICBzZWxmLmxhbmdfYm94ID0gdHRrLkNvbWJvYm94KAogICAgICAgICAgICB0b3BiYXIsIHRleHR2YXJpYWJsZT1zZWxmLmxhbmdfdmFyLAogICAgICAgICAgICB2YWx1ZXM9W1QoImVuIiwgImxhbmdfZW4iKSwgVCgiaWQiLCAibGFuZ19pZCIpXSwgCiAgICAgICAgICAgIHdpZHRoPTIyLCBzdGF0ZT0icmVhZG9ubHkiCiAgICAgICAgKQogICAgICAgIHNlbGYubGFuZ19ib3gucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0oOCwgMCkpCiAgICAgICAgc2VsZi5sYW5nX2JveC5iaW5kKCI8PENvbWJvYm94U2VsZWN0ZWQ+PiIsIHNlbGYuX29uX2xhbmdfY2hhbmdlKQogICAgICAgIAogICAgICAgICMgQWNjb3VudCBpbmZvCiAgICAgICAgc2VsZi5hY2N0X3ZhciA9IHRrLlN0cmluZ1Zhcih2YWx1ZT0iQWNjb3VudDogKG5vdCBzaWduZWQgaW4pIikKICAgICAgICBzZWxmLmFjY3RfbGFiZWwgPSB0dGsuTGFiZWwodG9wYmFyLCB0ZXh0dmFyaWFibGU9c2VsZi5hY2N0X3ZhcikKICAgICAgICBzZWxmLmFjY3RfbGFiZWwucGFjayhzaWRlPSJyaWdodCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5hdXRoX2J0biA9IHR0ay5CdXR0b24odG9wYmFyLCB0ZXh0PSJTaWduIGluIiwgY29tbWFuZD1zZWxmLnNpZ25faW4pCiAgICAgICAgc2VsZi5hdXRoX2J0bi5wYWNrKHNpZGU9InJpZ2h0IiwgcGFkeD0oMCwgOCkpCiAgICAKICAgIGRlZiBfY3JlYXRlX2Rvd25sb2FkZXJfc2VjdGlvbihzZWxmKToKICAgICAgICAiIiJDcmVhdGUgdGhlIG1haW4gZG93bmxvYWRlciBzZWN0aW9uLiIiIgogICAgICAgICMgVVJMcyBpbnB1dAogICAgICAgIHNlbGYudXJsc19sYWJlbCA9IHR0ay5MYWJlbChzZWxmKQogICAgICAgIHNlbGYudXJsc19sYWJlbC5wYWNrKGFuY2hvcj0idyIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgc2VsZi51cmxib3ggPSBzY3JvbGxlZHRleHQuU2Nyb2xsZWRUZXh0KHNlbGYsIGhlaWdodD02KQogICAgICAgIHNlbGYudXJsYm94Lmluc2VydCgiMS4wIiwgIlxuIi5qb2luKERFRkFVTFRfVVJMUykgKyAiXG4iKQogICAgICAgIHNlbGYudXJsYm94LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgIyBPdXRwdXQgZGlyZWN0b3J5IHNlbGVjdGlvbgogICAgICAgIG91dF9yb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBvdXRfcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgc2VsZi5vdXRfbGFiZWwgPSB0dGsuTGFiZWwob3V0X3JvdykKICAgICAgICBzZWxmLm91dF9sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYub3V0dmFyID0gdGsuU3RyaW5nVmFyKCkKICAgICAgICBzZWxmLm91dF9lbnRyeSA9IHR0ay5FbnRyeShvdXRfcm93LCB0ZXh0dmFyaWFibGU9c2VsZi5vdXR2YXIpCiAgICAgICAgc2VsZi5vdXRfZW50cnkucGFjayhzaWRlPSJsZWZ0IiwgZmlsbD0ieCIsIGV4cGFuZD1UcnVlLCBwYWR4PTgpCiAgICAgICAgCiAgICAgICAgc2VsZi5jaG9vc2VfYnRuID0gdHRrLkJ1dHRvbihvdXRfcm93LCBjb21tYW5kPXNlbGYucGlja19vdXQpCiAgICAgICAgc2VsZi5jaG9vc2VfYnRuLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgIyBJbWFnZSBtb2RlIHNlbGVjdGlvbgogICAgICAgIG1vZGVfcm93ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgbW9kZV9yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMikKICAgICAgICAKICAgICAgICBzZWxmLm1vZGVfbGFiZWwgPSB0dGsuTGFiZWwobW9kZV9yb3cpCiAgICAgICAgc2VsZi5tb2RlX2xhYmVsLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5zaXpldmFyID0gdGsuU3RyaW5nVmFyKHZhbHVlPXNlbGYuU0laRV9PUFRJT05TWzFdKQogICAgICAgIHR0ay5Db21ib2JveCgKICAgICAgICAgICAgbW9kZV9yb3csIHRleHR2YXJpYWJsZT1zZWxmLnNpemV2YXIsIAogICAgICAgICAgICB2YWx1ZXM9c2VsZi5TSVpFX09QVElPTlMsIHdpZHRoPTI4LCBzdGF0ZT0icmVhZG9ubHkiCiAgICAgICAgKS5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PTgpCiAgICAgICAgCiAgICAgICAgc2VsZi5tb2RlX2hpbnQgPSB0dGsuTGFiZWwobW9kZV9yb3cpCiAgICAgICAgc2VsZi5tb2RlX2hpbnQucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0xMikKICAgICAgICAKICAgICAgICAjIFZpZGVvIGRvd25sb2FkIG9wdGlvbgogICAgICAgIHZpZGVvX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIHZpZGVvX3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgwLCAxMCkpCiAgICAgICAgCiAgICAgICAgc2VsZi52aWRlb3NfdmFyID0gdGsuQm9vbGVhblZhcih2YWx1ZT1UcnVlKQogICAgICAgIHNlbGYudmlkZW9zX2NoZWNrID0gdHRrLkNoZWNrYnV0dG9uKHZpZGVvX3JvdywgdmFyaWFibGU9c2VsZi52aWRlb3NfdmFyKQogICAgICAgIHNlbGYudmlkZW9zX2NoZWNrLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgIyBDb250cm9sIGJ1dHRvbnMKICAgICAgICBidG5fcm93ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgYnRuX3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgyLCAxMCkpCiAgICAgICAgCiAgICAgICAgc2VsZi5zdGFydF9idG4gPSB0dGsuQnV0dG9uKGJ0bl9yb3csIGNvbW1hbmQ9c2VsZi5zdGFydCkKICAgICAgICBzZWxmLnN0YXJ0X2J0bi5wYWNrKHNpZGU9InJpZ2h0IikKICAgICAgICAKICAgICAgICBzZWxmLmNhbmNlbF9idG4gPSB0dGsuQnV0dG9uKAogICAgICAgICAgICBidG5fcm93LCB0ZXh0PSJDYW5jZWwiLCBjb21tYW5kPXNlbGYuY2FuY2VsLCBzdGF0ZT0iZGlzYWJsZWQiCiAgICAgICAgKQogICAgICAgIHNlbGYuY2FuY2VsX2J0bi5wYWNrKHNpZGU9ImxlZnQiKQogICAgCiAgICBkZWYgX2NyZWF0ZV9jb252ZXJ0ZXJfc2VjdGlvbihzZWxmKToKICAgICAgICAiIiJDcmVhdGUgdGhlIHRodW1ibmFpbCBjb252ZXJ0ZXIgc2VjdGlvbi4iIiIKICAgICAgICAjIFNlY3Rpb24gdGl0bGUgYW5kIHN1YnRpdGxlCiAgICAgICAgY29udl9ib3ggPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBjb252X2JveC5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSg0LCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfdGl0bGUgPSB0dGsuTGFiZWwoY29udl9ib3gsIGZvbnQ9KCJUa0RlZmF1bHRGb250IiwgMTEsICJib2xkIikpCiAgICAgICAgc2VsZi5jb252X3RpdGxlLnBhY2soYW5jaG9yPSJ3IikKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfc3VidGl0bGUgPSB0dGsuTGFiZWwoY29udl9ib3gsIHdyYXBsZW5ndGg9OTQwLCBqdXN0aWZ5PSJsZWZ0IikKICAgICAgICBzZWxmLmNvbnZfc3VidGl0bGUucGFjayhhbmNob3I9InciLCBwYWR5PSg0LCA4KSkKICAgICAgICAKICAgICAgICAjIERpcmVjdG9yeSBzZWxlY3Rpb24KICAgICAgICBjb252X3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIGNvbnZfcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDAsIDQpKQogICAgICAgIAogICAgICAgIHNlbGYuY29udl9waWNrX2xhYmVsID0gdHRrLkxhYmVsKGNvbnZfcm93KQogICAgICAgIHNlbGYuY29udl9waWNrX2xhYmVsLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5jb252X2Rpcl92YXIgPSB0ay5TdHJpbmdWYXIoKQogICAgICAgIHNlbGYuY29udl9kaXJfZW50cnkgPSB0dGsuRW50cnkoY29udl9yb3csIHRleHR2YXJpYWJsZT1zZWxmLmNvbnZfZGlyX3ZhcikKICAgICAgICBzZWxmLmNvbnZfZGlyX2VudHJ5LnBhY2soc2lkZT0ibGVmdCIsIGZpbGw9IngiLCBleHBhbmQ9VHJ1ZSwgcGFkeD04KQogICAgICAgIAogICAgICAgIHNlbGYuY29udl9jaG9vc2VfYnRuID0gdHRrLkJ1dHRvbihjb252X3JvdywgY29tbWFuZD1zZWxmLnBpY2tfY29udl9kaXIpCiAgICAgICAgc2VsZi5jb252X2Nob29zZV9idG4ucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICAjIENvbnZlcnQgYnV0dG9uCiAgICAgICAgY29udl9idG5fcm93ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgY29udl9idG5fcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDQsIDgpKQogICAgICAgIAogICAgICAgIHNlbGYuY29udl9zdGFydF9idG4gPSB0dGsuQnV0dG9uKGNvbnZfYnRuX3JvdywgY29tbWFuZD1zZWxmLnN0YXJ0X2NvbnZlcnRlcikKICAgICAgICBzZWxmLmNvbnZfc3RhcnRfYnRuLnBhY2soc2lkZT0icmlnaHQiKQogICAgCiAgICBkZWYgX2NyZWF0ZV9sb2dzX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBsb2dzIHNlY3Rpb24uIiIiCiAgICAgICAgc2VsZi5sb2dfdGl0bGUgPSB0dGsuTGFiZWwoc2VsZikKICAgICAgICBzZWxmLmxvZ190aXRsZS5wYWNrKGFuY2hvcj0idyIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2dzID0gc2Nyb2xsZWR0ZXh0LlNjcm9sbGVkVGV4dChzZWxmLCBoZWlnaHQ9MTYsIHN0YXRlPSJkaXNhYmxlZCIpCiAgICAgICAgc2VsZi5sb2dzLnBhY2soZmlsbD0iYm90aCIsIGV4cGFuZD1UcnVlLCBwYWR4PTEyLCBwYWR5PSgwLCAxMCkpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2dfaGFuZGxlciA9IFRrTG9nSGFuZGxlcihzZWxmLmxvZ3MpCiAgICAgICAgc2VsZi5sb2dfaGFuZGxlci5wdXQoIjIwMjUtMTAtMDIgMDA6MDA6MDAgfCBJTkZPICAgIHwgW0dVSV0gQXBwbGljYXRpb24gc3RhcnRlZCAtIGxvZ2dpbmcgc3lzdGVtIGFjdGl2ZSIpCiAgICAKICAgIGRlZiBfY3JlYXRlX3Byb2dyZXNzX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBwcm9ncmVzcyBiYXJzIHNlY3Rpb24uIiIiCiAgICAgICAgcHJvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIHByb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMCwgMTIpKQogICAgICAgIAogICAgICAgICMgSW1hZ2VzIHByb2dyZXNzCiAgICAgICAgaW1nX2ZyYW1lID0gdHRrLkZyYW1lKHByb3cpCiAgICAgICAgaW1nX2ZyYW1lLnBhY2soZmlsbD0ieCIsIHBhZHk9KDAsIDYpKQogICAgICAgIAogICAgICAgIHNlbGYuaW1hZ2VzX2xhYmVsID0gdHRrLkxhYmVsKGltZ19mcmFtZSkKICAgICAgICBzZWxmLmltYWdlc19sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzID0gdHRrLlByb2dyZXNzYmFyKGltZ19mcmFtZSwgbGVuZ3RoPTUyMCwgbW9kZT0iZGV0ZXJtaW5hdGUiKQogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzLnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9KDgsIDgpKQogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzX3ZhbHVlID0gdHRrLkxhYmVsKGltZ19mcmFtZSwgdGV4dD0iMC8wIikKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc192YWx1ZS5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgICMgVmlkZW9zIHByb2dyZXNzCiAgICAgICAgdmlkX2ZyYW1lID0gdHRrLkZyYW1lKHByb3cpCiAgICAgICAgdmlkX2ZyYW1lLnBhY2soZmlsbD0ieCIsIHBhZHk9KDAsIDYpKQogICAgICAgIAogICAgICAgIHNlbGYudmlkZW9zX2xhYmVsID0gdHRrLkxhYmVsKHZpZF9mcmFtZSkKICAgICAgICBzZWxmLnZpZGVvc19sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zID0gdHRrLlByb2dyZXNzYmFyKHZpZF9mcmFtZSwgbGVuZ3RoPTUyMCwgbW9kZT0iZGV0ZXJtaW5hdGUiKQogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zLnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9KDgsIDgpKQogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zX3ZhbHVlID0gdHRrLkxhYmVsKHZpZF9mcmFtZSwgdGV4dD0iMC8wIikKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc192YWx1ZS5wYWNrKHNpZGU9ImxlZnQiKQogICAgCiAgICBkZWYgX3NldHVwX2V2ZW50X2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIlNldCB1cCBldmVudCBoYW5kbGVycyBhbmQgYmluZGluZ3MuIiIiCiAgICAgICAgIyBWYXJpYWJsZSBjaGFuZ2UgdHJhY2tpbmcgZm9yIGF1dG8tc2F2ZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5vdXR2YXIudHJhY2VfYWRkKCd3cml0ZScsIHNlbGYuX29uX3Zhcl9jaGFuZ2VkKQogICAgICAgICAgICBzZWxmLnNpemV2YXIudHJhY2VfYWRkKCd3cml0ZScsIHNlbGYuX29uX3Zhcl9jaGFuZ2VkKSAKICAgICAgICAgICAgc2VsZi52aWRlb3NfdmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkKICAgICAgICAgICAgc2VsZi5jb252X2Rpcl92YXIudHJhY2VfYWRkKCd3cml0ZScsIHNlbGYuX29uX3Zhcl9jaGFuZ2VkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFVSTCBib3ggbW9kaWZpY2F0aW9uIHRyYWNraW5nCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnVybGJveC5iaW5kKCc8PE1vZGlmaWVkPj4nLCBzZWxmLl9vbl91cmxib3hfbW9kaWZpZWQpCiAgICAgICAgICAgIHNlbGYudXJsYm94LmVkaXRfbW9kaWZpZWQoRmFsc2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgICMgV2luZG93IGdlb21ldHJ5IGNoYW5nZXMKICAgICAgICBzZWxmLmJpbmQoJzxDb25maWd1cmU+Jywgc2VsZi5fb25fY29uZmlndXJlKQogICAgICAgIAogICAgICAgICMgV2luZG93IGNsb3NlIGhhbmRsZXIKICAgICAgICBzZWxmLnByb3RvY29sKCJXTV9ERUxFVEVfV0lORE9XIiwgc2VsZi5fb25fY2xvc2UpCiAgICAgICAgCiAgICAgICAgIyBTaWduYWwgaGFuZGxlcnMgZm9yIGdyYWNlZnVsIHNodXRkb3duCiAgICAgICAgc2VsZi5faW5zdGFsbF9zaWduYWxfaGFuZGxlcnMoKQogICAgCiAgICBkZWYgX2xvYWRfcHJlZmVyZW5jZXMoc2VsZik6CiAgICAgICAgIiIiTG9hZCB1c2VyIHByZWZlcmVuY2VzLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJlZnMgPSBzZWxmLnByZWZzX21hbmFnZXIubG9hZF9wcmVmZXJlbmNlcygpCiAgICAgICAgICAgIHByZWZzID0gc2VsZi5wcmVmc19tYW5hZ2VyLnZhbGlkYXRlX3ByZWZlcmVuY2VzKHByZWZzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBBcHBseSBwcmVmZXJlbmNlcwogICAgICAgICAgICBzZWxmLmxhbmcgPSBwcmVmcy5nZXQoImxhbmd1YWdlIiwgImVuIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByZWZzLmdldCgiZ2VvbWV0cnkiKToKICAgICAgICAgICAgICAgIHNlbGYuZ2VvbWV0cnkocHJlZnNbImdlb21ldHJ5Il0pCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBwcmVmcy5nZXQoIm91dHB1dF9kaXIiKToKICAgICAgICAgICAgICAgIHNlbGYub3V0dmFyLnNldChwcmVmc1sib3V0cHV0X2RpciJdKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJpbWFnZV9tb2RlIik6CiAgICAgICAgICAgICAgICBzZWxmLnNpemV2YXIuc2V0KHByZWZzWyJpbWFnZV9tb2RlIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnZpZGVvc192YXIuc2V0KHByZWZzLmdldCgiZG93bmxvYWRfdmlkZW9zIiwgVHJ1ZSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBwcmVmcy5nZXQoInVybHMiKToKICAgICAgICAgICAgICAgIHNlbGYudXJsYm94LmRlbGV0ZSgiMS4wIiwgdGsuRU5EKQogICAgICAgICAgICAgICAgc2VsZi51cmxib3guaW5zZXJ0KCIxLjAiLCBwcmVmc1sidXJscyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJjb252ZXJ0ZXJfZGlyIik6CiAgICAgICAgICAgICAgICBzZWxmLmNvbnZfZGlyX3Zhci5zZXQocHJlZnNbImNvbnZlcnRlcl9kaXIiXSkKICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzICAjIFVzZSBkZWZhdWx0cyBpZiBsb2FkaW5nIGZhaWxzCiAgICAKICAgIGRlZiBfc2F2ZV9wcmVmZXJlbmNlcyhzZWxmKToKICAgICAgICAiIiJTYXZlIGN1cnJlbnQgcHJlZmVyZW5jZXMuIiIiCiAgICAgICAgaWYgc2VsZi5fbG9hZGluZ19wcmVmczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmVmcyA9IHsKICAgICAgICAgICAgICAgICJnZW9tZXRyeSI6IHNlbGYuZ2VvbWV0cnkoKSwKICAgICAgICAgICAgICAgICJsYW5ndWFnZSI6IHNlbGYubGFuZywKICAgICAgICAgICAgICAgICJvdXRwdXRfZGlyIjogc2VsZi5vdXR2YXIuZ2V0KCksCiAgICAgICAgICAgICAgICAiaW1hZ2VfbW9kZSI6IHNlbGYuc2l6ZXZhci5nZXQoKSwKICAgICAgICAgICAgICAgICJkb3dubG9hZF92aWRlb3MiOiBzZWxmLnZpZGVvc192YXIuZ2V0KCksCiAgICAgICAgICAgICAgICAidXJscyI6IHNlbGYudXJsYm94LmdldCgiMS4wIiwgdGsuRU5EKSwKICAgICAgICAgICAgICAgICJjb252ZXJ0ZXJfZGlyIjogc2VsZi5jb252X2Rpcl92YXIuZ2V0KCksCiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5wcmVmc19tYW5hZ2VyLnNhdmVfcHJlZmVyZW5jZXMocHJlZnMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBTaWxlbnQgZmFpbAogICAgCiAgICAjIEV2ZW50IGhhbmRsZXJzCiAgICBkZWYgX29uX3Zhcl9jaGFuZ2VkKHNlbGYsICphcmdzKToKICAgICAgICAiIiJIYW5kbGUgdmFyaWFibGUgY2hhbmdlcyBmb3IgYXV0by1zYXZlLiIiIgogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgCiAgICBkZWYgX29uX3VybGJveF9tb2RpZmllZChzZWxmLCBldmVudD1Ob25lKToKICAgICAgICAiIiJIYW5kbGUgVVJMIGJveCBtb2RpZmljYXRpb25zLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi51cmxib3guZWRpdF9tb2RpZmllZChGYWxzZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcygpCiAgICAKICAgIGRlZiBfb25fY29uZmlndXJlKHNlbGYsIGV2ZW50PU5vbmUpOgogICAgICAgICIiIkhhbmRsZSB3aW5kb3cgY29uZmlndXJlIGV2ZW50cy4iIiIKICAgICAgICBpZiBzZWxmLl9sb2FkaW5nX3ByZWZzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICAjIERlYm91bmNlIGdlb21ldHJ5IHNhdmluZwogICAgICAgIGlmIHNlbGYuX2dlb21fc2F2ZV9qb2I6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYWZ0ZXJfY2FuY2VsKHNlbGYuX2dlb21fc2F2ZV9qb2IpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgCiAgICAgICAgc2VsZi5fZ2VvbV9zYXZlX2pvYiA9IHNlbGYuYWZ0ZXIoNTAwLCBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKQogICAgCiAgICBkZWYgX29uX2xhbmdfY2hhbmdlKHNlbGYsIGV2ZW50PU5vbmUpOgogICAgICAgICIiIkhhbmRsZSBsYW5ndWFnZSBjaGFuZ2UuIiIiCiAgICAgICAgc2VsZWN0ZWQgPSBzZWxmLmxhbmdfdmFyLmdldCgpCiAgICAgICAgaWYgVCgiaWQiLCAibGFuZ19pZCIpIGluIHNlbGVjdGVkOgogICAgICAgICAgICBzZWxmLmxhbmcgPSAiaWQiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5sYW5nID0gImVuIgogICAgICAgIAogICAgICAgIHNlbGYuYXBwbHlfaTE4bigpCiAgICAgICAgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcygpCiAgICAKICAgIGRlZiBfb25fY2xvc2Uoc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIHdpbmRvdyBjbG9zZS4iIiIKICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgICAgICBzZWxmLmRlc3Ryb3koKQogICAgCiAgICBkZWYgX2luc3RhbGxfc2lnbmFsX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkluc3RhbGwgc2lnbmFsIGhhbmRsZXJzIGZvciBncmFjZWZ1bCBzaHV0ZG93bi4iIiIKICAgICAgICBkZWYgc2lnbmFsX2hhbmRsZXIoc2lnbnVtLCBmcmFtZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBzZWxmLnF1aXQoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHSU5ULCBzaWduYWxfaGFuZGxlcikKICAgICAgICAgICAgc2lnbmFsLnNpZ25hbChzaWduYWwuU0lHVEVSTSwgc2lnbmFsX2hhbmRsZXIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBNYXkgbm90IHdvcmsgb24gYWxsIHBsYXRmb3JtcwogICAgCiAgICAjIFVJIEFjdGlvbnMKICAgIGRlZiBhcHBseV9pMThuKHNlbGYpOgogICAgICAgICIiIkFwcGx5IGN1cnJlbnQgbGFuZ3VhZ2UgdG8gYWxsIFVJIGVsZW1lbnRzLiIiIgogICAgICAgIHNlbGYudGl0bGUoVChzZWxmLmxhbmcsICJhcHBfdGl0bGUiKSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBpbnRybyB0ZXh0CiAgICAgICAgc2VsZi5pbnRyb19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImludHJvIikpCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgbGFiZWxzCiAgICAgICAgc2VsZi51cmxzX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAidXJsc19sYWJlbCIpKQogICAgICAgIHNlbGYub3V0X2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAib3V0cHV0X2xhYmVsIikpCiAgICAgICAgc2VsZi5jaG9vc2VfYnRuLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAiY2hvb3NlIikpCiAgICAgICAgc2VsZi5tb2RlX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAibW9kZV9sYWJlbCIpKQogICAgICAgIHNlbGYubW9kZV9oaW50LmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAibW9kZV9oaW50IikpCiAgICAgICAgc2VsZi52aWRlb3NfY2hlY2suY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJ2aWRlb3NfY2hlY2siKSkKICAgICAgICBzZWxmLnN0YXJ0X2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImJ0bl9zdGFydCIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIGNvbnZlcnRlciBzZWN0aW9uCiAgICAgICAgc2VsZi5jb252X3RpdGxlLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAiY29udl90aXRsZSIpKQogICAgICAgIHNlbGYuY29udl9zdWJ0aXRsZS5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfc3VidGl0bGUiKSkKICAgICAgICBzZWxmLmNvbnZfcGlja19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfcGlja19sYWJlbCIpKQogICAgICAgIHNlbGYuY29udl9jaG9vc2VfYnRuLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAiY29udl9idG5fY2hvb3NlIikpCiAgICAgICAgc2VsZi5jb252X3N0YXJ0X2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfYnRuX3N0YXJ0IikpCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgcHJvZ3Jlc3Mgc2VjdGlvbgogICAgICAgIHNlbGYubG9nX3RpdGxlLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAibG9nIikpCiAgICAgICAgc2VsZi5pbWFnZXNfbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJpbWFnZXMiKSkKICAgICAgICBzZWxmLnZpZGVvc19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgInZpZGVvcyIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIGxhbmd1YWdlIHNlbGVjdG9yCiAgICAgICAgc2VsZi5sYW5nX3Zhci5zZXQoVChzZWxmLmxhbmcsICJsYW5nX2lkIiBpZiBzZWxmLmxhbmcgPT0gImlkIiBlbHNlICJsYW5nX2VuIikpCiAgICAKICAgIGRlZiBwaWNrX291dChzZWxmKToKICAgICAgICAiIiJIYW5kbGUgb3V0cHV0IGRpcmVjdG9yeSBzZWxlY3Rpb24uIiIiCiAgICAgICAgZm9sZGVyID0gZmlsZWRpYWxvZy5hc2tkaXJlY3RvcnkodGl0bGU9VChzZWxmLmxhbmcsICJjaG9vc2UiKSkKICAgICAgICBpZiBmb2xkZXI6CiAgICAgICAgICAgIHNlbGYub3V0dmFyLnNldChmb2xkZXIpCiAgICAKICAgIGRlZiBwaWNrX2NvbnZfZGlyKHNlbGYpOgogICAgICAgICIiIkhhbmRsZSBjb252ZXJ0ZXIgZGlyZWN0b3J5IHNlbGVjdGlvbi4iIiIgCiAgICAgICAgZm9sZGVyID0gZmlsZWRpYWxvZy5hc2tkaXJlY3RvcnkodGl0bGU9VChzZWxmLmxhbmcsICJjb252X2J0bl9jaG9vc2UiKSkKICAgICAgICBpZiBmb2xkZXI6CiAgICAgICAgICAgIHNlbGYuY29udl9kaXJfdmFyLnNldChmb2xkZXIpCiAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiJTdGFydCB0aGUgbWFpbiBkb3dubG9hZCBwcm9jZXNzLiIiIgogICAgICAgICMgR2V0IGFuZCB2YWxpZGF0ZSBVUkxzCiAgICAgICAgdXJsc190ZXh0ID0gc2VsZi51cmxib3guZ2V0KCIxLjAiLCB0ay5FTkQpLnN0cmlwKCkKICAgICAgICBpZiBub3QgdXJsc190ZXh0OgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgIm1pc3NpbmdfdXJsc19tc2ciKSwgVChzZWxmLmxhbmcsICJtaXNzaW5nX3VybHNfbXNnIikpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHVybHMgPSBbdXJsLnN0cmlwKCkgZm9yIHVybCBpbiB1cmxzX3RleHQuc3BsaXQoJ1xuJykgaWYgdXJsLnN0cmlwKCldCiAgICAgICAgaWYgbm90IHVybHM6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKFQoc2VsZi5sYW5nLCAibWlzc2luZ191cmxzX21zZyIpLCBUKHNlbGYubGFuZywgIm1pc3NpbmdfdXJsc19tc2ciKSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBWYWxpZGF0ZSBvdXRwdXQgZGlyZWN0b3J5CiAgICAgICAgb3V0ZGlyID0gc2VsZi5vdXR2YXIuZ2V0KCkuc3RyaXAoKQogICAgICAgIGlmIG5vdCBvdXRkaXI6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKFQoc2VsZi5sYW5nLCAibWlzc2luZ19vdXRfdGl0bGUiKSwgVChzZWxmLmxhbmcsICJtaXNzaW5nX291dF9tc2ciKSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBWYWxpZGF0ZSBpbWFnZSBzaXplCiAgICAgICAgc2l6ZV90ZXh0ID0gc2VsZi5zaXpldmFyLmdldCgpCiAgICAgICAgaXNfdmFsaWQsIHdpZHRoID0gdmFsaWRhdGVfaW1hZ2Vfc2l6ZShzaXplX3RleHQpCiAgICAgICAgaWYgbm90IGlzX3ZhbGlkOgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV90aXRsZSIpLCBUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV9tc2ciKSkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBEZXRlcm1pbmUgaWYgb3JpZ2luYWwgaW1hZ2VzIHJlcXVlc3RlZAogICAgICAgIGltZ19vcmlnaW5hbCA9ICh3aWR0aCA9PSAtMSkgICMgLTEgaW5kaWNhdGVzIE9SSUdJTkFMIG1vZGUKICAgICAgICBpZiBub3QgaW1nX29yaWdpbmFsOgogICAgICAgICAgICB3aWR0aCA9IGludCh3aWR0aCkKICAgICAgICAKICAgICAgICAjIFJlc2V0IHByb2dyZXNzCiAgICAgICAgc2VsZi51cGRhdGVfcHJvZ3Jlc3NfaW1hZ2VzKDAsIDApCiAgICAgICAgc2VsZi51cGRhdGVfcHJvZ3Jlc3NfdmlkZW9zKDAsIDApCiAgICAgICAgCiAgICAgICAgIyBTYXZlIHByZWZlcmVuY2VzIGJlZm9yZSBzdGFydGluZwogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgICAgIAogICAgICAgICMgU3RhcnQgd29ya2VyIHRocmVhZAogICAgICAgIHN0YXJ0X3dvcmtlcl90aHJlYWQoCiAgICAgICAgICAgIHJ1bl93b3JrZXIsCiAgICAgICAgICAgIHVybHMsIG91dGRpciwgc2VsZi5sb2dfaGFuZGxlciwgc2VsZi5zdGFydF9idG4sCiAgICAgICAgICAgIHdpZHRoLCBzZWxmLnZpZGVvc192YXIuZ2V0KCksIGltZ19vcmlnaW5hbCwKICAgICAgICAgICAgc2VsZiwgc2VsZi5sYW5nCiAgICAgICAgKQogICAgCiAgICBkZWYgc3RhcnRfY29udmVydGVyKHNlbGYpOgogICAgICAgICIiIlN0YXJ0IHRoZSB0aHVtYm5haWwgY29udmVydGVyIHByb2Nlc3MuIiIiCiAgICAgICAgbG9jYWxfZGlyID0gc2VsZi5jb252X2Rpcl92YXIuZ2V0KCkuc3RyaXAoKQogICAgICAgIGlmIG5vdCBsb2NhbF9kaXI6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKAogICAgICAgICAgICAgICAgVChzZWxmLmxhbmcsICJtaXNzaW5nX2NvbnZfZGlyX3RpdGxlIiksIAogICAgICAgICAgICAgICAgVChzZWxmLmxhbmcsICJtaXNzaW5nX2NvbnZfZGlyX21zZyIpCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBSZXNldCBwcm9ncmVzcwogICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX2ltYWdlcygwLCAwKQogICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX3ZpZGVvcygwLCAwKQogICAgICAgIAogICAgICAgICMgU3RhcnQgY29udmVydGVyIHdvcmtlcgogICAgICAgIHN0YXJ0X3dvcmtlcl90aHJlYWQoCiAgICAgICAgICAgIHJ1bl9jb252ZXJ0ZXIsCiAgICAgICAgICAgIGxvY2FsX2Rpciwgc2VsZi5sb2dfaGFuZGxlciwgc2VsZi5jb252X3N0YXJ0X2J0biwgc2VsZiwgc2VsZi5sYW5nCiAgICAgICAgKQogICAgCiAgICBkZWYgY2FuY2VsKHNlbGYpOgogICAgICAgICIiIkNhbmNlbCBjdXJyZW50IG9wZXJhdGlvbi4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNldGF0dHIoZGZyLCAiSU5URVJSVVBURUQiLCBUcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNpZ25faW4oc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIHNpZ24gaW4vb3V0LiIiIgogICAgICAgICMgVGhpcyB3aWxsIHRyaWdnZXIgT0F1dGggZmxvdwogICAgICAgIHRyeToKICAgICAgICAgICAgc2VydmljZSwgY3JlZHMgPSBkZnIuZ2V0X3NlcnZpY2VfYW5kX2NyZWRzKGRmci5UT0tFTl9GSUxFLCBkZnIuQ1JFREVOVElBTFNfRklMRSkKICAgICAgICAgICAgYWNjb3VudCA9IGRmci5nZXRfYWNjb3VudF9pbmZvKHNlcnZpY2UpCiAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJlbWFpbCIpOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfYWNjb3VudChhY2NvdW50LmdldCgibmFtZSIsICIiKSwgYWNjb3VudFsiZW1haWwiXSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJTaWduIEluIEVycm9yIiwgZiJGYWlsZWQgdG8gc2lnbiBpbjoge2V9IikKICAgIAogICAgZGVmIHNpZ25fb3V0KHNlbGYpOgogICAgICAgICIiIlNpZ24gb3V0IGFuZCBjbGVhciB0b2tlbi4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBvcwogICAgICAgICAgICBmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKICAgICAgICAgICAgdG9rZW5fcGF0aCA9IFBhdGgoZGZyLlRPS0VOX0ZJTEUpCiAgICAgICAgICAgIGlmIHRva2VuX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgICAgICBiYWNrdXBfcGF0aCA9IHRva2VuX3BhdGgud2l0aF9zdWZmaXgodG9rZW5fcGF0aC5zdWZmaXggKyAiLmJhayIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgYmFja3VwX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2t1cF9wYXRoLnVubGluaygpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRva2VuX3BhdGgucmVuYW1lKGJhY2t1cF9wYXRoKQogICAgICAgICAgICBzZWxmLnNldF9hY2NvdW50KCIiLCAiIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJTaWduIE91dCBFcnJvciIsIGYiRmFpbGVkIHRvIHNpZ24gb3V0OiB7ZX0iKQogICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfYXN5bmMoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgYWNjb3VudCBzdGF0dXMgaW4gYmFja2dyb3VuZCB0aHJlYWQuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50ID0gZGZyLnRyeV9nZXRfYWNjb3VudF9pbmZvKGRmci5UT0tFTl9GSUxFLCBkZnIuQ1JFREVOVElBTFNfRklMRSkKICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImVtYWlsIik6CiAgICAgICAgICAgICAgICBzZWxmLmFmdGVyKDAsIGxhbWJkYTogc2VsZi5zZXRfYWNjb3VudChhY2NvdW50LmdldCgibmFtZSIsICIiKSwgYWNjb3VudFsiZW1haWwiXSkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBTaWxlbnQgZmFpbCBmb3IgYmFja2dyb3VuZCBjaGVjawogICAgCiAgICAjIFByb2dyZXNzIHVwZGF0ZXMKICAgIGRlZiBzZXRfYWNjb3VudChzZWxmLCBuYW1lOiBzdHIsIGVtYWlsOiBzdHIpOgogICAgICAgICIiIlVwZGF0ZSBhY2NvdW50IGRpc3BsYXkuIiIiCiAgICAgICAgaWYgZW1haWw6CiAgICAgICAgICAgIGlmIG5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmFjY3RfdmFyLnNldChmIkFjY291bnQ6IHtuYW1lfSA8e2VtYWlsfT4iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hY2N0X3Zhci5zZXQoZiJBY2NvdW50OiB7ZW1haWx9IikKICAgICAgICAgICAgc2VsZi5hdXRoX2J0bi5jb25maWd1cmUodGV4dD0iU2lnbiBvdXQiLCBjb21tYW5kPXNlbGYuc2lnbl9vdXQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5hY2N0X3Zhci5zZXQoIkFjY291bnQ6IChub3Qgc2lnbmVkIGluKSIpCiAgICAgICAgICAgIHNlbGYuYXV0aF9idG4uY29uZmlndXJlKHRleHQ9IlNpZ24gaW4iLCBjb21tYW5kPXNlbGYuc2lnbl9pbikKICAgIAogICAgZGVmIHVwZGF0ZV9wcm9ncmVzc19pbWFnZXMoc2VsZiwgZG9uZTogaW50LCB0b3RhbDogaW50KToKICAgICAgICAiIiJVcGRhdGUgaW1hZ2UgcHJvZ3Jlc3MgYmFyLiIiIgogICAgICAgIHRvdGFsID0gbWF4KHRvdGFsLCAwKQogICAgICAgIGRvbmUgPSBtaW4obWF4KGRvbmUsIDApLCB0b3RhbCkgaWYgdG90YWwgZWxzZSAwCiAgICAgICAgCiAgICAgICAgc2VsZi5wcm9ncmVzc19pbWFnZXNbIm1heGltdW0iXSA9IHRvdGFsIGlmIHRvdGFsIGVsc2UgMQogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzWyJ2YWx1ZSJdID0gZG9uZQogICAgICAgIAogICAgICAgIHByb2dyZXNzX3RleHQgPSBmIntkb25lfS97dG90YWx9ICh7VChzZWxmLmxhbmcsICdwcm9ncmVzc19sZWZ0Jyl9IHttYXgodG90YWwtZG9uZSwgMCl9KSIKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc192YWx1ZS5jb25maWd1cmUodGV4dD1wcm9ncmVzc190ZXh0KQogICAgICAgIHNlbGYudXBkYXRlX2lkbGV0YXNrcygpCiAgICAKICAgIGRlZiB1cGRhdGVfcHJvZ3Jlc3NfdmlkZW9zKHNlbGYsIGRvbmU6IGludCwgdG90YWw6IGludCk6CiAgICAgICAgIiIiVXBkYXRlIHZpZGVvIHByb2dyZXNzIGJhci4iIiIKICAgICAgICB0b3RhbCA9IG1heCh0b3RhbCwgMCkKICAgICAgICBkb25lID0gbWluKG1heChkb25lLCAwKSwgdG90YWwpIGlmIHRvdGFsIGVsc2UgMAogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zWyJtYXhpbXVtIl0gPSB0b3RhbCBpZiB0b3RhbCBlbHNlIDEKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc1sidmFsdWUiXSA9IGRvbmUKICAgICAgICAKICAgICAgICBwcm9ncmVzc190ZXh0ID0gZiJ7ZG9uZX0ve3RvdGFsfSAoe1Qoc2VsZi5sYW5nLCAncHJvZ3Jlc3NfbGVmdCcpfSB7bWF4KHRvdGFsLWRvbmUsIDApfSkiCiAgICAgICAgc2VsZi5wcm9ncmVzc192aWRlb3NfdmFsdWUuY29uZmlndXJlKHRleHQ9cHJvZ3Jlc3NfdGV4dCkKICAgICAgICBzZWxmLnVwZGF0ZV9pZGxldGFza3MoKQogICAgCiAgICBkZWYgdXBkYXRlX3Byb2dyZXNzX2J5dGVzKHNlbGYsIGJ5dGVzX3dyaXR0ZW46IGludCk6CiAgICAgICAgIiIiVXBkYXRlIGJ5dGVzIHByb2dyZXNzIChpZiBpbXBsZW1lbnRlZCBpbiBVSSkuIiIiCiAgICAgICAgc2VsZi5ieXRlc193cml0dGVuID0gbWF4KDAsIGJ5dGVzX3dyaXR0ZW4pCiAgICAgICAgIyBDb3VsZCBhZGQgYSBieXRlcyBwcm9ncmVzcyBiYXIgaGVyZSBpZiBuZWVkZWQAAAAAAAAAADpsAAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAAJAIAAAAAAAAkAgAAAAAAAAAAAAAAAPC/"
				],
				[
					8,
					1,
					"revert",
					null,
					"AgAAAAAAAAAAAAAAAAAAAAAAAAA6bAAAIiIiCk1haW4gYXBwbGljYXRpb24gY2xhc3MgZm9yIHRoZSBvbnRhaG9vZC1kb3dubG9hZGVyIEdVSS4KIiIiCgppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHNpZ25hbAppbXBvcnQgc3lzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHRraW50ZXIgYXMgdGsKZnJvbSB0a2ludGVyIGltcG9ydCB0dGssIHNjcm9sbGVkdGV4dCwgZmlsZWRpYWxvZywgbWVzc2FnZWJveApmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwKCmltcG9ydCBkcml2ZV9mZXRjaF9yZXNpbGllbnQgYXMgZGZyCgpmcm9tIC5jb25maWcgaW1wb3J0IERFRkFVTFRfVVJMUwpmcm9tIC5pMThuIGltcG9ydCBUCmZyb20gLmxvZ19oYW5kbGVyIGltcG9ydCBUa0xvZ0hhbmRsZXIKZnJvbSAucHJlZmVyZW5jZXMgaW1wb3J0IFByZWZlcmVuY2VzTWFuYWdlcgpmcm9tIC51dGlscyBpbXBvcnQgbG9jYXRlX2NyZWRlbnRpYWxzLCB2YWxpZGF0ZV9pbWFnZV9zaXplCmZyb20gLndvcmtlcnMgaW1wb3J0IHJ1bl93b3JrZXIsIHJ1bl9jb252ZXJ0ZXIsIHN0YXJ0X3dvcmtlcl90aHJlYWQsIHJ1bl9wcmVzY2FuCgoKY2xhc3MgQXBwKHRrLlRrKToKICAgICIiIk1haW4gYXBwbGljYXRpb24gd2luZG93LiIiIgogICAgCiAgICBTSVpFX09QVElPTlMgPSBbCiAgICAgICAgIjQwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjcwMCAodGh1bWJuYWlsKSIsIAogICAgICAgICIxMDI0ICh0aHVtYm5haWwpIiwKICAgICAgICAiMTYwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjI0MDAgKHRodW1ibmFpbCkiLAogICAgICAgICIzMjAwICh0aHVtYm5haWwpIiwKICAgICAgICAiNDgwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjYwMDAgKHRodW1ibmFpbCkiLAogICAgICAgICJPUklHSU5BTCAoZnVsbCBzaXplKSIsCiAgICBdCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCkKICAgICAgICAKICAgICAgICAjIEluaXRpYWxpemUgc3RhdGUKICAgICAgICBzZWxmLl9sb2FkaW5nX3ByZWZzID0gVHJ1ZQogICAgICAgIHNlbGYuX2dlb21fc2F2ZV9qb2IgPSBOb25lCiAgICAgICAgc2VsZi5sYW5nID0gImVuIgogICAgICAgIHNlbGYuZXhwZWN0ZWRfYnl0ZXNfdG90YWwgPSAwCiAgICAgICAgc2VsZi5ieXRlc193cml0dGVuID0gMAogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBwcmVmZXJlbmNlcyBtYW5hZ2VyCiAgICAgICAgc2VsZi5wcmVmc19tYW5hZ2VyID0gUHJlZmVyZW5jZXNNYW5hZ2VyKCkKICAgICAgICAKICAgICAgICAjIFNldCB1cCB3aW5kb3cKICAgICAgICBzZWxmLnRpdGxlKFQoc2VsZi5sYW5nLCAiYXBwX3RpdGxlIikpCiAgICAgICAgc2VsZi5nZW9tZXRyeSgiOTgweDk1MCIpCiAgICAgICAgc2VsZi5taW5zaXplKDgyMCwgNzYwKQogICAgICAgIAogICAgICAgICMgQ3JlYXRlIFVJIGNvbXBvbmVudHMKICAgICAgICBzZWxmLl9jcmVhdGVfdWkoKQogICAgICAgIAogICAgICAgICMgTG9hZCBwcmVmZXJlbmNlcyBhbmQgYXBwbHkgbGFuZ3VhZ2UKICAgICAgICBzZWxmLl9sb2FkX3ByZWZlcmVuY2VzKCkKICAgICAgICBzZWxmLmFwcGx5X2kxOG4oKQogICAgICAgIAogICAgICAgICMgU2V0IHVwIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgc2VsZi5fc2V0dXBfZXZlbnRfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgQ2hlY2sgYWNjb3VudCBzdGF0dXMgaW4gYmFja2dyb3VuZAogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuX2NoZWNrX2FjY291bnRfYXN5bmMsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgCiAgICAgICAgIyBEb25lIGxvYWRpbmcKICAgICAgICBzZWxmLl9sb2FkaW5nX3ByZWZzID0gRmFsc2UKICAgIAogICAgZGVmIF9jcmVhdGVfdWkoc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBtYWluIFVJIGNvbXBvbmVudHMuIiIiCiAgICAgICAgIyBUb3AgYmFyIHdpdGggbGFuZ3VhZ2UgYW5kIGFjY291bnQKICAgICAgICBzZWxmLl9jcmVhdGVfdG9wX2JhcigpCiAgICAgICAgCiAgICAgICAgIyBNYWluIGludHJvIHRleHQKICAgICAgICBzZWxmLmludHJvX2xhYmVsID0gdHRrLkxhYmVsKHNlbGYsIHdyYXBsZW5ndGg9OTQwLCBqdXN0aWZ5PSJsZWZ0IikKICAgICAgICBzZWxmLmludHJvX2xhYmVsLnBhY2soYW5jaG9yPSJ3IiwgcGFkeD0xMiwgcGFkeT0oMTIsIDYpKQogICAgICAgIAogICAgICAgICMgRG93bmxvYWRlciBzZWN0aW9uCiAgICAgICAgc2VsZi5fY3JlYXRlX2Rvd25sb2FkZXJfc2VjdGlvbigpCiAgICAgICAgCiAgICAgICAgIyBTZXBhcmF0b3IKICAgICAgICBzZXAgPSB0dGsuU2VwYXJhdG9yKHNlbGYsIG9yaWVudD0iaG9yaXpvbnRhbCIpCiAgICAgICAgc2VwLnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDYsIDgpKQogICAgICAgIAogICAgICAgICMgQ29udmVydGVyIHNlY3Rpb24KICAgICAgICBzZWxmLl9jcmVhdGVfY29udmVydGVyX3NlY3Rpb24oKQogICAgICAgIAogICAgICAgICMgTG9ncyBhbmQgcHJvZ3Jlc3Mgc2VjdGlvbgogICAgICAgIHNlbGYuX2NyZWF0ZV9sb2dzX3NlY3Rpb24oKQogICAgICAgIHNlbGYuX2NyZWF0ZV9wcm9ncmVzc19zZWN0aW9uKCkKICAgIAogICAgZGVmIF9jcmVhdGVfdG9wX2JhcihzZWxmKToKICAgICAgICAiIiJDcmVhdGUgdGhlIHRvcCBiYXIgd2l0aCBsYW5ndWFnZSBzZWxlY3RvciBhbmQgYWNjb3VudCBpbmZvLiIiIgogICAgICAgIHRvcGJhciA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIHRvcGJhci5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgxMCwgMCkpCiAgICAgICAgCiAgICAgICAgIyBMYW5ndWFnZSBzZWxlY3RvcgogICAgICAgIHR0ay5MYWJlbCh0b3BiYXIsIHRleHQ9VChzZWxmLmxhbmcsICJsYW5ndWFnZSIpKS5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIHNlbGYubGFuZ192YXIgPSB0ay5TdHJpbmdWYXIodmFsdWU9VChzZWxmLmxhbmcsICJsYW5nX2VuIikpCiAgICAgICAgc2VsZi5sYW5nX2JveCA9IHR0ay5Db21ib2JveCgKICAgICAgICAgICAgdG9wYmFyLCB0ZXh0dmFyaWFibGU9c2VsZi5sYW5nX3ZhciwKICAgICAgICAgICAgdmFsdWVzPVtUKCJlbiIsICJsYW5nX2VuIiksIFQoImlkIiwgImxhbmdfaWQiKV0sIAogICAgICAgICAgICB3aWR0aD0yMiwgc3RhdGU9InJlYWRvbmx5IgogICAgICAgICkKICAgICAgICBzZWxmLmxhbmdfYm94LnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9KDgsIDApKQogICAgICAgIHNlbGYubGFuZ19ib3guYmluZCgiPDxDb21ib2JveFNlbGVjdGVkPj4iLCBzZWxmLl9vbl9sYW5nX2NoYW5nZSkKICAgICAgICAKICAgICAgICAjIEFjY291bnQgaW5mbwogICAgICAgIHNlbGYuYWNjdF92YXIgPSB0ay5TdHJpbmdWYXIodmFsdWU9IkFjY291bnQ6IChub3Qgc2lnbmVkIGluKSIpCiAgICAgICAgc2VsZi5hY2N0X2xhYmVsID0gdHRrLkxhYmVsKHRvcGJhciwgdGV4dHZhcmlhYmxlPXNlbGYuYWNjdF92YXIpCiAgICAgICAgc2VsZi5hY2N0X2xhYmVsLnBhY2soc2lkZT0icmlnaHQiKQogICAgICAgIAogICAgICAgIHNlbGYuYXV0aF9idG4gPSB0dGsuQnV0dG9uKHRvcGJhciwgdGV4dD0iU2lnbiBpbiIsIGNvbW1hbmQ9c2VsZi5zaWduX2luKQogICAgICAgIHNlbGYuYXV0aF9idG4ucGFjayhzaWRlPSJyaWdodCIsIHBhZHg9KDAsIDgpKQogICAgCiAgICBkZWYgX2NyZWF0ZV9kb3dubG9hZGVyX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBtYWluIGRvd25sb2FkZXIgc2VjdGlvbi4iIiIKICAgICAgICAjIFVSTHMgaW5wdXQKICAgICAgICBzZWxmLnVybHNfbGFiZWwgPSB0dGsuTGFiZWwoc2VsZikKICAgICAgICBzZWxmLnVybHNfbGFiZWwucGFjayhhbmNob3I9InciLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYudXJsYm94ID0gc2Nyb2xsZWR0ZXh0LlNjcm9sbGVkVGV4dChzZWxmLCBoZWlnaHQ9NikKICAgICAgICBzZWxmLnVybGJveC5pbnNlcnQoIjEuMCIsICJcbiIuam9pbihERUZBVUxUX1VSTFMpICsgIlxuIikKICAgICAgICBzZWxmLnVybGJveC5wYWNrKGZpbGw9IngiLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgICMgT3V0cHV0IGRpcmVjdG9yeSBzZWxlY3Rpb24KICAgICAgICBvdXRfcm93ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgb3V0X3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYub3V0X2xhYmVsID0gdHRrLkxhYmVsKG91dF9yb3cpCiAgICAgICAgc2VsZi5vdXRfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLm91dHZhciA9IHRrLlN0cmluZ1ZhcigpCiAgICAgICAgc2VsZi5vdXRfZW50cnkgPSB0dGsuRW50cnkob3V0X3JvdywgdGV4dHZhcmlhYmxlPXNlbGYub3V0dmFyKQogICAgICAgIHNlbGYub3V0X2VudHJ5LnBhY2soc2lkZT0ibGVmdCIsIGZpbGw9IngiLCBleHBhbmQ9VHJ1ZSwgcGFkeD04KQogICAgICAgIAogICAgICAgIHNlbGYuY2hvb3NlX2J0biA9IHR0ay5CdXR0b24ob3V0X3JvdywgY29tbWFuZD1zZWxmLnBpY2tfb3V0KQogICAgICAgIHNlbGYuY2hvb3NlX2J0bi5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgICMgSW1hZ2UgbW9kZSBzZWxlY3Rpb24KICAgICAgICBtb2RlX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIG1vZGVfcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgc2VsZi5tb2RlX2xhYmVsID0gdHRrLkxhYmVsKG1vZGVfcm93KQogICAgICAgIHNlbGYubW9kZV9sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYuc2l6ZXZhciA9IHRrLlN0cmluZ1Zhcih2YWx1ZT1zZWxmLlNJWkVfT1BUSU9OU1sxXSkKICAgICAgICB0dGsuQ29tYm9ib3goCiAgICAgICAgICAgIG1vZGVfcm93LCB0ZXh0dmFyaWFibGU9c2VsZi5zaXpldmFyLCAKICAgICAgICAgICAgdmFsdWVzPXNlbGYuU0laRV9PUFRJT05TLCB3aWR0aD0yOCwgc3RhdGU9InJlYWRvbmx5IgogICAgICAgICkucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD04KQogICAgICAgIAogICAgICAgIHNlbGYubW9kZV9oaW50ID0gdHRrLkxhYmVsKG1vZGVfcm93KQogICAgICAgIHNlbGYubW9kZV9oaW50LnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgIyBWaWRlbyBkb3dubG9hZCBvcHRpb24KICAgICAgICB2aWRlb19yb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICB2aWRlb19yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMCwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYudmlkZW9zX3ZhciA9IHRrLkJvb2xlYW5WYXIodmFsdWU9VHJ1ZSkKICAgICAgICBzZWxmLnZpZGVvc19jaGVjayA9IHR0ay5DaGVja2J1dHRvbih2aWRlb19yb3csIHZhcmlhYmxlPXNlbGYudmlkZW9zX3ZhcikKICAgICAgICBzZWxmLnZpZGVvc19jaGVjay5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgICMgQ29udHJvbCBidXR0b25zCiAgICAgICAgYnRuX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIGJ0bl9yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMiwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYuc3RhcnRfYnRuID0gdHRrLkJ1dHRvbihidG5fcm93LCBjb21tYW5kPXNlbGYuc3RhcnQpCiAgICAgICAgc2VsZi5zdGFydF9idG4ucGFjayhzaWRlPSJyaWdodCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5jYW5jZWxfYnRuID0gdHRrLkJ1dHRvbigKICAgICAgICAgICAgYnRuX3JvdywgdGV4dD0iQ2FuY2VsIiwgY29tbWFuZD1zZWxmLmNhbmNlbCwgc3RhdGU9ImRpc2FibGVkIgogICAgICAgICkKICAgICAgICBzZWxmLmNhbmNlbF9idG4ucGFjayhzaWRlPSJsZWZ0IikKICAgIAogICAgZGVmIF9jcmVhdGVfY29udmVydGVyX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSB0aHVtYm5haWwgY29udmVydGVyIHNlY3Rpb24uIiIiCiAgICAgICAgIyBTZWN0aW9uIHRpdGxlIGFuZCBzdWJ0aXRsZQogICAgICAgIGNvbnZfYm94ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgY29udl9ib3gucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oNCwgNikpCiAgICAgICAgCiAgICAgICAgc2VsZi5jb252X3RpdGxlID0gdHRrLkxhYmVsKGNvbnZfYm94LCBmb250PSgiVGtEZWZhdWx0Rm9udCIsIDExLCAiYm9sZCIpKQogICAgICAgIHNlbGYuY29udl90aXRsZS5wYWNrKGFuY2hvcj0idyIpCiAgICAgICAgCiAgICAgICAgc2VsZi5jb252X3N1YnRpdGxlID0gdHRrLkxhYmVsKGNvbnZfYm94LCB3cmFwbGVuZ3RoPTk0MCwganVzdGlmeT0ibGVmdCIpCiAgICAgICAgc2VsZi5jb252X3N1YnRpdGxlLnBhY2soYW5jaG9yPSJ3IiwgcGFkeT0oNCwgOCkpCiAgICAgICAgCiAgICAgICAgIyBEaXJlY3Rvcnkgc2VsZWN0aW9uCiAgICAgICAgY29udl9yb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBjb252X3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgwLCA0KSkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfcGlja19sYWJlbCA9IHR0ay5MYWJlbChjb252X3JvdykKICAgICAgICBzZWxmLmNvbnZfcGlja19sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYuY29udl9kaXJfdmFyID0gdGsuU3RyaW5nVmFyKCkKICAgICAgICBzZWxmLmNvbnZfZGlyX2VudHJ5ID0gdHRrLkVudHJ5KGNvbnZfcm93LCB0ZXh0dmFyaWFibGU9c2VsZi5jb252X2Rpcl92YXIpCiAgICAgICAgc2VsZi5jb252X2Rpcl9lbnRyeS5wYWNrKHNpZGU9ImxlZnQiLCBmaWxsPSJ4IiwgZXhwYW5kPVRydWUsIHBhZHg9OCkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfY2hvb3NlX2J0biA9IHR0ay5CdXR0b24oY29udl9yb3csIGNvbW1hbmQ9c2VsZi5waWNrX2NvbnZfZGlyKQogICAgICAgIHNlbGYuY29udl9jaG9vc2VfYnRuLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgIyBDb252ZXJ0IGJ1dHRvbgogICAgICAgIGNvbnZfYnRuX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIGNvbnZfYnRuX3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSg0LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfc3RhcnRfYnRuID0gdHRrLkJ1dHRvbihjb252X2J0bl9yb3csIGNvbW1hbmQ9c2VsZi5zdGFydF9jb252ZXJ0ZXIpCiAgICAgICAgc2VsZi5jb252X3N0YXJ0X2J0bi5wYWNrKHNpZGU9InJpZ2h0IikKICAgIAogICAgZGVmIF9jcmVhdGVfbG9nc19zZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSB0aGUgbG9ncyBzZWN0aW9uLiIiIgogICAgICAgIHNlbGYubG9nX3RpdGxlID0gdHRrLkxhYmVsKHNlbGYpCiAgICAgICAgc2VsZi5sb2dfdGl0bGUucGFjayhhbmNob3I9InciLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYubG9ncyA9IHNjcm9sbGVkdGV4dC5TY3JvbGxlZFRleHQoc2VsZiwgaGVpZ2h0PTE2LCBzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgIHNlbGYubG9ncy5wYWNrKGZpbGw9ImJvdGgiLCBleHBhbmQ9VHJ1ZSwgcGFkeD0xMiwgcGFkeT0oMCwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYubG9nX2hhbmRsZXIgPSBUa0xvZ0hhbmRsZXIoc2VsZi5sb2dzKQogICAgICAgIHNlbGYubG9nX2hhbmRsZXIucHV0KCIyMDI1LTEwLTAyIDAwOjAwOjAwIHwgSU5GTyAgICB8IFtHVUldIEFwcGxpY2F0aW9uIHN0YXJ0ZWQgLSBsb2dnaW5nIHN5c3RlbSBhY3RpdmUiKQogICAgCiAgICBkZWYgX2NyZWF0ZV9wcm9ncmVzc19zZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSB0aGUgcHJvZ3Jlc3MgYmFycyBzZWN0aW9uLiIiIgogICAgICAgIHByb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBwcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDAsIDEyKSkKICAgICAgICAKICAgICAgICAjIEltYWdlcyBwcm9ncmVzcwogICAgICAgIGltZ19mcmFtZSA9IHR0ay5GcmFtZShwcm93KQogICAgICAgIGltZ19mcmFtZS5wYWNrKGZpbGw9IngiLCBwYWR5PSgwLCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLmltYWdlc19sYWJlbCA9IHR0ay5MYWJlbChpbWdfZnJhbWUpCiAgICAgICAgc2VsZi5pbWFnZXNfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlcyA9IHR0ay5Qcm9ncmVzc2JhcihpbWdfZnJhbWUsIGxlbmd0aD01MjAsIG1vZGU9ImRldGVybWluYXRlIikKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlcy5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PSg4LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc192YWx1ZSA9IHR0ay5MYWJlbChpbWdfZnJhbWUsIHRleHQ9IjAvMCIpCiAgICAgICAgc2VsZi5wcm9ncmVzc19pbWFnZXNfdmFsdWUucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICAjIFZpZGVvcyBwcm9ncmVzcwogICAgICAgIHZpZF9mcmFtZSA9IHR0ay5GcmFtZShwcm93KQogICAgICAgIHZpZF9mcmFtZS5wYWNrKGZpbGw9IngiLCBwYWR5PSgwLCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLnZpZGVvc19sYWJlbCA9IHR0ay5MYWJlbCh2aWRfZnJhbWUpCiAgICAgICAgc2VsZi52aWRlb3NfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvcyA9IHR0ay5Qcm9ncmVzc2Jhcih2aWRfZnJhbWUsIGxlbmd0aD01MjAsIG1vZGU9ImRldGVybWluYXRlIikKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvcy5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PSg4LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc192YWx1ZSA9IHR0ay5MYWJlbCh2aWRfZnJhbWUsIHRleHQ9IjAvMCIpCiAgICAgICAgc2VsZi5wcm9ncmVzc192aWRlb3NfdmFsdWUucGFjayhzaWRlPSJsZWZ0IikKICAgIAogICAgZGVmIF9zZXR1cF9ldmVudF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJTZXQgdXAgZXZlbnQgaGFuZGxlcnMgYW5kIGJpbmRpbmdzLiIiIgogICAgICAgICMgVmFyaWFibGUgY2hhbmdlIHRyYWNraW5nIGZvciBhdXRvLXNhdmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYub3V0dmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkKICAgICAgICAgICAgc2VsZi5zaXpldmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkgCiAgICAgICAgICAgIHNlbGYudmlkZW9zX3Zhci50cmFjZV9hZGQoJ3dyaXRlJywgc2VsZi5fb25fdmFyX2NoYW5nZWQpCiAgICAgICAgICAgIHNlbGYuY29udl9kaXJfdmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgCiAgICAgICAgIyBVUkwgYm94IG1vZGlmaWNhdGlvbiB0cmFja2luZwogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi51cmxib3guYmluZCgnPDxNb2RpZmllZD4+Jywgc2VsZi5fb25fdXJsYm94X21vZGlmaWVkKQogICAgICAgICAgICBzZWxmLnVybGJveC5lZGl0X21vZGlmaWVkKEZhbHNlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFdpbmRvdyBnZW9tZXRyeSBjaGFuZ2VzCiAgICAgICAgc2VsZi5iaW5kKCc8Q29uZmlndXJlPicsIHNlbGYuX29uX2NvbmZpZ3VyZSkKICAgICAgICAKICAgICAgICAjIFdpbmRvdyBjbG9zZSBoYW5kbGVyCiAgICAgICAgc2VsZi5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYuX29uX2Nsb3NlKQogICAgICAgIAogICAgICAgICMgU2lnbmFsIGhhbmRsZXJzIGZvciBncmFjZWZ1bCBzaHV0ZG93bgogICAgICAgIHNlbGYuX2luc3RhbGxfc2lnbmFsX2hhbmRsZXJzKCkKICAgIAogICAgZGVmIF9sb2FkX3ByZWZlcmVuY2VzKHNlbGYpOgogICAgICAgICIiIkxvYWQgdXNlciBwcmVmZXJlbmNlcy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByZWZzID0gc2VsZi5wcmVmc19tYW5hZ2VyLmxvYWRfcHJlZmVyZW5jZXMoKQogICAgICAgICAgICBwcmVmcyA9IHNlbGYucHJlZnNfbWFuYWdlci52YWxpZGF0ZV9wcmVmZXJlbmNlcyhwcmVmcykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQXBwbHkgcHJlZmVyZW5jZXMKICAgICAgICAgICAgc2VsZi5sYW5nID0gcHJlZnMuZ2V0KCJsYW5ndWFnZSIsICJlbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBwcmVmcy5nZXQoImdlb21ldHJ5Iik6CiAgICAgICAgICAgICAgICBzZWxmLmdlb21ldHJ5KHByZWZzWyJnZW9tZXRyeSJdKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJvdXRwdXRfZGlyIik6CiAgICAgICAgICAgICAgICBzZWxmLm91dHZhci5zZXQocHJlZnNbIm91dHB1dF9kaXIiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByZWZzLmdldCgiaW1hZ2VfbW9kZSIpOgogICAgICAgICAgICAgICAgc2VsZi5zaXpldmFyLnNldChwcmVmc1siaW1hZ2VfbW9kZSJdKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi52aWRlb3NfdmFyLnNldChwcmVmcy5nZXQoImRvd25sb2FkX3ZpZGVvcyIsIFRydWUpKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJ1cmxzIik6CiAgICAgICAgICAgICAgICBzZWxmLnVybGJveC5kZWxldGUoIjEuMCIsIHRrLkVORCkKICAgICAgICAgICAgICAgIHNlbGYudXJsYm94Lmluc2VydCgiMS4wIiwgcHJlZnNbInVybHMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByZWZzLmdldCgiY29udmVydGVyX2RpciIpOgogICAgICAgICAgICAgICAgc2VsZi5jb252X2Rpcl92YXIuc2V0KHByZWZzWyJjb252ZXJ0ZXJfZGlyIl0pCiAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBVc2UgZGVmYXVsdHMgaWYgbG9hZGluZyBmYWlscwogICAgCiAgICBkZWYgX3NhdmVfcHJlZmVyZW5jZXMoc2VsZik6CiAgICAgICAgIiIiU2F2ZSBjdXJyZW50IHByZWZlcmVuY2VzLiIiIgogICAgICAgIGlmIHNlbGYuX2xvYWRpbmdfcHJlZnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgcHJlZnMgPSB7CiAgICAgICAgICAgICAgICAiZ2VvbWV0cnkiOiBzZWxmLmdlb21ldHJ5KCksCiAgICAgICAgICAgICAgICAibGFuZ3VhZ2UiOiBzZWxmLmxhbmcsCiAgICAgICAgICAgICAgICAib3V0cHV0X2RpciI6IHNlbGYub3V0dmFyLmdldCgpLAogICAgICAgICAgICAgICAgImltYWdlX21vZGUiOiBzZWxmLnNpemV2YXIuZ2V0KCksCiAgICAgICAgICAgICAgICAiZG93bmxvYWRfdmlkZW9zIjogc2VsZi52aWRlb3NfdmFyLmdldCgpLAogICAgICAgICAgICAgICAgInVybHMiOiBzZWxmLnVybGJveC5nZXQoIjEuMCIsIHRrLkVORCksCiAgICAgICAgICAgICAgICAiY29udmVydGVyX2RpciI6IHNlbGYuY29udl9kaXJfdmFyLmdldCgpLAogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYucHJlZnNfbWFuYWdlci5zYXZlX3ByZWZlcmVuY2VzKHByZWZzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MgICMgU2lsZW50IGZhaWwKICAgIAogICAgIyBFdmVudCBoYW5kbGVycwogICAgZGVmIF9vbl92YXJfY2hhbmdlZChzZWxmLCAqYXJncyk6CiAgICAgICAgIiIiSGFuZGxlIHZhcmlhYmxlIGNoYW5nZXMgZm9yIGF1dG8tc2F2ZS4iIiIKICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgIAogICAgZGVmIF9vbl91cmxib3hfbW9kaWZpZWQoc2VsZiwgZXZlbnQ9Tm9uZSk6CiAgICAgICAgIiIiSGFuZGxlIFVSTCBib3ggbW9kaWZpY2F0aW9ucy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYudXJsYm94LmVkaXRfbW9kaWZpZWQoRmFsc2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgCiAgICBkZWYgX29uX2NvbmZpZ3VyZShzZWxmLCBldmVudD1Ob25lKToKICAgICAgICAiIiJIYW5kbGUgd2luZG93IGNvbmZpZ3VyZSBldmVudHMuIiIiCiAgICAgICAgaWYgc2VsZi5fbG9hZGluZ19wcmVmczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBEZWJvdW5jZSBnZW9tZXRyeSBzYXZpbmcKICAgICAgICBpZiBzZWxmLl9nZW9tX3NhdmVfam9iOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmFmdGVyX2NhbmNlbChzZWxmLl9nZW9tX3NhdmVfam9iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIHNlbGYuX2dlb21fc2F2ZV9qb2IgPSBzZWxmLmFmdGVyKDUwMCwgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcykKICAgIAogICAgZGVmIF9vbl9sYW5nX2NoYW5nZShzZWxmLCBldmVudD1Ob25lKToKICAgICAgICAiIiJIYW5kbGUgbGFuZ3VhZ2UgY2hhbmdlLiIiIgogICAgICAgIHNlbGVjdGVkID0gc2VsZi5sYW5nX3Zhci5nZXQoKQogICAgICAgIGlmIFQoImlkIiwgImxhbmdfaWQiKSBpbiBzZWxlY3RlZDoKICAgICAgICAgICAgc2VsZi5sYW5nID0gImlkIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubGFuZyA9ICJlbiIKICAgICAgICAKICAgICAgICBzZWxmLmFwcGx5X2kxOG4oKQogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgCiAgICBkZWYgX29uX2Nsb3NlKHNlbGYpOgogICAgICAgICIiIkhhbmRsZSB3aW5kb3cgY2xvc2UuIiIiCiAgICAgICAgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcygpCiAgICAgICAgc2VsZi5kZXN0cm95KCkKICAgIAogICAgZGVmIF9pbnN0YWxsX3NpZ25hbF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJJbnN0YWxsIHNpZ25hbCBoYW5kbGVycyBmb3IgZ3JhY2VmdWwgc2h1dGRvd24uIiIiCiAgICAgICAgZGVmIHNpZ25hbF9oYW5kbGVyKHNpZ251bSwgZnJhbWUpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5xdWl0KCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNpZ25hbC5zaWduYWwoc2lnbmFsLlNJR0lOVCwgc2lnbmFsX2hhbmRsZXIpCiAgICAgICAgICAgIHNpZ25hbC5zaWduYWwoc2lnbmFsLlNJR1RFUk0sIHNpZ25hbF9oYW5kbGVyKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MgICMgTWF5IG5vdCB3b3JrIG9uIGFsbCBwbGF0Zm9ybXMKICAgIAogICAgIyBVSSBBY3Rpb25zCiAgICBkZWYgYXBwbHlfaTE4bihzZWxmKToKICAgICAgICAiIiJBcHBseSBjdXJyZW50IGxhbmd1YWdlIHRvIGFsbCBVSSBlbGVtZW50cy4iIiIKICAgICAgICBzZWxmLnRpdGxlKFQoc2VsZi5sYW5nLCAiYXBwX3RpdGxlIikpCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgaW50cm8gdGV4dAogICAgICAgIHNlbGYuaW50cm9fbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJpbnRybyIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIGxhYmVscwogICAgICAgIHNlbGYudXJsc19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgInVybHNfbGFiZWwiKSkKICAgICAgICBzZWxmLm91dF9sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm91dHB1dF9sYWJlbCIpKQogICAgICAgIHNlbGYuY2hvb3NlX2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNob29zZSIpKQogICAgICAgIHNlbGYubW9kZV9sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm1vZGVfbGFiZWwiKSkKICAgICAgICBzZWxmLm1vZGVfaGludC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm1vZGVfaGludCIpKQogICAgICAgIHNlbGYudmlkZW9zX2NoZWNrLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAidmlkZW9zX2NoZWNrIikpCiAgICAgICAgc2VsZi5zdGFydF9idG4uY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJidG5fc3RhcnQiKSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBjb252ZXJ0ZXIgc2VjdGlvbgogICAgICAgIHNlbGYuY29udl90aXRsZS5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfdGl0bGUiKSkKICAgICAgICBzZWxmLmNvbnZfc3VidGl0bGUuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X3N1YnRpdGxlIikpCiAgICAgICAgc2VsZi5jb252X3BpY2tfbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X3BpY2tfbGFiZWwiKSkKICAgICAgICBzZWxmLmNvbnZfY2hvb3NlX2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfYnRuX2Nob29zZSIpKQogICAgICAgIHNlbGYuY29udl9zdGFydF9idG4uY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X2J0bl9zdGFydCIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIHByb2dyZXNzIHNlY3Rpb24KICAgICAgICBzZWxmLmxvZ190aXRsZS5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImxvZyIpKQogICAgICAgIHNlbGYuaW1hZ2VzX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAiaW1hZ2VzIikpCiAgICAgICAgc2VsZi52aWRlb3NfbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJ2aWRlb3MiKSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBsYW5ndWFnZSBzZWxlY3RvcgogICAgICAgIHNlbGYubGFuZ192YXIuc2V0KFQoc2VsZi5sYW5nLCAibGFuZ19pZCIgaWYgc2VsZi5sYW5nID09ICJpZCIgZWxzZSAibGFuZ19lbiIpKQogICAgCiAgICBkZWYgcGlja19vdXQoc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIG91dHB1dCBkaXJlY3Rvcnkgc2VsZWN0aW9uLiIiIgogICAgICAgIGZvbGRlciA9IGZpbGVkaWFsb2cuYXNrZGlyZWN0b3J5KHRpdGxlPVQoc2VsZi5sYW5nLCAiY2hvb3NlIikpCiAgICAgICAgaWYgZm9sZGVyOgogICAgICAgICAgICBzZWxmLm91dHZhci5zZXQoZm9sZGVyKQogICAgCiAgICBkZWYgcGlja19jb252X2RpcihzZWxmKToKICAgICAgICAiIiJIYW5kbGUgY29udmVydGVyIGRpcmVjdG9yeSBzZWxlY3Rpb24uIiIiIAogICAgICAgIGZvbGRlciA9IGZpbGVkaWFsb2cuYXNrZGlyZWN0b3J5KHRpdGxlPVQoc2VsZi5sYW5nLCAiY29udl9idG5fY2hvb3NlIikpCiAgICAgICAgaWYgZm9sZGVyOgogICAgICAgICAgICBzZWxmLmNvbnZfZGlyX3Zhci5zZXQoZm9sZGVyKQogICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiU3RhcnQgdGhlIG1haW4gZG93bmxvYWQgcHJvY2VzcyAod2l0aCBwcmUtc2NhbiBwcmV2aWV3KS4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgR2V0IGFuZCB2YWxpZGF0ZSBVUkxzCiAgICAgICAgICAgIHVybHNfdGV4dCA9IHNlbGYudXJsYm94LmdldCgiMS4wIiwgdGsuRU5EKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIG5vdCB1cmxzX3RleHQ6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgIm1pc3NpbmdfdXJsc19tc2ciKSwgVChzZWxmLmxhbmcsICJtaXNzaW5nX3VybHNfbXNnIikpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIHVybHMgPSBbdXJsLnN0cmlwKCkgZm9yIHVybCBpbiB1cmxzX3RleHQuc3BsaXQoJ1xuJykgaWYgdXJsLnN0cmlwKCldCiAgICAgICAgICAgIGlmIG5vdCB1cmxzOgogICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoVChzZWxmLmxhbmcsICJtaXNzaW5nX3VybHNfbXNnIiksIFQoc2VsZi5sYW5nLCAibWlzc2luZ191cmxzX21zZyIpKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIG91dHB1dCBkaXJlY3RvcnkKICAgICAgICAgICAgb3V0ZGlyID0gc2VsZi5vdXR2YXIuZ2V0KCkuc3RyaXAoKQogICAgICAgICAgICBpZiBub3Qgb3V0ZGlyOgogICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoVChzZWxmLmxhbmcsICJtaXNzaW5nX291dF90aXRsZSIpLCBUKHNlbGYubGFuZywgIm1pc3Npbmdfb3V0X21zZyIpKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIGltYWdlIHNpemUKICAgICAgICAgICAgc2l6ZV90ZXh0ID0gc2VsZi5zaXpldmFyLmdldCgpCiAgICAgICAgICAgIGlzX3ZhbGlkLCB3aWR0aCA9IHZhbGlkYXRlX2ltYWdlX3NpemUoc2l6ZV90ZXh0KQogICAgICAgICAgICBpZiBub3QgaXNfdmFsaWQ6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV90aXRsZSIpLCBUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV9tc2ciKSkKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBEZXRlcm1pbmUgaWYgb3JpZ2luYWwgaW1hZ2VzIHJlcXVlc3RlZAogICAgICAgICAgICBpbWdfb3JpZ2luYWwgPSAod2lkdGggPT0gLTEpICAjIC0xIGluZGljYXRlcyBPUklHSU5BTCBtb2RlCiAgICAgICAgICAgIGlmIG5vdCBpbWdfb3JpZ2luYWw6CiAgICAgICAgICAgICAgICB3aWR0aCA9IGludCh3aWR0aCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgcHJvZ3Jlc3MKICAgICAgICAgICAgc2VsZi51cGRhdGVfcHJvZ3Jlc3NfaW1hZ2VzKDAsIDApCiAgICAgICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX3ZpZGVvcygwLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTYXZlIHByZWZlcmVuY2VzIGJlZm9yZSBzdGFydGluZwogICAgICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQWRkIGluaXRpYWwgbG9nIG1lc3NhZ2UKICAgICAgICAgICAgc2VsZi5sb2dfaGFuZGxlci5wdXQoIltHVUldIFN0YXJ0aW5nIHByZS1zY2FuLi4uIikKCiAgICAgICAgICAgICMgU3RvcmUgY29udGV4dCBmb3IgYWZ0ZXIgcHJldmlldyBjb25maXJtCiAgICAgICAgICAgIHNlbGYuX3BlbmRpbmdfc3RhcnRfY3R4ID0gewogICAgICAgICAgICAgICAgInVybHMiOiB1cmxzLAogICAgICAgICAgICAgICAgIm91dGRpciI6IG91dGRpciwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IHdpZHRoLAogICAgICAgICAgICAgICAgImltZ19vcmlnaW5hbCI6IGltZ19vcmlnaW5hbCwKICAgICAgICAgICAgICAgICJkb3dubG9hZF92aWRlb3MiOiBzZWxmLnZpZGVvc192YXIuZ2V0KCksCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgRGlzYWJsZSBTdGFydCBhbmQgZW5hYmxlIENhbmNlbCB3aGlsZSBwcmVzY2FuIHJ1bnMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5zdGFydF9idG4uY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIpCiAgICAgICAgICAgICAgICBzZWxmLmNhbmNlbF9idG4uY29uZmlndXJlKHN0YXRlPSJub3JtYWwiKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgIyBTdGFydCBwcmVzY2FuIHdvcmtlciB0aHJlYWQKICAgICAgICAgICAgc3RhcnRfd29ya2VyX3RocmVhZCgKICAgICAgICAgICAgICAgIHJ1bl9wcmVzY2FuLAogICAgICAgICAgICAgICAgdXJscywgb3V0ZGlyLCBzZWxmLmxvZ19oYW5kbGVyLAogICAgICAgICAgICAgICAgd2lkdGgsIHNlbGYudmlkZW9zX3Zhci5nZXQoKSwgaW1nX29yaWdpbmFsLAogICAgICAgICAgICAgICAgc2VsZiwgc2VsZi5sYW5nCiAgICAgICAgICAgICkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGltcG9ydCB0cmFjZWJhY2sKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJFcnJvciBzdGFydGluZyBkb3dubG9hZDoge2V9XG57dHJhY2ViYWNrLmZvcm1hdF9leGMoKX0iCiAgICAgICAgICAgIHNlbGYubG9nX2hhbmRsZXIucHV0KGVycm9yX21zZykKICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoIlN0YXJ0IEVycm9yIiwgc3RyKGUpKQogICAgCiAgICBkZWYgc3RhcnRfY29udmVydGVyKHNlbGYpOgogICAgICAgICIiIlN0YXJ0IHRoZSB0aHVtYm5haWwgY29udmVydGVyIHByb2Nlc3MuIiIiCiAgICAgICAgbG9jYWxfZGlyID0gc2VsZi5jb252X2Rpcl92YXIuZ2V0KCkuc3RyaXAoKQogICAgICAgIGlmIG5vdCBsb2NhbF9kaXI6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKAogICAgICAgICAgICAgICAgVChzZWxmLmxhbmcsICJtaXNzaW5nX2NvbnZfZGlyX3RpdGxlIiksIAogICAgICAgICAgICAgICAgVChzZWxmLmxhbmcsICJtaXNzaW5nX2NvbnZfZGlyX21zZyIpCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBSZXNldCBwcm9ncmVzcwogICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX2ltYWdlcygwLCAwKQogICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX3ZpZGVvcygwLCAwKQogICAgICAgIAogICAgICAgICMgU3RhcnQgY29udmVydGVyIHdvcmtlcgogICAgICAgIHN0YXJ0X3dvcmtlcl90aHJlYWQoCiAgICAgICAgICAgIHJ1bl9jb252ZXJ0ZXIsCiAgICAgICAgICAgIGxvY2FsX2Rpciwgc2VsZi5sb2dfaGFuZGxlciwgc2VsZi5jb252X3N0YXJ0X2J0biwgc2VsZiwgc2VsZi5sYW5nCiAgICAgICAgKQogICAgCiAgICBkZWYgY2FuY2VsKHNlbGYpOgogICAgICAgICIiIkNhbmNlbCBjdXJyZW50IG9wZXJhdGlvbi4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNldGF0dHIoZGZyLCAiSU5URVJSVVBURUQiLCBUcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIAogICAgZGVmIHNpZ25faW4oc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIHNpZ24gaW4vb3V0LiIiIgogICAgICAgICMgVGhpcyB3aWxsIHRyaWdnZXIgT0F1dGggZmxvdwogICAgICAgIHRyeToKICAgICAgICAgICAgc2VydmljZSwgY3JlZHMgPSBkZnIuZ2V0X3NlcnZpY2VfYW5kX2NyZWRzKGRmci5UT0tFTl9GSUxFLCBkZnIuQ1JFREVOVElBTFNfRklMRSkKICAgICAgICAgICAgYWNjb3VudCA9IGRmci5nZXRfYWNjb3VudF9pbmZvKHNlcnZpY2UpCiAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJlbWFpbCIpOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfYWNjb3VudChhY2NvdW50LmdldCgibmFtZSIsICIiKSwgYWNjb3VudFsiZW1haWwiXSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJTaWduIEluIEVycm9yIiwgZiJGYWlsZWQgdG8gc2lnbiBpbjoge2V9IikKICAgIAogICAgZGVmIHNpZ25fb3V0KHNlbGYpOgogICAgICAgICIiIlNpZ24gb3V0IGFuZCBjbGVhciB0b2tlbi4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBvcwogICAgICAgICAgICBmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKICAgICAgICAgICAgdG9rZW5fcGF0aCA9IFBhdGgoZGZyLlRPS0VOX0ZJTEUpCiAgICAgICAgICAgIGlmIHRva2VuX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgICAgICBiYWNrdXBfcGF0aCA9IHRva2VuX3BhdGgud2l0aF9zdWZmaXgodG9rZW5fcGF0aC5zdWZmaXggKyAiLmJhayIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgYmFja3VwX3BhdGguZXhpc3RzKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJhY2t1cF9wYXRoLnVubGluaygpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRva2VuX3BhdGgucmVuYW1lKGJhY2t1cF9wYXRoKQogICAgICAgICAgICBzZWxmLnNldF9hY2NvdW50KCIiLCAiIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJTaWduIE91dCBFcnJvciIsIGYiRmFpbGVkIHRvIHNpZ24gb3V0OiB7ZX0iKQogICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfYXN5bmMoc2VsZik6CiAgICAgICAgIiIiQ2hlY2sgYWNjb3VudCBzdGF0dXMgaW4gYmFja2dyb3VuZCB0aHJlYWQuIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50ID0gZGZyLnRyeV9nZXRfYWNjb3VudF9pbmZvKGRmci5UT0tFTl9GSUxFLCBkZnIuQ1JFREVOVElBTFNfRklMRSkKICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImVtYWlsIik6CiAgICAgICAgICAgICAgICBzZWxmLmFmdGVyKDAsIGxhbWJkYTogc2VsZi5zZXRfYWNjb3VudChhY2NvdW50LmdldCgibmFtZSIsICIiKSwgYWNjb3VudFsiZW1haWwiXSkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBTaWxlbnQgZmFpbCBmb3IgYmFja2dyb3VuZCBjaGVjawogICAgCiAgICAjIFByb2dyZXNzIHVwZGF0ZXMKICAgIGRlZiBzZXRfYWNjb3VudChzZWxmLCBuYW1lOiBzdHIsIGVtYWlsOiBzdHIpOgogICAgICAgICIiIlVwZGF0ZSBhY2NvdW50IGRpc3BsYXkuIiIiCiAgICAgICAgaWYgZW1haWw6CiAgICAgICAgICAgIGlmIG5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmFjY3RfdmFyLnNldChmIkFjY291bnQ6IHtuYW1lfSA8e2VtYWlsfT4iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hY2N0X3Zhci5zZXQoZiJBY2NvdW50OiB7ZW1haWx9IikKICAgICAgICAgICAgc2VsZi5hdXRoX2J0bi5jb25maWd1cmUodGV4dD0iU2lnbiBvdXQiLCBjb21tYW5kPXNlbGYuc2lnbl9vdXQpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5hY2N0X3Zhci5zZXQoIkFjY291bnQ6IChub3Qgc2lnbmVkIGluKSIpCiAgICAgICAgICAgIHNlbGYuYXV0aF9idG4uY29uZmlndXJlKHRleHQ9IlNpZ24gaW4iLCBjb21tYW5kPXNlbGYuc2lnbl9pbikKICAgIAogICAgZGVmIHVwZGF0ZV9wcm9ncmVzc19pbWFnZXMoc2VsZiwgZG9uZTogaW50LCB0b3RhbDogaW50KToKICAgICAgICAiIiJVcGRhdGUgaW1hZ2UgcHJvZ3Jlc3MgYmFyLiIiIgogICAgICAgIHRvdGFsID0gbWF4KHRvdGFsLCAwKQogICAgICAgIGRvbmUgPSBtaW4obWF4KGRvbmUsIDApLCB0b3RhbCkgaWYgdG90YWwgZWxzZSAwCiAgICAgICAgCiAgICAgICAgc2VsZi5wcm9ncmVzc19pbWFnZXNbIm1heGltdW0iXSA9IHRvdGFsIGlmIHRvdGFsIGVsc2UgMQogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzWyJ2YWx1ZSJdID0gZG9uZQogICAgICAgIAogICAgICAgIHByb2dyZXNzX3RleHQgPSBmIntkb25lfS97dG90YWx9ICh7VChzZWxmLmxhbmcsICdwcm9ncmVzc19sZWZ0Jyl9IHttYXgodG90YWwtZG9uZSwgMCl9KSIKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc192YWx1ZS5jb25maWd1cmUodGV4dD1wcm9ncmVzc190ZXh0KQogICAgICAgIHNlbGYudXBkYXRlX2lkbGV0YXNrcygpCiAgICAKICAgIGRlZiB1cGRhdGVfcHJvZ3Jlc3NfdmlkZW9zKHNlbGYsIGRvbmU6IGludCwgdG90YWw6IGludCk6CiAgICAgICAgIiIiVXBkYXRlIHZpZGVvIHByb2dyZXNzIGJhci4iIiIKICAgICAgICB0b3RhbCA9IG1heCh0b3RhbCwgMCkKICAgICAgICBkb25lID0gbWluKG1heChkb25lLCAwKSwgdG90YWwpIGlmIHRvdGFsIGVsc2UgMAogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zWyJtYXhpbXVtIl0gPSB0b3RhbCBpZiB0b3RhbCBlbHNlIDEKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc1sidmFsdWUiXSA9IGRvbmUKICAgICAgICAKICAgICAgICBwcm9ncmVzc190ZXh0ID0gZiJ7ZG9uZX0ve3RvdGFsfSAoe1Qoc2VsZi5sYW5nLCAncHJvZ3Jlc3NfbGVmdCcpfSB7bWF4KHRvdGFsLWRvbmUsIDApfSkiCiAgICAgICAgc2VsZi5wcm9ncmVzc192aWRlb3NfdmFsdWUuY29uZmlndXJlKHRleHQ9cHJvZ3Jlc3NfdGV4dCkKICAgICAgICBzZWxmLnVwZGF0ZV9pZGxldGFza3MoKQogICAgCiAgICBkZWYgdXBkYXRlX3Byb2dyZXNzX2J5dGVzKHNlbGYsIGJ5dGVzX3dyaXR0ZW46IGludCk6CiAgICAgICAgIiIiVXBkYXRlIGJ5dGVzIHByb2dyZXNzIChpZiBpbXBsZW1lbnRlZCBpbiBVSSkuIiIiCiAgICAgICAgc2VsZi5ieXRlc193cml0dGVuID0gbWF4KDAsIGJ5dGVzX3dyaXR0ZW4pCiAgICAgICAgIyBDb3VsZCBhZGQgYSBieXRlcyBwcm9ncmVzcyBiYXIgaGVyZSBpZiBuZWVkZWQKCiAgICAjIFByZS1zY2FuIHByZXZpZXcgZGlhbG9nCiAgICBkZWYgc2hvd19wcmVzY2FuX3ByZXZpZXcoc2VsZiwgc3VtbWFyaWVzLCB0b3RhbHMsIHRvdGFsX2J5dGVzLCB0YXNrcyk6CiAgICAgICAgIiIiU2hvdyBhIHByZS1zY2FuIHByZXZpZXcgZGlhbG9nIHdpdGggcGVyLWxpbmsgY291bnRzIGFuZCB0b3RhbHMuCiAgICAgICAgc3VtbWFyaWVzOiBsaXN0IG9mIGRpY3RzIGZyb20gZGZyLkxJTktfU1VNTUFSSUVTCiAgICAgICAgdG90YWxzOiBkaWN0IHdpdGgga2V5cyBpbWFnZXMsIHZpZGVvcywgZGF0YSwgaGF2ZV9pbWFnZXMsIGhhdmVfdmlkZW9zLCBoYXZlX2RhdGEKICAgICAgICB0b3RhbF9ieXRlczogaW50IGV4cGVjdGVkIGJ5dGVzIChhcHByb3hpbWF0ZSkKICAgICAgICB0YXNrczogbGlzdCBvZiB0YXNrcyB0byBiZSBwYXNzZWQgZGlyZWN0bHkgdG8gdGhlIG1haW4gd29ya2VyIG9uIGNvbmZpcm0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ2xvc2UgYW55IGV4aXN0aW5nIHByZXZpZXcgd2luZG93CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9wcmVzY2FuX3dpbiIpIGFuZCBzZWxmLl9wcmVzY2FuX3dpbiBhbmQgdGsuVG9wbGV2ZWwud2luZm9fZXhpc3RzKHNlbGYuX3ByZXNjYW5fd2luKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9wcmVzY2FuX3dpbi5kZXN0cm95KCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgc2VsZi5fcHJlc2Nhbl90YXNrcyA9IGxpc3QodGFza3Mgb3IgW10pCgogICAgICAgIHdpbiA9IHRrLlRvcGxldmVsKHNlbGYpCiAgICAgICAgc2VsZi5fcHJlc2Nhbl93aW4gPSB3aW4KICAgICAgICB0cnk6CiAgICAgICAgICAgIHdpbi50aXRsZShUKHNlbGYubGFuZywgInByZXNjYW5fdGl0bGUiKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICB3aW4udGl0bGUoIlByZS1TY2FuIFByZXZpZXciKQogICAgICAgIHdpbi5nZW9tZXRyeSgiODIweDUyMCIpCiAgICAgICAgd2luLm1pbnNpemUoNjgwLCA0MjApCiAgICAgICAgd2luLnRyYW5zaWVudChzZWxmKQogICAgICAgIHdpbi5ncmFiX3NldCgpCgogICAgICAgICMgRGVzY3JpcHRpb24KICAgICAgICBkZXNjID0gdHRrLkxhYmVsKHdpbiwgdGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fZGVzYyIpLCB3cmFwbGVuZ3RoPTc4MCwganVzdGlmeT0ibGVmdCIpCiAgICAgICAgZGVzYy5wYWNrKGFuY2hvcj0idyIsIHBhZHg9MTIsIHBhZHk9KDEyLCA2KSkKCiAgICAgICAgIyBUcmVldmlldyBmb3IgcGVyLWxpbmsgY291bnRzCiAgICAgICAgY29scyA9ICgicm9vdCIsICJpbWFnZXMiLCAidmlkZW9zIiwgImRhdGEiKQogICAgICAgIHRyZWUgPSB0dGsuVHJlZXZpZXcod2luLCBjb2x1bW5zPWNvbHMsIHNob3c9ImhlYWRpbmdzIiwgaGVpZ2h0PTEyKQogICAgICAgIHRyZWUuaGVhZGluZygicm9vdCIsIHRleHQ9VChzZWxmLmxhbmcsICJwcmVzY2FuX2NvbF9yb290IikpCiAgICAgICAgdHJlZS5oZWFkaW5nKCJpbWFnZXMiLCB0ZXh0PVQoc2VsZi5sYW5nLCAicHJlc2Nhbl9jb2xfaW1hZ2VzIikpCiAgICAgICAgdHJlZS5oZWFkaW5nKCJ2aWRlb3MiLCB0ZXh0PVQoc2VsZi5sYW5nLCAicHJlc2Nhbl9jb2xfdmlkZW9zIikpCiAgICAgICAgdHJlZS5oZWFkaW5nKCJkYXRhIiwgdGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fY29sX2RhdGEiKSkKICAgICAgICB0cmVlLmNvbHVtbigicm9vdCIsIHdpZHRoPTMyMCwgYW5jaG9yPSJ3IikKICAgICAgICB0cmVlLmNvbHVtbigiaW1hZ2VzIiwgd2lkdGg9MTQwLCBhbmNob3I9ImNlbnRlciIpCiAgICAgICAgdHJlZS5jb2x1bW4oInZpZGVvcyIsIHdpZHRoPTE0MCwgYW5jaG9yPSJjZW50ZXIiKQogICAgICAgIHRyZWUuY29sdW1uKCJkYXRhIiwgd2lkdGg9MTQwLCBhbmNob3I9ImNlbnRlciIpCgogICAgICAgICMgUG9wdWxhdGUgcm93cwogICAgICAgIGZvciBzIGluIHN1bW1hcmllcyBvciBbXToKICAgICAgICAgICAgcm9vdF9uYW1lID0gcy5nZXQoInJvb3RfbmFtZSIpIG9yIHMuZ2V0KCJ1cmwiKSBvciAiKGxpbmspIgogICAgICAgICAgICBpbWdzID0gZiJ7cy5nZXQoJ2ltYWdlcycsMCl9ICgiICsgVChzZWxmLmxhbmcsICJwcmVzY2FuX2hhdmVfZm10Iiwgbj1zLmdldCgnaW1hZ2VzX2V4aXN0aW5nJywwKSkgKyAiKSIKICAgICAgICAgICAgdmlkcyA9IGYie3MuZ2V0KCd2aWRlb3MnLDApfSAoIiArIFQoc2VsZi5sYW5nLCAicHJlc2Nhbl9oYXZlX2ZtdCIsIG49cy5nZXQoJ3ZpZGVvc19leGlzdGluZycsMCkpICsgIikiCiAgICAgICAgICAgIGRhdGEgPSBmIntzLmdldCgnZGF0YScsMCl9ICgiICsgVChzZWxmLmxhbmcsICJwcmVzY2FuX2hhdmVfZm10Iiwgbj1zLmdldCgnZGF0YV9leGlzdGluZycsMCkpICsgIikiCiAgICAgICAgICAgIHRyZWUuaW5zZXJ0KCIiLCAiZW5kIiwgdmFsdWVzPShyb290X25hbWUsIGltZ3MsIHZpZHMsIGRhdGEpKQogICAgICAgIHRyZWUucGFjayhmaWxsPSJib3RoIiwgZXhwYW5kPVRydWUsIHBhZHg9MTIsIHBhZHk9KDAsIDYpKQoKICAgICAgICAjIFRvdGFscyBsaW5lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZHJpdmVfZmV0Y2hfcmVzaWxpZW50IGFzIGRmcgogICAgICAgICAgICBieXRlc190ZXh0ID0gZGZyLmh1bWFuX2J5dGVzKGludCh0b3RhbF9ieXRlcyBvciAwKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBieXRlc190ZXh0ID0gZiJ7aW50KHRvdGFsX2J5dGVzIG9yIDApfSBCIgoKICAgICAgICB0b3RhbHNfbGFiZWwgPSB0dGsuTGFiZWwoCiAgICAgICAgICAgIHdpbiwKICAgICAgICAgICAgdGV4dD0oCiAgICAgICAgICAgICAgICBmIntUKHNlbGYubGFuZywgJ3ByZXNjYW5fdG90YWxzJyl9OiAiCiAgICAgICAgICAgICAgICBmIntUKHNlbGYubGFuZywnaW1hZ2VzJyl9PXt0b3RhbHMuZ2V0KCdpbWFnZXMnLDApfSAoIiArIFQoc2VsZi5sYW5nLCdwcmVzY2FuX2hhdmVfZm10Jywgbj10b3RhbHMuZ2V0KCdoYXZlX2ltYWdlcycsMCkpICsgIikgfCAiCiAgICAgICAgICAgICAgICBmIntUKHNlbGYubGFuZywndmlkZW9zJyl9PXt0b3RhbHMuZ2V0KCd2aWRlb3MnLDApfSAoIiArIFQoc2VsZi5sYW5nLCdwcmVzY2FuX2hhdmVfZm10Jywgbj10b3RhbHMuZ2V0KCdoYXZlX3ZpZGVvcycsMCkpICsgIikgfCAiCiAgICAgICAgICAgICAgICBmIntUKHNlbGYubGFuZywnZGF0YScpfT17dG90YWxzLmdldCgnZGF0YScsMCl9ICgiICsgVChzZWxmLmxhbmcsJ3ByZXNjYW5faGF2ZV9mbXQnLCBuPXRvdGFscy5nZXQoJ2hhdmVfZGF0YScsMCkpICsgIilcbiIKICAgICAgICAgICAgICAgIGYie1Qoc2VsZi5sYW5nLCAncHJlc2Nhbl9ieXRlc190b3RhbCcpfToge2J5dGVzX3RleHR9IgogICAgICAgICAgICApLAogICAgICAgICAgICBqdXN0aWZ5PSJsZWZ0IiwKICAgICAgICApCiAgICAgICAgdG90YWxzX2xhYmVsLnBhY2soYW5jaG9yPSJ3IiwgcGFkeD0xMiwgcGFkeT0oNCwgMTApKQoKICAgICAgICAjIEJ1dHRvbnMKICAgICAgICBidG5fcm93ID0gdHRrLkZyYW1lKHdpbikKICAgICAgICBidG5fcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDAsIDEyKSkKCiAgICAgICAgZGVmIG9uX2NhbmNlbCgpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aW4uZGVzdHJveSgpCiAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAjIFJlLWVuYWJsZSBTdGFydCwgZGlzYWJsZSBDYW5jZWwKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0X2J0bi5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jYW5jZWxfYnRuLmNvbmZpZ3VyZShzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGRlZiBvbl9zdGFydCgpOgogICAgICAgICAgICAjIElmIHRoZXJlIGFyZSBubyB0YXNrcywgaW5mb3JtIGFuZCBkbyBub3RoaW5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9wcmVzY2FuX3Rhc2tzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2luZm8oVChzZWxmLmxhbmcsICJwcmVzY2FuX3RpdGxlIiksIFQoc2VsZi5sYW5nLCAicHJlc2Nhbl9ub25lIikpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIG9uX2NhbmNlbCgpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgIyBTZXQgZGlyZWN0IHRhc2tzIGFuZCBzdGFydCB0aGUgbWFpbiB3b3JrZXIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaW1wb3J0IGRyaXZlX2ZldGNoX3Jlc2lsaWVudCBhcyBkZnIKICAgICAgICAgICAgICAgIGRmci5zZXRfZGlyZWN0X3Rhc2tzKHNlbGYuX3ByZXNjYW5fdGFza3MpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpbi5kZXN0cm95KCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBTdGFydCB3b3JrZXIgdGhyZWFkIChTdGFydCBpcyBhbHJlYWR5IGRpc2FibGVkKQogICAgICAgICAgICBjdHggPSBnZXRhdHRyKHNlbGYsICJfcGVuZGluZ19zdGFydF9jdHgiLCB7fSkKICAgICAgICAgICAgc3RhcnRfd29ya2VyX3RocmVhZCgKICAgICAgICAgICAgICAgIHJ1bl93b3JrZXIsCiAgICAgICAgICAgICAgICBjdHguZ2V0KCJ1cmxzIiksIGN0eC5nZXQoIm91dGRpciIpLCBzZWxmLmxvZ19oYW5kbGVyLCBzZWxmLnN0YXJ0X2J0biwKICAgICAgICAgICAgICAgIGN0eC5nZXQoIndpZHRoIiksIHNlbGYuX3BlbmRpbmdfc3RhcnRfY3R4LmdldCgiZG93bmxvYWRfdmlkZW9zIiwgVHJ1ZSksIGN0eC5nZXQoImltZ19vcmlnaW5hbCIpLAogICAgICAgICAgICAgICAgc2VsZiwgc2VsZi5sYW5nCiAgICAgICAgICAgICkKCiAgICAgICAgY2FuY2VsX2J1dHRvbiA9IHR0ay5CdXR0b24oYnRuX3JvdywgdGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fYnRuX2NhbmNlbCIpLCBjb21tYW5kPW9uX2NhbmNlbCkKICAgICAgICBjYW5jZWxfYnV0dG9uLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgc3RhcnRfYnV0dG9uID0gdHRrLkJ1dHRvbihidG5fcm93LCB0ZXh0PVQoc2VsZi5sYW5nLCAicHJlc2Nhbl9idG5fc3RhcnQiKSwgY29tbWFuZD1vbl9zdGFydCkKICAgICAgICBzdGFydF9idXR0b24ucGFjayhzaWRlPSJyaWdodCIpCgAAAAAAAAAAgHkAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAA1TsAAAAAAADVOwAAAAAAAAAAAAAAAPC/"
				],
				[
					9,
					1,
					"revert",
					null,
					"AgAAAAAAAAAAAAAAAAAAAAAAAACAeQAAIiIiCk1haW4gYXBwbGljYXRpb24gY2xhc3MgZm9yIHRoZSBvbnRhaG9vZC1kb3dubG9hZGVyIEdVSS4KIiIiCgppbXBvcnQganNvbgppbXBvcnQgb3MKaW1wb3J0IHNpZ25hbAppbXBvcnQgc3lzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHRraW50ZXIgYXMgdGsKZnJvbSB0a2ludGVyIGltcG9ydCB0dGssIHNjcm9sbGVkdGV4dCwgZmlsZWRpYWxvZywgbWVzc2FnZWJveApmcm9tIHR5cGluZyBpbXBvcnQgT3B0aW9uYWwKCmltcG9ydCBkcml2ZV9mZXRjaF9yZXNpbGllbnQgYXMgZGZyCgpmcm9tIC5jb25maWcgaW1wb3J0IERFRkFVTFRfVVJMUwpmcm9tIC5pMThuIGltcG9ydCBUCmZyb20gLmxvZ19oYW5kbGVyIGltcG9ydCBUa0xvZ0hhbmRsZXIKZnJvbSAucHJlZmVyZW5jZXMgaW1wb3J0IFByZWZlcmVuY2VzTWFuYWdlcgpmcm9tIC51dGlscyBpbXBvcnQgbG9jYXRlX2NyZWRlbnRpYWxzLCB2YWxpZGF0ZV9pbWFnZV9zaXplCmZyb20gLndvcmtlcnMgaW1wb3J0IHJ1bl93b3JrZXIsIHJ1bl9jb252ZXJ0ZXIsIHN0YXJ0X3dvcmtlcl90aHJlYWQsIHJ1bl9wcmVzY2FuCgoKY2xhc3MgQXBwKHRrLlRrKToKICAgICIiIk1haW4gYXBwbGljYXRpb24gd2luZG93LiIiIgogICAgCiAgICBTSVpFX09QVElPTlMgPSBbCiAgICAgICAgIjQwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjcwMCAodGh1bWJuYWlsKSIsIAogICAgICAgICIxMDI0ICh0aHVtYm5haWwpIiwKICAgICAgICAiMTYwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjI0MDAgKHRodW1ibmFpbCkiLAogICAgICAgICIzMjAwICh0aHVtYm5haWwpIiwKICAgICAgICAiNDgwMCAodGh1bWJuYWlsKSIsCiAgICAgICAgIjYwMDAgKHRodW1ibmFpbCkiLAogICAgICAgICJPUklHSU5BTCAoZnVsbCBzaXplKSIsCiAgICBdCiAgICAKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCkKICAgICAgICAKICAgICAgICAjIEluaXRpYWxpemUgc3RhdGUKICAgICAgICBzZWxmLl9sb2FkaW5nX3ByZWZzID0gVHJ1ZQogICAgICAgIHNlbGYuX2dlb21fc2F2ZV9qb2IgPSBOb25lCiAgICAgICAgc2VsZi5sYW5nID0gImVuIgogICAgICAgIHNlbGYuZXhwZWN0ZWRfYnl0ZXNfdG90YWwgPSAwCiAgICAgICAgc2VsZi5ieXRlc193cml0dGVuID0gMAogICAgICAgIAogICAgICAgICMgSW5pdGlhbGl6ZSBwcmVmZXJlbmNlcyBtYW5hZ2VyCiAgICAgICAgc2VsZi5wcmVmc19tYW5hZ2VyID0gUHJlZmVyZW5jZXNNYW5hZ2VyKCkKICAgICAgICAKICAgICAgICAjIFNldCB1cCB3aW5kb3cKICAgICAgICBzZWxmLnRpdGxlKFQoc2VsZi5sYW5nLCAiYXBwX3RpdGxlIikpCiAgICAgICAgc2VsZi5nZW9tZXRyeSgiOTgweDk1MCIpCiAgICAgICAgc2VsZi5taW5zaXplKDgyMCwgNzYwKQogICAgICAgIAogICAgICAgICMgQ3JlYXRlIFVJIGNvbXBvbmVudHMKICAgICAgICBzZWxmLl9jcmVhdGVfdWkoKQogICAgICAgIAogICAgICAgICMgTG9hZCBwcmVmZXJlbmNlcyBhbmQgYXBwbHkgbGFuZ3VhZ2UKICAgICAgICBzZWxmLl9sb2FkX3ByZWZlcmVuY2VzKCkKICAgICAgICBzZWxmLmFwcGx5X2kxOG4oKQogICAgICAgIAogICAgICAgICMgU2V0IHVwIGV2ZW50IGhhbmRsZXJzCiAgICAgICAgc2VsZi5fc2V0dXBfZXZlbnRfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgQ2hlY2sgYWNjb3VudCBzdGF0dXMgaW4gYmFja2dyb3VuZAogICAgICAgIHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuX2NoZWNrX2FjY291bnRfYXN5bmMsIGRhZW1vbj1UcnVlKS5zdGFydCgpCiAgICAgICAgCiAgICAgICAgIyBEb25lIGxvYWRpbmcKICAgICAgICBzZWxmLl9sb2FkaW5nX3ByZWZzID0gRmFsc2UKICAgIAogICAgZGVmIF9jcmVhdGVfdWkoc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBtYWluIFVJIGNvbXBvbmVudHMuIiIiCiAgICAgICAgIyBUb3AgYmFyIHdpdGggbGFuZ3VhZ2UgYW5kIGFjY291bnQKICAgICAgICBzZWxmLl9jcmVhdGVfdG9wX2JhcigpCiAgICAgICAgCiAgICAgICAgIyBNYWluIGludHJvIHRleHQKICAgICAgICBzZWxmLmludHJvX2xhYmVsID0gdHRrLkxhYmVsKHNlbGYsIHdyYXBsZW5ndGg9OTQwLCBqdXN0aWZ5PSJsZWZ0IikKICAgICAgICBzZWxmLmludHJvX2xhYmVsLnBhY2soYW5jaG9yPSJ3IiwgcGFkeD0xMiwgcGFkeT0oMTIsIDYpKQogICAgICAgIAogICAgICAgICMgRG93bmxvYWRlciBzZWN0aW9uCiAgICAgICAgc2VsZi5fY3JlYXRlX2Rvd25sb2FkZXJfc2VjdGlvbigpCiAgICAgICAgCiAgICAgICAgIyBTZXBhcmF0b3IKICAgICAgICBzZXAgPSB0dGsuU2VwYXJhdG9yKHNlbGYsIG9yaWVudD0iaG9yaXpvbnRhbCIpCiAgICAgICAgc2VwLnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDYsIDgpKQogICAgICAgIAogICAgICAgICMgQ29udmVydGVyIHNlY3Rpb24KICAgICAgICBzZWxmLl9jcmVhdGVfY29udmVydGVyX3NlY3Rpb24oKQogICAgICAgIAogICAgICAgICMgTG9ncyBhbmQgcHJvZ3Jlc3Mgc2VjdGlvbgogICAgICAgIHNlbGYuX2NyZWF0ZV9sb2dzX3NlY3Rpb24oKQogICAgICAgIHNlbGYuX2NyZWF0ZV9wcm9ncmVzc19zZWN0aW9uKCkKICAgIAogICAgZGVmIF9jcmVhdGVfdG9wX2JhcihzZWxmKToKICAgICAgICAiIiJDcmVhdGUgdGhlIHRvcCBiYXIgd2l0aCBsYW5ndWFnZSBzZWxlY3RvciBhbmQgYWNjb3VudCBpbmZvLiIiIgogICAgICAgIHRvcGJhciA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIHRvcGJhci5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgxMCwgMCkpCiAgICAgICAgCiAgICAgICAgIyBMYW5ndWFnZSBzZWxlY3RvcgogICAgICAgIHR0ay5MYWJlbCh0b3BiYXIsIHRleHQ9VChzZWxmLmxhbmcsICJsYW5ndWFnZSIpKS5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIHNlbGYubGFuZ192YXIgPSB0ay5TdHJpbmdWYXIodmFsdWU9VChzZWxmLmxhbmcsICJsYW5nX2VuIikpCiAgICAgICAgc2VsZi5sYW5nX2JveCA9IHR0ay5Db21ib2JveCgKICAgICAgICAgICAgdG9wYmFyLCB0ZXh0dmFyaWFibGU9c2VsZi5sYW5nX3ZhciwKICAgICAgICAgICAgdmFsdWVzPVtUKCJlbiIsICJsYW5nX2VuIiksIFQoImlkIiwgImxhbmdfaWQiKV0sIAogICAgICAgICAgICB3aWR0aD0yMiwgc3RhdGU9InJlYWRvbmx5IgogICAgICAgICkKICAgICAgICBzZWxmLmxhbmdfYm94LnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9KDgsIDApKQogICAgICAgIHNlbGYubGFuZ19ib3guYmluZCgiPDxDb21ib2JveFNlbGVjdGVkPj4iLCBzZWxmLl9vbl9sYW5nX2NoYW5nZSkKICAgICAgICAKICAgICAgICAjIEFjY291bnQgaW5mbwogICAgICAgIHNlbGYuYWNjdF92YXIgPSB0ay5TdHJpbmdWYXIodmFsdWU9IkFjY291bnQ6IChub3Qgc2lnbmVkIGluKSIpCiAgICAgICAgc2VsZi5hY2N0X2xhYmVsID0gdHRrLkxhYmVsKHRvcGJhciwgdGV4dHZhcmlhYmxlPXNlbGYuYWNjdF92YXIpCiAgICAgICAgc2VsZi5hY2N0X2xhYmVsLnBhY2soc2lkZT0icmlnaHQiKQogICAgICAgIAogICAgICAgIHNlbGYuYXV0aF9idG4gPSB0dGsuQnV0dG9uKHRvcGJhciwgdGV4dD0iU2lnbiBpbiIsIGNvbW1hbmQ9c2VsZi5zaWduX2luKQogICAgICAgIHNlbGYuYXV0aF9idG4ucGFjayhzaWRlPSJyaWdodCIsIHBhZHg9KDAsIDgpKQogICAgCiAgICBkZWYgX2NyZWF0ZV9kb3dubG9hZGVyX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSBtYWluIGRvd25sb2FkZXIgc2VjdGlvbi4iIiIKICAgICAgICAjIFVSTHMgaW5wdXQKICAgICAgICBzZWxmLnVybHNfbGFiZWwgPSB0dGsuTGFiZWwoc2VsZikKICAgICAgICBzZWxmLnVybHNfbGFiZWwucGFjayhhbmNob3I9InciLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYudXJsYm94ID0gc2Nyb2xsZWR0ZXh0LlNjcm9sbGVkVGV4dChzZWxmLCBoZWlnaHQ9NikKICAgICAgICBzZWxmLnVybGJveC5pbnNlcnQoIjEuMCIsICJcbiIuam9pbihERUZBVUxUX1VSTFMpICsgIlxuIikKICAgICAgICBzZWxmLnVybGJveC5wYWNrKGZpbGw9IngiLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgICMgT3V0cHV0IGRpcmVjdG9yeSBzZWxlY3Rpb24KICAgICAgICBvdXRfcm93ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgb3V0X3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYub3V0X2xhYmVsID0gdHRrLkxhYmVsKG91dF9yb3cpCiAgICAgICAgc2VsZi5vdXRfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLm91dHZhciA9IHRrLlN0cmluZ1ZhcigpCiAgICAgICAgc2VsZi5vdXRfZW50cnkgPSB0dGsuRW50cnkob3V0X3JvdywgdGV4dHZhcmlhYmxlPXNlbGYub3V0dmFyKQogICAgICAgIHNlbGYub3V0X2VudHJ5LnBhY2soc2lkZT0ibGVmdCIsIGZpbGw9IngiLCBleHBhbmQ9VHJ1ZSwgcGFkeD04KQogICAgICAgIAogICAgICAgIHNlbGYuY2hvb3NlX2J0biA9IHR0ay5CdXR0b24ob3V0X3JvdywgY29tbWFuZD1zZWxmLnBpY2tfb3V0KQogICAgICAgIHNlbGYuY2hvb3NlX2J0bi5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgICMgSW1hZ2UgbW9kZSBzZWxlY3Rpb24KICAgICAgICBtb2RlX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIG1vZGVfcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgc2VsZi5tb2RlX2xhYmVsID0gdHRrLkxhYmVsKG1vZGVfcm93KQogICAgICAgIHNlbGYubW9kZV9sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYuc2l6ZXZhciA9IHRrLlN0cmluZ1Zhcih2YWx1ZT1zZWxmLlNJWkVfT1BUSU9OU1sxXSkKICAgICAgICB0dGsuQ29tYm9ib3goCiAgICAgICAgICAgIG1vZGVfcm93LCB0ZXh0dmFyaWFibGU9c2VsZi5zaXpldmFyLCAKICAgICAgICAgICAgdmFsdWVzPXNlbGYuU0laRV9PUFRJT05TLCB3aWR0aD0yOCwgc3RhdGU9InJlYWRvbmx5IgogICAgICAgICkucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD04KQogICAgICAgIAogICAgICAgIHNlbGYubW9kZV9oaW50ID0gdHRrLkxhYmVsKG1vZGVfcm93KQogICAgICAgIHNlbGYubW9kZV9oaW50LnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9MTIpCiAgICAgICAgCiAgICAgICAgIyBWaWRlbyBkb3dubG9hZCBvcHRpb24KICAgICAgICB2aWRlb19yb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICB2aWRlb19yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMCwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYudmlkZW9zX3ZhciA9IHRrLkJvb2xlYW5WYXIodmFsdWU9VHJ1ZSkKICAgICAgICBzZWxmLnZpZGVvc19jaGVjayA9IHR0ay5DaGVja2J1dHRvbih2aWRlb19yb3csIHZhcmlhYmxlPXNlbGYudmlkZW9zX3ZhcikKICAgICAgICBzZWxmLnZpZGVvc19jaGVjay5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgICMgQ29udHJvbCBidXR0b25zCiAgICAgICAgYnRuX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIGJ0bl9yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMiwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYuc3RhcnRfYnRuID0gdHRrLkJ1dHRvbihidG5fcm93LCBjb21tYW5kPXNlbGYuc3RhcnQpCiAgICAgICAgc2VsZi5zdGFydF9idG4ucGFjayhzaWRlPSJyaWdodCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5jYW5jZWxfYnRuID0gdHRrLkJ1dHRvbigKICAgICAgICAgICAgYnRuX3JvdywgdGV4dD0iQ2FuY2VsIiwgY29tbWFuZD1zZWxmLmNhbmNlbCwgc3RhdGU9ImRpc2FibGVkIgogICAgICAgICkKICAgICAgICBzZWxmLmNhbmNlbF9idG4ucGFjayhzaWRlPSJsZWZ0IikKICAgIAogICAgZGVmIF9jcmVhdGVfY29udmVydGVyX3NlY3Rpb24oc2VsZik6CiAgICAgICAgIiIiQ3JlYXRlIHRoZSB0aHVtYm5haWwgY29udmVydGVyIHNlY3Rpb24uIiIiCiAgICAgICAgIyBTZWN0aW9uIHRpdGxlIGFuZCBzdWJ0aXRsZQogICAgICAgIGNvbnZfYm94ID0gdHRrLkZyYW1lKHNlbGYpCiAgICAgICAgY29udl9ib3gucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oNCwgNikpCiAgICAgICAgCiAgICAgICAgc2VsZi5jb252X3RpdGxlID0gdHRrLkxhYmVsKGNvbnZfYm94LCBmb250PSgiVGtEZWZhdWx0Rm9udCIsIDExLCAiYm9sZCIpKQogICAgICAgIHNlbGYuY29udl90aXRsZS5wYWNrKGFuY2hvcj0idyIpCiAgICAgICAgCiAgICAgICAgc2VsZi5jb252X3N1YnRpdGxlID0gdHRrLkxhYmVsKGNvbnZfYm94LCB3cmFwbGVuZ3RoPTk0MCwganVzdGlmeT0ibGVmdCIpCiAgICAgICAgc2VsZi5jb252X3N1YnRpdGxlLnBhY2soYW5jaG9yPSJ3IiwgcGFkeT0oNCwgOCkpCiAgICAgICAgCiAgICAgICAgIyBEaXJlY3Rvcnkgc2VsZWN0aW9uCiAgICAgICAgY29udl9yb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBjb252X3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSgwLCA0KSkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfcGlja19sYWJlbCA9IHR0ay5MYWJlbChjb252X3JvdykKICAgICAgICBzZWxmLmNvbnZfcGlja19sYWJlbC5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIAogICAgICAgIHNlbGYuY29udl9kaXJfdmFyID0gdGsuU3RyaW5nVmFyKCkKICAgICAgICBzZWxmLmNvbnZfZGlyX2VudHJ5ID0gdHRrLkVudHJ5KGNvbnZfcm93LCB0ZXh0dmFyaWFibGU9c2VsZi5jb252X2Rpcl92YXIpCiAgICAgICAgc2VsZi5jb252X2Rpcl9lbnRyeS5wYWNrKHNpZGU9ImxlZnQiLCBmaWxsPSJ4IiwgZXhwYW5kPVRydWUsIHBhZHg9OCkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfY2hvb3NlX2J0biA9IHR0ay5CdXR0b24oY29udl9yb3csIGNvbW1hbmQ9c2VsZi5waWNrX2NvbnZfZGlyKQogICAgICAgIHNlbGYuY29udl9jaG9vc2VfYnRuLnBhY2soc2lkZT0ibGVmdCIpCiAgICAgICAgCiAgICAgICAgIyBDb252ZXJ0IGJ1dHRvbgogICAgICAgIGNvbnZfYnRuX3JvdyA9IHR0ay5GcmFtZShzZWxmKQogICAgICAgIGNvbnZfYnRuX3Jvdy5wYWNrKGZpbGw9IngiLCBwYWR4PTEyLCBwYWR5PSg0LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLmNvbnZfc3RhcnRfYnRuID0gdHRrLkJ1dHRvbihjb252X2J0bl9yb3csIGNvbW1hbmQ9c2VsZi5zdGFydF9jb252ZXJ0ZXIpCiAgICAgICAgc2VsZi5jb252X3N0YXJ0X2J0bi5wYWNrKHNpZGU9InJpZ2h0IikKICAgIAogICAgZGVmIF9jcmVhdGVfbG9nc19zZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSB0aGUgbG9ncyBzZWN0aW9uLiIiIgogICAgICAgIHNlbGYubG9nX3RpdGxlID0gdHRrLkxhYmVsKHNlbGYpCiAgICAgICAgc2VsZi5sb2dfdGl0bGUucGFjayhhbmNob3I9InciLCBwYWR4PTEyKQogICAgICAgIAogICAgICAgIHNlbGYubG9ncyA9IHNjcm9sbGVkdGV4dC5TY3JvbGxlZFRleHQoc2VsZiwgaGVpZ2h0PTE2LCBzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgIHNlbGYubG9ncy5wYWNrKGZpbGw9ImJvdGgiLCBleHBhbmQ9VHJ1ZSwgcGFkeD0xMiwgcGFkeT0oMCwgMTApKQogICAgICAgIAogICAgICAgIHNlbGYubG9nX2hhbmRsZXIgPSBUa0xvZ0hhbmRsZXIoc2VsZi5sb2dzKQogICAgICAgIHNlbGYubG9nX2hhbmRsZXIucHV0KCIyMDI1LTEwLTAyIDAwOjAwOjAwIHwgSU5GTyAgICB8IFtHVUldIEFwcGxpY2F0aW9uIHN0YXJ0ZWQgLSBsb2dnaW5nIHN5c3RlbSBhY3RpdmUiKQogICAgCiAgICBkZWYgX2NyZWF0ZV9wcm9ncmVzc19zZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkNyZWF0ZSB0aGUgcHJvZ3Jlc3MgYmFycyBzZWN0aW9uLiIiIgogICAgICAgIHByb3cgPSB0dGsuRnJhbWUoc2VsZikKICAgICAgICBwcm93LnBhY2soZmlsbD0ieCIsIHBhZHg9MTIsIHBhZHk9KDAsIDEyKSkKICAgICAgICAKICAgICAgICAjIEltYWdlcyBwcm9ncmVzcwogICAgICAgIGltZ19mcmFtZSA9IHR0ay5GcmFtZShwcm93KQogICAgICAgIGltZ19mcmFtZS5wYWNrKGZpbGw9IngiLCBwYWR5PSgwLCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLmltYWdlc19sYWJlbCA9IHR0ay5MYWJlbChpbWdfZnJhbWUpCiAgICAgICAgc2VsZi5pbWFnZXNfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlcyA9IHR0ay5Qcm9ncmVzc2JhcihpbWdfZnJhbWUsIGxlbmd0aD01MjAsIG1vZGU9ImRldGVybWluYXRlIikKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlcy5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PSg4LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc192YWx1ZSA9IHR0ay5MYWJlbChpbWdfZnJhbWUsIHRleHQ9IjAvMCIpCiAgICAgICAgc2VsZi5wcm9ncmVzc19pbWFnZXNfdmFsdWUucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICAjIFZpZGVvcyBwcm9ncmVzcwogICAgICAgIHZpZF9mcmFtZSA9IHR0ay5GcmFtZShwcm93KQogICAgICAgIHZpZF9mcmFtZS5wYWNrKGZpbGw9IngiLCBwYWR5PSgwLCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLnZpZGVvc19sYWJlbCA9IHR0ay5MYWJlbCh2aWRfZnJhbWUpCiAgICAgICAgc2VsZi52aWRlb3NfbGFiZWwucGFjayhzaWRlPSJsZWZ0IikKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvcyA9IHR0ay5Qcm9ncmVzc2Jhcih2aWRfZnJhbWUsIGxlbmd0aD01MjAsIG1vZGU9ImRldGVybWluYXRlIikKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvcy5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PSg4LCA4KSkKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc192YWx1ZSA9IHR0ay5MYWJlbCh2aWRfZnJhbWUsIHRleHQ9IjAvMCIpCiAgICAgICAgc2VsZi5wcm9ncmVzc192aWRlb3NfdmFsdWUucGFjayhzaWRlPSJsZWZ0IikKICAgIAogICAgZGVmIF9zZXR1cF9ldmVudF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJTZXQgdXAgZXZlbnQgaGFuZGxlcnMgYW5kIGJpbmRpbmdzLiIiIgogICAgICAgICMgVmFyaWFibGUgY2hhbmdlIHRyYWNraW5nIGZvciBhdXRvLXNhdmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYub3V0dmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkKICAgICAgICAgICAgc2VsZi5zaXpldmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkgCiAgICAgICAgICAgIHNlbGYudmlkZW9zX3Zhci50cmFjZV9hZGQoJ3dyaXRlJywgc2VsZi5fb25fdmFyX2NoYW5nZWQpCiAgICAgICAgICAgIHNlbGYuY29udl9kaXJfdmFyLnRyYWNlX2FkZCgnd3JpdGUnLCBzZWxmLl9vbl92YXJfY2hhbmdlZCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgCiAgICAgICAgIyBVUkwgYm94IG1vZGlmaWNhdGlvbiB0cmFja2luZwogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi51cmxib3guYmluZCgnPDxNb2RpZmllZD4+Jywgc2VsZi5fb25fdXJsYm94X21vZGlmaWVkKQogICAgICAgICAgICBzZWxmLnVybGJveC5lZGl0X21vZGlmaWVkKEZhbHNlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAKICAgICAgICAjIFdpbmRvdyBnZW9tZXRyeSBjaGFuZ2VzCiAgICAgICAgc2VsZi5iaW5kKCc8Q29uZmlndXJlPicsIHNlbGYuX29uX2NvbmZpZ3VyZSkKICAgICAgICAKICAgICAgICAjIFdpbmRvdyBjbG9zZSBoYW5kbGVyCiAgICAgICAgc2VsZi5wcm90b2NvbCgiV01fREVMRVRFX1dJTkRPVyIsIHNlbGYuX29uX2Nsb3NlKQogICAgICAgIAogICAgICAgICMgU2lnbmFsIGhhbmRsZXJzIGZvciBncmFjZWZ1bCBzaHV0ZG93bgogICAgICAgIHNlbGYuX2luc3RhbGxfc2lnbmFsX2hhbmRsZXJzKCkKICAgIAogICAgZGVmIF9sb2FkX3ByZWZlcmVuY2VzKHNlbGYpOgogICAgICAgICIiIkxvYWQgdXNlciBwcmVmZXJlbmNlcy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByZWZzID0gc2VsZi5wcmVmc19tYW5hZ2VyLmxvYWRfcHJlZmVyZW5jZXMoKQogICAgICAgICAgICBwcmVmcyA9IHNlbGYucHJlZnNfbWFuYWdlci52YWxpZGF0ZV9wcmVmZXJlbmNlcyhwcmVmcykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQXBwbHkgcHJlZmVyZW5jZXMKICAgICAgICAgICAgc2VsZi5sYW5nID0gcHJlZnMuZ2V0KCJsYW5ndWFnZSIsICJlbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBwcmVmcy5nZXQoImdlb21ldHJ5Iik6CiAgICAgICAgICAgICAgICBzZWxmLmdlb21ldHJ5KHByZWZzWyJnZW9tZXRyeSJdKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJvdXRwdXRfZGlyIik6CiAgICAgICAgICAgICAgICBzZWxmLm91dHZhci5zZXQocHJlZnNbIm91dHB1dF9kaXIiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByZWZzLmdldCgiaW1hZ2VfbW9kZSIpOgogICAgICAgICAgICAgICAgc2VsZi5zaXpldmFyLnNldChwcmVmc1siaW1hZ2VfbW9kZSJdKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi52aWRlb3NfdmFyLnNldChwcmVmcy5nZXQoImRvd25sb2FkX3ZpZGVvcyIsIFRydWUpKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcHJlZnMuZ2V0KCJ1cmxzIik6CiAgICAgICAgICAgICAgICBzZWxmLnVybGJveC5kZWxldGUoIjEuMCIsIHRrLkVORCkKICAgICAgICAgICAgICAgIHNlbGYudXJsYm94Lmluc2VydCgiMS4wIiwgcHJlZnNbInVybHMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByZWZzLmdldCgiY29udmVydGVyX2RpciIpOgogICAgICAgICAgICAgICAgc2VsZi5jb252X2Rpcl92YXIuc2V0KHByZWZzWyJjb252ZXJ0ZXJfZGlyIl0pCiAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcyAgIyBVc2UgZGVmYXVsdHMgaWYgbG9hZGluZyBmYWlscwogICAgCiAgICBkZWYgX3NhdmVfcHJlZmVyZW5jZXMoc2VsZik6CiAgICAgICAgIiIiU2F2ZSBjdXJyZW50IHByZWZlcmVuY2VzLiIiIgogICAgICAgIGlmIHNlbGYuX2xvYWRpbmdfcHJlZnM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgcHJlZnMgPSB7CiAgICAgICAgICAgICAgICAiZ2VvbWV0cnkiOiBzZWxmLmdlb21ldHJ5KCksCiAgICAgICAgICAgICAgICAibGFuZ3VhZ2UiOiBzZWxmLmxhbmcsCiAgICAgICAgICAgICAgICAib3V0cHV0X2RpciI6IHNlbGYub3V0dmFyLmdldCgpLAogICAgICAgICAgICAgICAgImltYWdlX21vZGUiOiBzZWxmLnNpemV2YXIuZ2V0KCksCiAgICAgICAgICAgICAgICAiZG93bmxvYWRfdmlkZW9zIjogc2VsZi52aWRlb3NfdmFyLmdldCgpLAogICAgICAgICAgICAgICAgInVybHMiOiBzZWxmLnVybGJveC5nZXQoIjEuMCIsIHRrLkVORCksCiAgICAgICAgICAgICAgICAiY29udmVydGVyX2RpciI6IHNlbGYuY29udl9kaXJfdmFyLmdldCgpLAogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYucHJlZnNfbWFuYWdlci5zYXZlX3ByZWZlcmVuY2VzKHByZWZzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MgICMgU2lsZW50IGZhaWwKICAgIAogICAgIyBFdmVudCBoYW5kbGVycwogICAgZGVmIF9vbl92YXJfY2hhbmdlZChzZWxmLCAqYXJncyk6CiAgICAgICAgIiIiSGFuZGxlIHZhcmlhYmxlIGNoYW5nZXMgZm9yIGF1dG8tc2F2ZS4iIiIKICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgIAogICAgZGVmIF9vbl91cmxib3hfbW9kaWZpZWQoc2VsZiwgZXZlbnQ9Tm9uZSk6CiAgICAgICAgIiIiSGFuZGxlIFVSTCBib3ggbW9kaWZpY2F0aW9ucy4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYudXJsYm94LmVkaXRfbW9kaWZpZWQoRmFsc2UpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgCiAgICBkZWYgX29uX2NvbmZpZ3VyZShzZWxmLCBldmVudD1Ob25lKToKICAgICAgICAiIiJIYW5kbGUgd2luZG93IGNvbmZpZ3VyZSBldmVudHMuIiIiCiAgICAgICAgaWYgc2VsZi5fbG9hZGluZ19wcmVmczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgIyBEZWJvdW5jZSBnZW9tZXRyeSBzYXZpbmcKICAgICAgICBpZiBzZWxmLl9nZW9tX3NhdmVfam9iOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmFmdGVyX2NhbmNlbChzZWxmLl9nZW9tX3NhdmVfam9iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIAogICAgICAgIHNlbGYuX2dlb21fc2F2ZV9qb2IgPSBzZWxmLmFmdGVyKDUwMCwgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcykKICAgIAogICAgZGVmIF9vbl9sYW5nX2NoYW5nZShzZWxmLCBldmVudD1Ob25lKToKICAgICAgICAiIiJIYW5kbGUgbGFuZ3VhZ2UgY2hhbmdlLiIiIgogICAgICAgIHNlbGVjdGVkID0gc2VsZi5sYW5nX3Zhci5nZXQoKQogICAgICAgIGlmIFQoImlkIiwgImxhbmdfaWQiKSBpbiBzZWxlY3RlZDoKICAgICAgICAgICAgc2VsZi5sYW5nID0gImlkIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYubGFuZyA9ICJlbiIKICAgICAgICAKICAgICAgICBzZWxmLmFwcGx5X2kxOG4oKQogICAgICAgIHNlbGYuX3NhdmVfcHJlZmVyZW5jZXMoKQogICAgCiAgICBkZWYgX29uX2Nsb3NlKHNlbGYpOgogICAgICAgICIiIkhhbmRsZSB3aW5kb3cgY2xvc2UuIiIiCiAgICAgICAgc2VsZi5fc2F2ZV9wcmVmZXJlbmNlcygpCiAgICAgICAgc2VsZi5kZXN0cm95KCkKICAgIAogICAgZGVmIF9pbnN0YWxsX3NpZ25hbF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJJbnN0YWxsIHNpZ25hbCBoYW5kbGVycyBmb3IgZ3JhY2VmdWwgc2h1dGRvd24uIiIiCiAgICAgICAgZGVmIHNpZ25hbF9oYW5kbGVyKHNpZ251bSwgZnJhbWUpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5xdWl0KCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNpZ25hbC5zaWduYWwoc2lnbmFsLlNJR0lOVCwgc2lnbmFsX2hhbmRsZXIpCiAgICAgICAgICAgIHNpZ25hbC5zaWduYWwoc2lnbmFsLlNJR1RFUk0sIHNpZ25hbF9oYW5kbGVyKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MgICMgTWF5IG5vdCB3b3JrIG9uIGFsbCBwbGF0Zm9ybXMKICAgIAogICAgIyBVSSBBY3Rpb25zCiAgICBkZWYgYXBwbHlfaTE4bihzZWxmKToKICAgICAgICAiIiJBcHBseSBjdXJyZW50IGxhbmd1YWdlIHRvIGFsbCBVSSBlbGVtZW50cy4iIiIKICAgICAgICBzZWxmLnRpdGxlKFQoc2VsZi5sYW5nLCAiYXBwX3RpdGxlIikpCiAgICAgICAgCiAgICAgICAgIyBVcGRhdGUgaW50cm8gdGV4dAogICAgICAgIHNlbGYuaW50cm9fbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJpbnRybyIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIGxhYmVscwogICAgICAgIHNlbGYudXJsc19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgInVybHNfbGFiZWwiKSkKICAgICAgICBzZWxmLm91dF9sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm91dHB1dF9sYWJlbCIpKQogICAgICAgIHNlbGYuY2hvb3NlX2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNob29zZSIpKQogICAgICAgIHNlbGYubW9kZV9sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm1vZGVfbGFiZWwiKSkKICAgICAgICBzZWxmLm1vZGVfaGludC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgIm1vZGVfaGludCIpKQogICAgICAgIHNlbGYudmlkZW9zX2NoZWNrLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAidmlkZW9zX2NoZWNrIikpCiAgICAgICAgc2VsZi5zdGFydF9idG4uY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJidG5fc3RhcnQiKSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBjb252ZXJ0ZXIgc2VjdGlvbgogICAgICAgIHNlbGYuY29udl90aXRsZS5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfdGl0bGUiKSkKICAgICAgICBzZWxmLmNvbnZfc3VidGl0bGUuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X3N1YnRpdGxlIikpCiAgICAgICAgc2VsZi5jb252X3BpY2tfbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X3BpY2tfbGFiZWwiKSkKICAgICAgICBzZWxmLmNvbnZfY2hvb3NlX2J0bi5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImNvbnZfYnRuX2Nob29zZSIpKQogICAgICAgIHNlbGYuY29udl9zdGFydF9idG4uY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJjb252X2J0bl9zdGFydCIpKQogICAgICAgIAogICAgICAgICMgVXBkYXRlIHByb2dyZXNzIHNlY3Rpb24KICAgICAgICBzZWxmLmxvZ190aXRsZS5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgImxvZyIpKQogICAgICAgIHNlbGYuaW1hZ2VzX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PVQoc2VsZi5sYW5nLCAiaW1hZ2VzIikpCiAgICAgICAgc2VsZi52aWRlb3NfbGFiZWwuY29uZmlndXJlKHRleHQ9VChzZWxmLmxhbmcsICJ2aWRlb3MiKSkKICAgICAgICAKICAgICAgICAjIFVwZGF0ZSBsYW5ndWFnZSBzZWxlY3RvcgogICAgICAgIHNlbGYubGFuZ192YXIuc2V0KFQoc2VsZi5sYW5nLCAibGFuZ19pZCIgaWYgc2VsZi5sYW5nID09ICJpZCIgZWxzZSAibGFuZ19lbiIpKQogICAgCiAgICBkZWYgcGlja19vdXQoc2VsZik6CiAgICAgICAgIiIiSGFuZGxlIG91dHB1dCBkaXJlY3Rvcnkgc2VsZWN0aW9uLiIiIgogICAgICAgIGZvbGRlciA9IGZpbGVkaWFsb2cuYXNrZGlyZWN0b3J5KHRpdGxlPVQoc2VsZi5sYW5nLCAiY2hvb3NlIikpCiAgICAgICAgaWYgZm9sZGVyOgogICAgICAgICAgICBzZWxmLm91dHZhci5zZXQoZm9sZGVyKQogICAgCiAgICBkZWYgcGlja19jb252X2RpcihzZWxmKToKICAgICAgICAiIiJIYW5kbGUgY29udmVydGVyIGRpcmVjdG9yeSBzZWxlY3Rpb24uIiIiIAogICAgICAgIGZvbGRlciA9IGZpbGVkaWFsb2cuYXNrZGlyZWN0b3J5KHRpdGxlPVQoc2VsZi5sYW5nLCAiY29udl9idG5fY2hvb3NlIikpCiAgICAgICAgaWYgZm9sZGVyOgogICAgICAgICAgICBzZWxmLmNvbnZfZGlyX3Zhci5zZXQoZm9sZGVyKQogICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiU3RhcnQgdGhlIG1haW4gZG93bmxvYWQgcHJvY2VzcyAod2l0aCBwcmUtc2NhbiBwcmV2aWV3KS4iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgR2V0IGFuZCB2YWxpZGF0ZSBVUkxzCiAgICAgICAgICAgIHVybHNfdGV4dCA9IHNlbGYudXJsYm94LmdldCgiMS4wIiwgdGsuRU5EKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIG5vdCB1cmxzX3RleHQ6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgIm1pc3NpbmdfdXJsc19tc2ciKSwgVChzZWxmLmxhbmcsICJtaXNzaW5nX3VybHNfbXNnIikpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIHVybHMgPSBbdXJsLnN0cmlwKCkgZm9yIHVybCBpbiB1cmxzX3RleHQuc3BsaXQoJ1xuJykgaWYgdXJsLnN0cmlwKCldCiAgICAgICAgICAgIGlmIG5vdCB1cmxzOgogICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoVChzZWxmLmxhbmcsICJtaXNzaW5nX3VybHNfbXNnIiksIFQoc2VsZi5sYW5nLCAibWlzc2luZ191cmxzX21zZyIpKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIG91dHB1dCBkaXJlY3RvcnkKICAgICAgICAgICAgb3V0ZGlyID0gc2VsZi5vdXR2YXIuZ2V0KCkuc3RyaXAoKQogICAgICAgICAgICBpZiBub3Qgb3V0ZGlyOgogICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93ZXJyb3IoVChzZWxmLmxhbmcsICJtaXNzaW5nX291dF90aXRsZSIpLCBUKHNlbGYubGFuZywgIm1pc3Npbmdfb3V0X21zZyIpKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIGltYWdlIHNpemUKICAgICAgICAgICAgc2l6ZV90ZXh0ID0gc2VsZi5zaXpldmFyLmdldCgpCiAgICAgICAgICAgIGlzX3ZhbGlkLCB3aWR0aCA9IHZhbGlkYXRlX2ltYWdlX3NpemUoc2l6ZV90ZXh0KQogICAgICAgICAgICBpZiBub3QgaXNfdmFsaWQ6CiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcihUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV90aXRsZSIpLCBUKHNlbGYubGFuZywgImludmFsaWRfc2l6ZV9tc2ciKSkKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBEZXRlcm1pbmUgaWYgb3JpZ2luYWwgaW1hZ2VzIHJlcXVlc3RlZAogICAgICAgICAgICBpbWdfb3JpZ2luYWwgPSAod2lkdGggPT0gLTEpICAjIC0xIGluZGljYXRlcyBPUklHSU5BTCBtb2RlCiAgICAgICAgICAgIGlmIG5vdCBpbWdfb3JpZ2luYWw6CiAgICAgICAgICAgICAgICB3aWR0aCA9IGludCh3aWR0aCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgcHJvZ3Jlc3MKICAgICAgICAgICAgc2VsZi51cGRhdGVfcHJvZ3Jlc3NfaW1hZ2VzKDAsIDApCiAgICAgICAgICAgIHNlbGYudXBkYXRlX3Byb2dyZXNzX3ZpZGVvcygwLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTYXZlIHByZWZlcmVuY2VzIGJlZm9yZSBzdGFydGluZwogICAgICAgICAgICBzZWxmLl9zYXZlX3ByZWZlcmVuY2VzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQWRkIGluaXRpYWwgbG9nIG1lc3NhZ2UKICAgICAgICAgICAgc2VsZi5sb2dfaGFuZGxlci5wdXQoIltHVUldIFN0YXJ0aW5nIHByZS1zY2FuLi4uIikKCiAgICAgICAgICAgICMgU3RvcmUgY29udGV4dCBmb3IgYWZ0ZXIgcHJldmlldyBjb25maXJtCiAgICAgICAgICAgIHNlbGYuX3BlbmRpbmdfc3RhcnRfY3R4ID0gewogICAgICAgICAgICAgICAgInVybHMiOiB1cmxzLAogICAgICAgICAgICAgICAgIm91dGRpciI6IG91dGRpciwKICAgICAgICAgICAgICAgICJ3aWR0aCI6IHdpZHRoLAogICAgICAgICAgICAgICAgImltZ19vcmlnaW5hbCI6IGltZ19vcmlnaW5hbCwKICAgICAgICAgICAgICAgICJkb3dubG9hZF92aWRlb3MiOiBzZWxmLnZpZGVvc192YXIuZ2V0KCksCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgRGlzYWJsZSBTdGFydCBhbmQgZW5hYmxlIENhbmNlbCB3aGlsZSBwcmVzY2FuIHJ1bnMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5zdGFydF9idG4uY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIpCiAgICAgICAgICAgICAgICBzZWxmLmNhbmNlbF9idG4uY29uZmlndXJlKHN0YXRlPSJub3JtYWwiKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAgICAgIyBDcmVhdGUgcHJlc2NhbiB3aW5kb3cgaW1tZWRpYXRlbHkgd2l0aCBsb2FkaW5nIHN0YXRlCiAgICAgICAgICAgIHNlbGYuY3JlYXRlX3ByZXNjYW5fd2luZG93KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3RhcnQgcHJlc2NhbiB3b3JrZXIgdGhyZWFkCiAgICAgICAgICAgIHN0YXJ0X3dvcmtlcl90aHJlYWQoCiAgICAgICAgICAgICAgICBydW5fcHJlc2NhbiwKICAgICAgICAgICAgICAgIHVybHMsIG91dGRpciwgc2VsZi5sb2dfaGFuZGxlciwKICAgICAgICAgICAgICAgIHdpZHRoLCBzZWxmLnZpZGVvc192YXIuZ2V0KCksIGltZ19vcmlnaW5hbCwKICAgICAgICAgICAgICAgIHNlbGYsIHNlbGYubGFuZwogICAgICAgICAgICApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBpbXBvcnQgdHJhY2ViYWNrCiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiRXJyb3Igc3RhcnRpbmcgZG93bmxvYWQ6IHtlfVxue3RyYWNlYmFjay5mb3JtYXRfZXhjKCl9IgogICAgICAgICAgICBzZWxmLmxvZ19oYW5kbGVyLnB1dChlcnJvcl9tc2cpCiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2Vycm9yKCJTdGFydCBFcnJvciIsIHN0cihlKSkKICAgIAogICAgZGVmIHN0YXJ0X2NvbnZlcnRlcihzZWxmKToKICAgICAgICAiIiJTdGFydCB0aGUgdGh1bWJuYWlsIGNvbnZlcnRlciBwcm9jZXNzLiIiIgogICAgICAgIGxvY2FsX2RpciA9IHNlbGYuY29udl9kaXJfdmFyLmdldCgpLnN0cmlwKCkKICAgICAgICBpZiBub3QgbG9jYWxfZGlyOgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigKICAgICAgICAgICAgICAgIFQoc2VsZi5sYW5nLCAibWlzc2luZ19jb252X2Rpcl90aXRsZSIpLCAKICAgICAgICAgICAgICAgIFQoc2VsZi5sYW5nLCAibWlzc2luZ19jb252X2Rpcl9tc2ciKQogICAgICAgICAgICApCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgUmVzZXQgcHJvZ3Jlc3MKICAgICAgICBzZWxmLnVwZGF0ZV9wcm9ncmVzc19pbWFnZXMoMCwgMCkKICAgICAgICBzZWxmLnVwZGF0ZV9wcm9ncmVzc192aWRlb3MoMCwgMCkKICAgICAgICAKICAgICAgICAjIFN0YXJ0IGNvbnZlcnRlciB3b3JrZXIKICAgICAgICBzdGFydF93b3JrZXJfdGhyZWFkKAogICAgICAgICAgICBydW5fY29udmVydGVyLAogICAgICAgICAgICBsb2NhbF9kaXIsIHNlbGYubG9nX2hhbmRsZXIsIHNlbGYuY29udl9zdGFydF9idG4sIHNlbGYsIHNlbGYubGFuZwogICAgICAgICkKICAgIAogICAgZGVmIGNhbmNlbChzZWxmKToKICAgICAgICAiIiJDYW5jZWwgY3VycmVudCBvcGVyYXRpb24uIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZXRhdHRyKGRmciwgIklOVEVSUlVQVEVEIiwgVHJ1ZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBzaWduX2luKHNlbGYpOgogICAgICAgICIiIkhhbmRsZSBzaWduIGluL291dC4iIiIKICAgICAgICAjIFRoaXMgd2lsbCB0cmlnZ2VyIE9BdXRoIGZsb3cKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlcnZpY2UsIGNyZWRzID0gZGZyLmdldF9zZXJ2aWNlX2FuZF9jcmVkcyhkZnIuVE9LRU5fRklMRSwgZGZyLkNSRURFTlRJQUxTX0ZJTEUpCiAgICAgICAgICAgIGFjY291bnQgPSBkZnIuZ2V0X2FjY291bnRfaW5mbyhzZXJ2aWNlKQogICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiZW1haWwiKToKICAgICAgICAgICAgICAgIHNlbGYuc2V0X2FjY291bnQoYWNjb3VudC5nZXQoIm5hbWUiLCAiIiksIGFjY291bnRbImVtYWlsIl0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiU2lnbiBJbiBFcnJvciIsIGYiRmFpbGVkIHRvIHNpZ24gaW46IHtlfSIpCiAgICAKICAgIGRlZiBzaWduX291dChzZWxmKToKICAgICAgICAiIiJTaWduIG91dCBhbmQgY2xlYXIgdG9rZW4uIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgb3MKICAgICAgICAgICAgZnJvbSBwYXRobGliIGltcG9ydCBQYXRoCiAgICAgICAgICAgIHRva2VuX3BhdGggPSBQYXRoKGRmci5UT0tFTl9GSUxFKQogICAgICAgICAgICBpZiB0b2tlbl9wYXRoLmV4aXN0cygpOgogICAgICAgICAgICAgICAgYmFja3VwX3BhdGggPSB0b2tlbl9wYXRoLndpdGhfc3VmZml4KHRva2VuX3BhdGguc3VmZml4ICsgIi5iYWsiKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIGJhY2t1cF9wYXRoLmV4aXN0cygpOgogICAgICAgICAgICAgICAgICAgICAgICBiYWNrdXBfcGF0aC51bmxpbmsoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICB0b2tlbl9wYXRoLnJlbmFtZShiYWNrdXBfcGF0aCkKICAgICAgICAgICAgc2VsZi5zZXRfYWNjb3VudCgiIiwgIiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiU2lnbiBPdXQgRXJyb3IiLCBmIkZhaWxlZCB0byBzaWduIG91dDoge2V9IikKICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X2FzeW5jKHNlbGYpOgogICAgICAgICIiIkNoZWNrIGFjY291bnQgc3RhdHVzIGluIGJhY2tncm91bmQgdGhyZWFkLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IGRmci50cnlfZ2V0X2FjY291bnRfaW5mbyhkZnIuVE9LRU5fRklMRSwgZGZyLkNSRURFTlRJQUxTX0ZJTEUpCiAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJlbWFpbCIpOgogICAgICAgICAgICAgICAgc2VsZi5hZnRlcigwLCBsYW1iZGE6IHNlbGYuc2V0X2FjY291bnQoYWNjb3VudC5nZXQoIm5hbWUiLCAiIiksIGFjY291bnRbImVtYWlsIl0pKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MgICMgU2lsZW50IGZhaWwgZm9yIGJhY2tncm91bmQgY2hlY2sKICAgIAogICAgIyBQcm9ncmVzcyB1cGRhdGVzCiAgICBkZWYgc2V0X2FjY291bnQoc2VsZiwgbmFtZTogc3RyLCBlbWFpbDogc3RyKToKICAgICAgICAiIiJVcGRhdGUgYWNjb3VudCBkaXNwbGF5LiIiIgogICAgICAgIGlmIGVtYWlsOgogICAgICAgICAgICBpZiBuYW1lOgogICAgICAgICAgICAgICAgc2VsZi5hY2N0X3Zhci5zZXQoZiJBY2NvdW50OiB7bmFtZX0gPHtlbWFpbH0+IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuYWNjdF92YXIuc2V0KGYiQWNjb3VudDoge2VtYWlsfSIpCiAgICAgICAgICAgIHNlbGYuYXV0aF9idG4uY29uZmlndXJlKHRleHQ9IlNpZ24gb3V0IiwgY29tbWFuZD1zZWxmLnNpZ25fb3V0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuYWNjdF92YXIuc2V0KCJBY2NvdW50OiAobm90IHNpZ25lZCBpbikiKQogICAgICAgICAgICBzZWxmLmF1dGhfYnRuLmNvbmZpZ3VyZSh0ZXh0PSJTaWduIGluIiwgY29tbWFuZD1zZWxmLnNpZ25faW4pCiAgICAKICAgIGRlZiB1cGRhdGVfcHJvZ3Jlc3NfaW1hZ2VzKHNlbGYsIGRvbmU6IGludCwgdG90YWw6IGludCk6CiAgICAgICAgIiIiVXBkYXRlIGltYWdlIHByb2dyZXNzIGJhci4iIiIKICAgICAgICB0b3RhbCA9IG1heCh0b3RhbCwgMCkKICAgICAgICBkb25lID0gbWluKG1heChkb25lLCAwKSwgdG90YWwpIGlmIHRvdGFsIGVsc2UgMAogICAgICAgIAogICAgICAgIHNlbGYucHJvZ3Jlc3NfaW1hZ2VzWyJtYXhpbXVtIl0gPSB0b3RhbCBpZiB0b3RhbCBlbHNlIDEKICAgICAgICBzZWxmLnByb2dyZXNzX2ltYWdlc1sidmFsdWUiXSA9IGRvbmUKICAgICAgICAKICAgICAgICBwcm9ncmVzc190ZXh0ID0gZiJ7ZG9uZX0ve3RvdGFsfSAoe1Qoc2VsZi5sYW5nLCAncHJvZ3Jlc3NfbGVmdCcpfSB7bWF4KHRvdGFsLWRvbmUsIDApfSkiCiAgICAgICAgc2VsZi5wcm9ncmVzc19pbWFnZXNfdmFsdWUuY29uZmlndXJlKHRleHQ9cHJvZ3Jlc3NfdGV4dCkKICAgICAgICBzZWxmLnVwZGF0ZV9pZGxldGFza3MoKQogICAgCiAgICBkZWYgdXBkYXRlX3Byb2dyZXNzX3ZpZGVvcyhzZWxmLCBkb25lOiBpbnQsIHRvdGFsOiBpbnQpOgogICAgICAgICIiIlVwZGF0ZSB2aWRlbyBwcm9ncmVzcyBiYXIuIiIiCiAgICAgICAgdG90YWwgPSBtYXgodG90YWwsIDApCiAgICAgICAgZG9uZSA9IG1pbihtYXgoZG9uZSwgMCksIHRvdGFsKSBpZiB0b3RhbCBlbHNlIDAKICAgICAgICAKICAgICAgICBzZWxmLnByb2dyZXNzX3ZpZGVvc1sibWF4aW11bSJdID0gdG90YWwgaWYgdG90YWwgZWxzZSAxCiAgICAgICAgc2VsZi5wcm9ncmVzc192aWRlb3NbInZhbHVlIl0gPSBkb25lCiAgICAgICAgCiAgICAgICAgcHJvZ3Jlc3NfdGV4dCA9IGYie2RvbmV9L3t0b3RhbH0gKHtUKHNlbGYubGFuZywgJ3Byb2dyZXNzX2xlZnQnKX0ge21heCh0b3RhbC1kb25lLCAwKX0pIgogICAgICAgIHNlbGYucHJvZ3Jlc3NfdmlkZW9zX3ZhbHVlLmNvbmZpZ3VyZSh0ZXh0PXByb2dyZXNzX3RleHQpCiAgICAgICAgc2VsZi51cGRhdGVfaWRsZXRhc2tzKCkKICAgIAogICAgZGVmIHVwZGF0ZV9wcm9ncmVzc19ieXRlcyhzZWxmLCBieXRlc193cml0dGVuOiBpbnQpOgogICAgICAgICIiIlVwZGF0ZSBieXRlcyBwcm9ncmVzcyAoaWYgaW1wbGVtZW50ZWQgaW4gVUkpLiIiIgogICAgICAgIHNlbGYuYnl0ZXNfd3JpdHRlbiA9IG1heCgwLCBieXRlc193cml0dGVuKQogICAgICAgICMgQ291bGQgYWRkIGEgYnl0ZXMgcHJvZ3Jlc3MgYmFyIGhlcmUgaWYgbmVlZGVkCgogICAgIyBQcmUtc2NhbiBwcmV2aWV3IGRpYWxvZwogICAgZGVmIGNyZWF0ZV9wcmVzY2FuX3dpbmRvdyhzZWxmKToKICAgICAgICAiIiJDcmVhdGUgYW5kIHNob3cgcHJlc2NhbiB3aW5kb3cgaW1tZWRpYXRlbHkgd2l0aCBsb2FkaW5nIHN0YXRlLiIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDbG9zZSBhbnkgZXhpc3RpbmcgcHJldmlldyB3aW5kb3cKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX3ByZXNjYW5fd2luIikgYW5kIHNlbGYuX3ByZXNjYW5fd2luIGFuZCB0ay5Ub3BsZXZlbC53aW5mb19leGlzdHMoc2VsZi5fcHJlc2Nhbl93aW4pOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fd2luLmRlc3Ryb3koKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBzZWxmLl9wcmVzY2FuX3Rhc2tzID0gW10KICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFscyA9IHsiaW1hZ2VzIjogMCwgInZpZGVvcyI6IDAsICJkYXRhIjogMCwgImhhdmVfaW1hZ2VzIjogMCwgImhhdmVfdmlkZW9zIjogMCwgImhhdmVfZGF0YSI6IDB9CiAgICAgICAgc2VsZi5fcHJlc2Nhbl90b3RhbF9ieXRlcyA9IDAKICAgICAgICBzZWxmLl9wcmVzY2FuX2xvYWRpbmdfZG90cyA9IDAKCiAgICAgICAgd2luID0gdGsuVG9wbGV2ZWwoc2VsZikKICAgICAgICBzZWxmLl9wcmVzY2FuX3dpbiA9IHdpbgogICAgICAgIHRyeToKICAgICAgICAgICAgd2luLnRpdGxlKFQoc2VsZi5sYW5nLCAicHJlc2Nhbl90aXRsZSIpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHdpbi50aXRsZSgiUHJlLVNjYW4gUHJldmlldyIpCiAgICAgICAgd2luLmdlb21ldHJ5KCI4MjB4NTIwIikKICAgICAgICB3aW4ubWluc2l6ZSg2ODAsIDQyMCkKICAgICAgICB3aW4udHJhbnNpZW50KHNlbGYpCiAgICAgICAgd2luLmdyYWJfc2V0KCkKCiAgICAgICAgIyBEZXNjcmlwdGlvbgogICAgICAgIGRlc2MgPSB0dGsuTGFiZWwod2luLCB0ZXh0PVQoc2VsZi5sYW5nLCAicHJlc2Nhbl9kZXNjIiksIHdyYXBsZW5ndGg9NzgwLCBqdXN0aWZ5PSJsZWZ0IikKICAgICAgICBkZXNjLnBhY2soYW5jaG9yPSJ3IiwgcGFkeD0xMiwgcGFkeT0oMTIsIDYpKQoKICAgICAgICAjIFRyZWV2aWV3IGZvciBwZXItbGluayBjb3VudHMKICAgICAgICBjb2xzID0gKCJyb290IiwgImltYWdlcyIsICJ2aWRlb3MiLCAiZGF0YSIpCiAgICAgICAgdHJlZSA9IHR0ay5UcmVldmlldyh3aW4sIGNvbHVtbnM9Y29scywgc2hvdz0iaGVhZGluZ3MiLCBoZWlnaHQ9MTIpCiAgICAgICAgdHJlZS5oZWFkaW5nKCJyb290IiwgdGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fY29sX3Jvb3QiKSkKICAgICAgICB0cmVlLmhlYWRpbmcoImltYWdlcyIsIHRleHQ9VChzZWxmLmxhbmcsICJwcmVzY2FuX2NvbF9pbWFnZXMiKSkKICAgICAgICB0cmVlLmhlYWRpbmcoInZpZGVvcyIsIHRleHQ9VChzZWxmLmxhbmcsICJwcmVzY2FuX2NvbF92aWRlb3MiKSkKICAgICAgICB0cmVlLmhlYWRpbmcoImRhdGEiLCB0ZXh0PVQoc2VsZi5sYW5nLCAicHJlc2Nhbl9jb2xfZGF0YSIpKQogICAgICAgIHRyZWUuY29sdW1uKCJyb290Iiwgd2lkdGg9MzIwLCBhbmNob3I9InciKQogICAgICAgIHRyZWUuY29sdW1uKCJpbWFnZXMiLCB3aWR0aD0xNDAsIGFuY2hvcj0iY2VudGVyIikKICAgICAgICB0cmVlLmNvbHVtbigidmlkZW9zIiwgd2lkdGg9MTQwLCBhbmNob3I9ImNlbnRlciIpCiAgICAgICAgdHJlZS5jb2x1bW4oImRhdGEiLCB3aWR0aD0xNDAsIGFuY2hvcj0iY2VudGVyIikKICAgICAgICB0cmVlLnBhY2soZmlsbD0iYm90aCIsIGV4cGFuZD1UcnVlLCBwYWR4PTEyLCBwYWR5PSgwLCA2KSkKICAgICAgICAKICAgICAgICBzZWxmLl9wcmVzY2FuX3RyZWUgPSB0cmVlCgogICAgICAgICMgVG90YWxzIGxpbmUgKGluaXRpYWxseSBlbXB0eSkKICAgICAgICB0b3RhbHNfbGFiZWwgPSB0dGsuTGFiZWwod2luLCB0ZXh0PSIiLCBqdXN0aWZ5PSJsZWZ0IikKICAgICAgICB0b3RhbHNfbGFiZWwucGFjayhhbmNob3I9InciLCBwYWR4PTEyLCBwYWR5PSg0LCA0KSkKICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFsc19sYWJlbCA9IHRvdGFsc19sYWJlbAogICAgICAgIAogICAgICAgICMgTG9hZGluZyBhbmltYXRpb24gZm9vdGVyCiAgICAgICAgbG9hZGluZ19sYWJlbCA9IHR0ay5MYWJlbCh3aW4sIHRleHQ9VChzZWxmLmxhbmcsICJwcmVzY2FuX3NjYW5uaW5nIiksIGp1c3RpZnk9ImNlbnRlciIpCiAgICAgICAgbG9hZGluZ19sYWJlbC5wYWNrKGFuY2hvcj0iY2VudGVyIiwgcGFkeD0xMiwgcGFkeT0oMCwgMTApKQogICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZ19sYWJlbCA9IGxvYWRpbmdfbGFiZWwKICAgICAgICBzZWxmLl9hbmltYXRlX3ByZXNjYW5fbG9hZGluZygpCgogICAgICAgICMgQnV0dG9ucwogICAgICAgIGJ0bl9yb3cgPSB0dGsuRnJhbWUod2luKQogICAgICAgIGJ0bl9yb3cucGFjayhmaWxsPSJ4IiwgcGFkeD0xMiwgcGFkeT0oMCwgMTIpKQoKICAgICAgICBkZWYgb25fY2FuY2VsKCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZyA9IEZhbHNlICAjIFN0b3AgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICB3aW4uZGVzdHJveSgpCiAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAjIFJlLWVuYWJsZSBTdGFydCwgZGlzYWJsZSBDYW5jZWwKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0X2J0bi5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jYW5jZWxfYnRuLmNvbmZpZ3VyZShzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgIGRlZiBvbl9zdGFydCgpOgogICAgICAgICAgICAjIElmIHRoZXJlIGFyZSBubyB0YXNrcywgaW5mb3JtIGFuZCBkbyBub3RoaW5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9wcmVzY2FuX3Rhc2tzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd2luZm8oVChzZWxmLmxhbmcsICJwcmVzY2FuX3RpdGxlIiksIFQoc2VsZi5sYW5nLCAicHJlc2Nhbl9ub25lIikpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIG9uX2NhbmNlbCgpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgIyBTZXQgZGlyZWN0IHRhc2tzIGFuZCBzdGFydCB0aGUgbWFpbiB3b3JrZXIKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaW1wb3J0IGRyaXZlX2ZldGNoX3Jlc2lsaWVudCBhcyBkZnIKICAgICAgICAgICAgICAgIGRmci5zZXRfZGlyZWN0X3Rhc2tzKHNlbGYuX3ByZXNjYW5fdGFza3MpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZyA9IEZhbHNlICAjIFN0b3AgYW5pbWF0aW9uCiAgICAgICAgICAgICAgICB3aW4uZGVzdHJveSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgU3RhcnQgd29ya2VyIHRocmVhZCAoU3RhcnQgaXMgYWxyZWFkeSBkaXNhYmxlZCkKICAgICAgICAgICAgY3R4ID0gZ2V0YXR0cihzZWxmLCAiX3BlbmRpbmdfc3RhcnRfY3R4Iiwge30pCiAgICAgICAgICAgIHN0YXJ0X3dvcmtlcl90aHJlYWQoCiAgICAgICAgICAgICAgICBydW5fd29ya2VyLAogICAgICAgICAgICAgICAgY3R4LmdldCgidXJscyIpLCBjdHguZ2V0KCJvdXRkaXIiKSwgc2VsZi5sb2dfaGFuZGxlciwgc2VsZi5zdGFydF9idG4sCiAgICAgICAgICAgICAgICBjdHguZ2V0KCJ3aWR0aCIpLCBzZWxmLl9wZW5kaW5nX3N0YXJ0X2N0eC5nZXQoImRvd25sb2FkX3ZpZGVvcyIsIFRydWUpLCBjdHguZ2V0KCJpbWdfb3JpZ2luYWwiKSwKICAgICAgICAgICAgICAgIHNlbGYsIHNlbGYubGFuZwogICAgICAgICAgICApCgogICAgICAgIGNhbmNlbF9idXR0b24gPSB0dGsuQnV0dG9uKGJ0bl9yb3csIHRleHQ9VChzZWxmLmxhbmcsICJwcmVzY2FuX2J0bl9jYW5jZWwiKSwgY29tbWFuZD1vbl9jYW5jZWwpCiAgICAgICAgY2FuY2VsX2J1dHRvbi5wYWNrKHNpZGU9ImxlZnQiKQogICAgICAgIHN0YXJ0X2J1dHRvbiA9IHR0ay5CdXR0b24oYnRuX3JvdywgdGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fYnRuX3N0YXJ0IiksIGNvbW1hbmQ9b25fc3RhcnQpCiAgICAgICAgc3RhcnRfYnV0dG9uLnBhY2soc2lkZT0icmlnaHQiKQogICAgICAgIHN0YXJ0X2J1dHRvbi5jb25maWd1cmUoc3RhdGU9ImRpc2FibGVkIikgICMgRGlzYWJsZWQgdW50aWwgcHJlc2NhbiBjb21wbGV0ZXMKICAgICAgICBzZWxmLl9wcmVzY2FuX3N0YXJ0X2J1dHRvbiA9IHN0YXJ0X2J1dHRvbgogICAgICAgIAogICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZyA9IFRydWUKICAgIAogICAgZGVmIF9hbmltYXRlX3ByZXNjYW5fbG9hZGluZyhzZWxmKToKICAgICAgICAiIiJBbmltYXRlIGxvYWRpbmcgZG90cyBpbiBwcmVzY2FuIHdpbmRvdy4iIiIKICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAiX3ByZXNjYW5fbG9hZGluZyIpIG9yIG5vdCBzZWxmLl9wcmVzY2FuX2xvYWRpbmc6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICJfcHJlc2Nhbl93aW4iKSBvciBub3Qgc2VsZi5fcHJlc2Nhbl93aW4gb3Igbm90IHRrLlRvcGxldmVsLndpbmZvX2V4aXN0cyhzZWxmLl9wcmVzY2FuX3dpbik6CiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZyA9IEZhbHNlCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgZG90cyA9ICIuIiAqIChzZWxmLl9wcmVzY2FuX2xvYWRpbmdfZG90cyAlIDQpCiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZ19sYWJlbC5jb25maWd1cmUodGV4dD1UKHNlbGYubGFuZywgInByZXNjYW5fc2Nhbm5pbmciKSArIGRvdHMpCiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZ19kb3RzICs9IDEKICAgICAgICAgICAgc2VsZi5hZnRlcig1MDAsIHNlbGYuX2FuaW1hdGVfcHJlc2Nhbl9sb2FkaW5nKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fbG9hZGluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBhZGRfcHJlc2Nhbl9mb2xkZXIoc2VsZiwgc3VtbWFyeSk6CiAgICAgICAgIiIiQWRkIGEgZm9sZGVyIHRvIHRoZSBwcmVzY2FuIHRyZWUgYXMgaXQgY29tcGxldGVzLiIiIgogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICJfcHJlc2Nhbl90cmVlIikgb3Igbm90IHNlbGYuX3ByZXNjYW5fdHJlZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICByb290X25hbWUgPSBzdW1tYXJ5LmdldCgicm9vdF9uYW1lIikgb3Igc3VtbWFyeS5nZXQoInVybCIpIG9yICIobGluaykiCiAgICAgICAgICAgIGltZ3MgPSBmIntzdW1tYXJ5LmdldCgnaW1hZ2VzJywwKX0gKCIgKyBUKHNlbGYubGFuZywgInByZXNjYW5faGF2ZV9mbXQiLCBuPXN1bW1hcnkuZ2V0KCdpbWFnZXNfZXhpc3RpbmcnLDApKSArICIpIgogICAgICAgICAgICB2aWRzID0gZiJ7c3VtbWFyeS5nZXQoJ3ZpZGVvcycsMCl9ICgiICsgVChzZWxmLmxhbmcsICJwcmVzY2FuX2hhdmVfZm10Iiwgbj1zdW1tYXJ5LmdldCgndmlkZW9zX2V4aXN0aW5nJywwKSkgKyAiKSIKICAgICAgICAgICAgZGF0YSA9IGYie3N1bW1hcnkuZ2V0KCdkYXRhJywwKX0gKCIgKyBUKHNlbGYubGFuZywgInByZXNjYW5faGF2ZV9mbXQiLCBuPXN1bW1hcnkuZ2V0KCdkYXRhX2V4aXN0aW5nJywwKSkgKyAiKSIKICAgICAgICAgICAgc2VsZi5fcHJlc2Nhbl90cmVlLmluc2VydCgiIiwgImVuZCIsIHZhbHVlcz0ocm9vdF9uYW1lLCBpbWdzLCB2aWRzLCBkYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVXBkYXRlIHJ1bm5pbmcgdG90YWxzCiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fdG90YWxzWyJpbWFnZXMiXSArPSBzdW1tYXJ5LmdldCgnaW1hZ2VzJywgMCkKICAgICAgICAgICAgc2VsZi5fcHJlc2Nhbl90b3RhbHNbInZpZGVvcyJdICs9IHN1bW1hcnkuZ2V0KCd2aWRlb3MnLCAwKQogICAgICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFsc1siZGF0YSJdICs9IHN1bW1hcnkuZ2V0KCdkYXRhJywgMCkKICAgICAgICAgICAgc2VsZi5fcHJlc2Nhbl90b3RhbHNbImhhdmVfaW1hZ2VzIl0gKz0gc3VtbWFyeS5nZXQoJ2ltYWdlc19leGlzdGluZycsIDApCiAgICAgICAgICAgIHNlbGYuX3ByZXNjYW5fdG90YWxzWyJoYXZlX3ZpZGVvcyJdICs9IHN1bW1hcnkuZ2V0KCd2aWRlb3NfZXhpc3RpbmcnLCAwKQogICAgICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFsc1siaGF2ZV9kYXRhIl0gKz0gc3VtbWFyeS5nZXQoJ2RhdGFfZXhpc3RpbmcnLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX3ByZXNjYW5fdG90YWxzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBfdXBkYXRlX3ByZXNjYW5fdG90YWxzKHNlbGYpOgogICAgICAgICIiIlVwZGF0ZSB0aGUgdG90YWxzIGxhYmVsIGluIHByZXNjYW4gd2luZG93LiIiIgogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICJfcHJlc2Nhbl90b3RhbHNfbGFiZWwiKSBvciBub3Qgc2VsZi5fcHJlc2Nhbl90b3RhbHNfbGFiZWw6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGRyaXZlX2ZldGNoX3Jlc2lsaWVudCBhcyBkZnIKICAgICAgICAgICAgYnl0ZXNfdGV4dCA9IGRmci5odW1hbl9ieXRlcyhpbnQoc2VsZi5fcHJlc2Nhbl90b3RhbF9ieXRlcyBvciAwKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBieXRlc190ZXh0ID0gZiJ7aW50KHNlbGYuX3ByZXNjYW5fdG90YWxfYnl0ZXMgb3IgMCl9IEIiCiAgICAgICAgCiAgICAgICAgdG90YWxzID0gc2VsZi5fcHJlc2Nhbl90b3RhbHMKICAgICAgICB0b3RhbHNfdGV4dCA9ICgKICAgICAgICAgICAgZiJ7VChzZWxmLmxhbmcsICdwcmVzY2FuX3RvdGFscycpfTogIgogICAgICAgICAgICBmIntUKHNlbGYubGFuZywnaW1hZ2VzJyl9PXt0b3RhbHMuZ2V0KCdpbWFnZXMnLDApfSAoIiArIFQoc2VsZi5sYW5nLCdwcmVzY2FuX2hhdmVfZm10Jywgbj10b3RhbHMuZ2V0KCdoYXZlX2ltYWdlcycsMCkpICsgIikgfCAiCiAgICAgICAgICAgIGYie1Qoc2VsZi5sYW5nLCd2aWRlb3MnKX09e3RvdGFscy5nZXQoJ3ZpZGVvcycsMCl9ICgiICsgVChzZWxmLmxhbmcsJ3ByZXNjYW5faGF2ZV9mbXQnLCBuPXRvdGFscy5nZXQoJ2hhdmVfdmlkZW9zJywwKSkgKyAiKSB8ICIKICAgICAgICAgICAgZiJ7VChzZWxmLmxhbmcsJ2RhdGEnKX09e3RvdGFscy5nZXQoJ2RhdGEnLDApfSAoIiArIFQoc2VsZi5sYW5nLCdwcmVzY2FuX2hhdmVfZm10Jywgbj10b3RhbHMuZ2V0KCdoYXZlX2RhdGEnLDApKSArICIpXG4iCiAgICAgICAgICAgIGYie1Qoc2VsZi5sYW5nLCAncHJlc2Nhbl9ieXRlc190b3RhbCcpfToge2J5dGVzX3RleHR9IgogICAgICAgICkKICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFsc19sYWJlbC5jb25maWd1cmUodGV4dD10b3RhbHNfdGV4dCkKICAgIAogICAgZGVmIGZpbmlzaF9wcmVzY2FuKHNlbGYsIHRhc2tzLCB0b3RhbF9ieXRlcyk6CiAgICAgICAgIiIiQ2FsbGVkIHdoZW4gcHJlc2NhbiBjb21wbGV0ZXMuIEVuYWJsZSB0aGUgc3RhcnQgYnV0dG9uIGFuZCBoaWRlIGxvYWRpbmcuIiIiCiAgICAgICAgc2VsZi5fcHJlc2Nhbl9sb2FkaW5nID0gRmFsc2UKICAgICAgICBzZWxmLl9wcmVzY2FuX3Rhc2tzID0gbGlzdCh0YXNrcyBvciBbXSkKICAgICAgICBzZWxmLl9wcmVzY2FuX3RvdGFsX2J5dGVzID0gdG90YWxfYnl0ZXMKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgSGlkZSBsb2FkaW5nIGxhYmVsCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9wcmVzY2FuX2xvYWRpbmdfbGFiZWwiKSBhbmQgc2VsZi5fcHJlc2Nhbl9sb2FkaW5nX2xhYmVsOgogICAgICAgICAgICAgICAgc2VsZi5fcHJlc2Nhbl9sb2FkaW5nX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PSIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgdG90YWxzIG9uZSBmaW5hbCB0aW1lCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9wcmVzY2FuX3RvdGFscygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEVuYWJsZSBzdGFydCBidXR0b24KICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX3ByZXNjYW5fc3RhcnRfYnV0dG9uIikgYW5kIHNlbGYuX3ByZXNjYW5fc3RhcnRfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5fcHJlc2Nhbl9zdGFydF9idXR0b24uY29uZmlndXJlKHN0YXRlPSJub3JtYWwiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKAAAAAAAAAABcjQAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAA1TsAAAAAAADVOwAAAAAAAAAAAAAAAPC/"
				]
			]
		},
		{
			"contents": "# Modularization Summary\n\nThis document summarizes the modularization work completed on the ontahood-downloader project.\n\n## Overview\n\nThe project has been successfully modularized to improve code organization, maintainability, and readability. The work included:\n\n1. **GUI Modularization**: Broke down the monolithic `drive_fetch_gui.py` into a modular `gui/` package\n2. **Backend Integration**: Updated the GUI to work with the existing `dfr/` modular backend package  \n3. **Entry Point Modernization**: Created new entry points and updated build scripts\n4. **Documentation Updates**: Updated all references to use new entry points\n5. **Cleanup**: Removed redundant files while preserving backups\n\n## New Structure\n\n### GUI Package (`gui/`)\n- `__init__.py` - Package initialization\n- `main_app.py` - Main application class and UI logic\n- `components.py` - Reusable UI components and widgets\n- `workers.py` - Background worker functions for downloads and conversion\n- `preferences.py` - User preference management\n- `i18n.py` - Internationalization support (English/Indonesian)\n- `config.py` - Configuration constants and settings\n- `utils.py` - GUI utility functions\n- `log_handler.py` - Custom logging handler for GUI integration\n\n### Backend Package (`dfr/`)\nThe existing modular backend package remains unchanged:\n- `main.py` - Main orchestration logic\n- `auth.py` - Authentication and OAuth handling\n- `utils.py` - Utility functions and helpers\n- `downloads.py` - File download logic\n- `listing.py` - Drive folder listing and scanning\n- `prescan.py` - Pre-scan operations\n- `process.py` - File processing logic\n- `logfmt.py` - Logging formatting\n\n### Entry Points\n- **GUI**: `gui_main.py` - New modular GUI entry point (replaces `drive_fetch_gui.py`)\n- **CLI**: `drive_fetch_resilient.py` - Backend CLI interface (unchanged functionality)\n\n## Key Improvements\n\n### Code Organization\n- **Separation of Concerns**: GUI components are cleanly separated from business logic\n- **Modularity**: Each module has a specific, focused responsibility\n- **Reusability**: Components can be easily reused and tested independently\n- **Maintainability**: Smaller, focused files are easier to understand and modify\n\n### Architecture Benefits\n- **Clean Dependencies**: Clear separation between GUI, backend, and utility code\n- **Testability**: Modular structure makes unit testing much easier\n- **Extensibility**: New features can be added without touching unrelated code\n- **Documentation**: Each module is self-contained with clear interfaces\n\n### User Experience\n- **Unchanged Functionality**: All existing features work exactly the same\n- **Same Interface**: Users see the same bilingual GUI with identical functionality\n- **Performance**: No performance impact from modularization\n- **Stability**: Extensive testing ensures reliability\n\n## Migration Details\n\n### What Changed\n- **Entry Point**: Use `python3 gui_main.py` instead of `python3 drive_fetch_gui.py`\n- **Build Script**: Updated `pre-commit.sh` to package the new GUI entry point\n- **Documentation**: Updated `WARP.md` to reflect new entry points\n\n### What Stayed the Same\n- **All GUI functionality** - downloads, conversion, progress tracking, logging\n- **All CLI functionality** - headless operation, scripting interface\n- **All configuration** - same settings, credentials, output formats\n- **All dependencies** - same `requirements.txt`\n\n### Backup Files\nOriginal files preserved as backups:\n- `drive_fetch_gui.py.backup` - Original monolithic GUI\n- `odl.backup/` - Unused alternative backend package\n\n## Testing Results\n\n **GUI Launch**: New modular GUI starts without errors\n **Import Tests**: All modules import cleanly  \n **Functionality**: Download and conversion features work correctly\n **Logging**: Progress tracking and error handling work as expected\n **Bilingual Support**: English/Indonesian language switching works\n **CLI Compatibility**: Backend CLI interface unchanged\n\n## Future Improvements\n\nThe modular structure now enables:\n- **Unit Testing**: Individual modules can be tested in isolation\n- **Feature Extensions**: New GUI features can be added cleanly\n- **Alternative UIs**: Different frontend interfaces could reuse the backend\n- **Code Quality**: Linting and formatting can be applied more effectively\n- **Documentation**: Auto-generated API documentation from module docstrings\n\n## Files Modified\n\n### Updated Files\n- `WARP.md` - Updated entry points and commands\n- `pre-commit.sh` - Updated PyInstaller to use new GUI entry point\n- `gui/workers.py` - Updated to use modular dfr backend\n\n### New Files  \n- `gui_main.py` - New modular GUI entry point\n- `gui/` package - Complete modular GUI implementation\n- `MODULARIZATION_SUMMARY.md` - This documentation  \n\n## Conclusion\n\nThe modularization has been completed successfully with:\n-  **Zero functional regression** - everything works exactly as before  \n-  **Improved code organization** - clean, maintainable structure\n-  **Enhanced developer experience** - easier to understand and modify\n-  **Future-proof architecture** - ready for additional features and improvements\n\nThe project now has a modern, maintainable codebase while preserving all existing functionality and user workflows.\n",
			"file": "MODULARIZATION_SUMMARY.md",
			"file_size": 5250,
			"file_write_time": 134038511746911927,
			"settings":
			{
				"buffer_size": 5232,
				"encoding": "UTF-8",
				"line_ending": "Unix"
			},
			"undo_stack":
			[
				[
					5,
					2,
					"left_delete",
					null,
					"AgAAAIkSAAAAAAAAiRIAAAAAAAB6AAAAIyMjIEJhY2t1cCBGaWxlcwotIGBkcml2ZV9mZXRjaF9ndWkucHkuYmFja3VwYCAtIE9yaWdpbmFsIEdVSSBwcmVzZXJ2ZWQKLSBgb2RsLmJhY2t1cC9gIC0gVW51c2VkIGJhY2tlbmQgcGFja2FnZSBwcmVzZXJ2ZWSIEgAAAAAAAIgSAAAAAAAAAQAAAAo",
					"AQAAAAAAAAABAAAAAxMAAAAAAACJEgAAAAAAAAAAAAAAAPC/"
				],
				[
					6,
					1,
					"left_delete",
					null,
					"AQAAAIcSAAAAAAAAhxIAAAAAAAABAAAACg",
					"AQAAAAAAAAABAAAAiBIAAAAAAACIEgAAAAAAAAAAAAAAAPC/"
				],
				[
					8,
					1,
					"ensure_newline_at_eof",
					null,
					"AQAAAG0UAAAAAAAAbhQAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAAhxIAAAAAAACHEgAAAAAAAAAAAAAAAPC/"
				],
				[
					9,
					1,
					"insert",
					{
						"characters": "\t"
					},
					"AQAAAIcSAAAAAAAAiRIAAAAAAAAAAAAA",
					"AQAAAAAAAAABAAAAhxIAAAAAAACHEgAAAAAAAAAAAAAAAPC/"
				]
			]
		}
	],
	"build_system": "",
	"build_system_choices":
	[
	],
	"build_varint": "",
	"command_palette":
	{
		"height": 0.0,
		"last_filter": "",
		"selected_items":
		[
			[
				"install",
				"Package Control: Install Package"
			],
			[
				"pret",
				"Pretty JSON: Format JSON"
			],
			[
				"pretty ",
				"Pretty JSON: Format JSON"
			],
			[
				"json",
				"Set Syntax: JSON"
			]
		],
		"width": 0.0
	},
	"console":
	{
		"height": 0.0,
		"history":
		[
		]
	},
	"distraction_free":
	{
		"menu_visible": true,
		"show_minimap": false,
		"show_open_files": false,
		"show_tabs": false,
		"side_bar_visible": false,
		"status_bar_visible": false
	},
	"expanded_folders":
	[
		"/Users/danielyakobian/Developer/ontahood-downloader",
		"/Users/danielyakobian/Developer/ontahood-downloader/dfr",
		"/Users/danielyakobian/Developer/ontahood-downloader/gui"
	],
	"file_history":
	[
		"/Users/danielyakobian/Developer/trailsight-web/docker-compose.dev.yml",
		"/Users/danielyakobian/Developer/trailsight-web/package.json",
		"/Users/danielyakobian/Developer/trailsight-web/server.js",
		"/Users/danielyakobian/Developer/trailsight-web/index.html",
		"/Users/danielyakobian/Developer/ontahood-downloader/temp.py",
		"/Users/danielyakobian/Developer/ontahood-downloader/.envrc",
		"/Users/danielyakobian/.zshrc",
		"/Users/danielyakobian/Developer/ontahood-downloader/drive_fetch_resilient.py",
		"/Users/danielyakobian/Developer/ontahood-downloader/drive_fetch_gui.py",
		"/Users/danielyakobian/Developer/ontahooddownloader/terms.html",
		"/Users/danielyakobian/Developer/ontahooddownloader/index.html",
		"/Users/danielyakobian/Developer/ontahooddownloader/README.md",
		"/Users/danielyakobian/Developer/ontahooddownloader/privacy.html",
		"/Users/danielyakobian/Developer/drive-gui/drive_fetch_gui.py",
		"/Users/danielyakobian/Developer/drive-gui/pre-commit.sh",
		"/Users/danielyakobian/Developer/scripts/scan_media_metadata.py",
		"/Users/danielyakobian/Developer/drive-gui/.git/hooks/pre-commit",
		"/Users/danielyakobian/Developer/drive-gui/README.md",
		"/Users/danielyakobian/Developer/drive-gui/drive_fetch_resilient.py",
		"/Users/danielyakobian/Developer/scripts/wifi_reconnect.sh",
		"/Users/danielyakobian/Developer/scripts/drive/drive_lowres_fetch.py",
		"/Users/danielyakobian/Developer/scripts/run_untrunc_on_broken.sh",
		"/Users/danielyakobian/Developer/scripts/reencode_preserve_fps.sh",
		"/Users/danielyakobian/Developer/scripts/#!:usr:bin:env bash.sh",
		"/Users/danielyakobian/Developer/scripts/batch_cfr_vtb.sh",
		"/Users/danielyakobian/Desktop/triage.sh",
		"/Users/danielyakobian/Desktop/triage_photorec.sh",
		"/Users/danielyakobian/Downloads/Daniel_Yakobian_Resume_UPDATED.tex",
		"/Users/danielyakobian/Downloads/test.txt",
		"/Users/danielyakobian/Downloads/keys.dmp",
		"/Users/danielyakobian/Movies/CapCut/User Data/Projects/com.lveditor.draft/root_meta_info.json",
		"/Users/danielyakobian/Movies/CapCut/User Data/Projects/com.lveditor.draft/template.json"
	],
	"find":
	{
		"height": 38.0
	},
	"find_in_files":
	{
		"height": 98.0,
		"where_history":
		[
		]
	},
	"find_state":
	{
		"case_sensitive": false,
		"find_history":
		[
		],
		"highlight": true,
		"in_selection": false,
		"preserve_case": false,
		"regex": false,
		"replace_history":
		[
		],
		"reverse": false,
		"scrollbar_highlights": true,
		"show_context": true,
		"use_buffer2": true,
		"use_gitignore": true,
		"whole_word": false,
		"wrap": true
	},
	"groups":
	[
		{
			"sheets":
			[
				{
					"buffer": 0,
					"file": "drive_fetch_resilient.py",
					"semi_transient": false,
					"settings":
					{
						"buffer_size": 5757,
						"regions":
						{
						},
						"selection":
						[
							[
								0,
								0
							]
						],
						"settings":
						{
							"syntax": "Packages/Python/Python.sublime-syntax",
							"tab_size": 4,
							"translate_tabs_to_spaces": true
						},
						"translation.x": 0.0,
						"translation.y": 3079.0,
						"zoom_level": 1.0
					},
					"stack_index": 2,
					"stack_multiselect": false,
					"type": "text"
				},
				{
					"buffer": 1,
					"file": "gui/main_app.py",
					"semi_transient": false,
					"settings":
					{
						"buffer_size": 36188,
						"regions":
						{
						},
						"selection":
						[
							[
								15317,
								15317
							]
						],
						"settings":
						{
							"syntax": "Packages/Python/Python.sublime-syntax",
							"tab_size": 4,
							"translate_tabs_to_spaces": true
						},
						"translation.x": 0.0,
						"translation.y": 9460.0,
						"zoom_level": 1.0
					},
					"stack_index": 1,
					"stack_multiselect": false,
					"type": "text"
				},
				{
					"buffer": 2,
					"file": "MODULARIZATION_SUMMARY.md",
					"selected": true,
					"semi_transient": false,
					"settings":
					{
						"buffer_size": 5232,
						"regions":
						{
						},
						"selection":
						[
							[
								4745,
								4745
							]
						],
						"settings":
						{
							"syntax": "Packages/Markdown/Markdown.sublime-syntax"
						},
						"translation.x": 0.0,
						"translation.y": 1869.0,
						"zoom_level": 1.0
					},
					"stack_index": 0,
					"stack_multiselect": false,
					"type": "text"
				}
			]
		}
	],
	"incremental_find":
	{
		"height": 31.0
	},
	"input":
	{
		"height": 0.0
	},
	"layout":
	{
		"cells":
		[
			[
				0,
				0,
				1,
				1
			]
		],
		"cols":
		[
			0.0,
			1.0
		],
		"rows":
		[
			0.0,
			1.0
		]
	},
	"menu_visible": true,
	"output.find_results":
	{
		"height": 0.0,
		"history":
		[
		]
	},
	"pinned_build_system": "",
	"project": "ontahood-downloader.sublime-project",
	"replace":
	{
		"height": 58.0
	},
	"save_all_on_build": true,
	"select_file":
	{
		"height": 0.0,
		"last_filter": "",
		"selected_items":
		[
			[
				"packa",
				"package.json"
			]
		],
		"width": 0.0
	},
	"select_project":
	{
		"height": 0.0,
		"last_filter": "",
		"selected_items":
		[
		],
		"width": 0.0
	},
	"select_symbol":
	{
		"height": 0.0,
		"last_filter": "",
		"selected_items":
		[
		],
		"width": 0.0
	},
	"selected_group": 0,
	"settings":
	{
	},
	"show_minimap": true,
	"show_open_files": false,
	"show_tabs": true,
	"side_bar_visible": true,
	"side_bar_width": 488.0,
	"status_bar_visible": true,
	"template_settings":
	{
	}
}
